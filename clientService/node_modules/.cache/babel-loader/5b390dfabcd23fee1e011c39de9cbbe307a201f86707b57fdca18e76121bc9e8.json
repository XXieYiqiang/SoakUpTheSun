{"ast":null,"code":"// vue-codemirror 相关，官网地址：https://github.com/surmon-china/vue-codemirror\nimport { codemirror } from 'vue-codemirror';\nimport 'codemirror/lib/codemirror.css'; // codemirror 样式\nimport './theme.js'; //  codemirror 高亮代码主题\nimport './mode.js'; // codemirror 的解析语言模式\nimport './fold.js'; //  codemirror 的代码折叠功能相关\nimport { fontSizeList, fileSuffixCodeModeMap, codeMirrorThemeList } from '@/libs/map.js';\n// 文件修改相关\nimport store from '@/store/index.js';\nimport { getFilePreview, modifyFileContent, getFilePreviewKnowledge } from '@/api/file.js';\nexport default {\n  name: 'ImgPreview',\n  components: {\n    codemirror\n  },\n  data() {\n    return {\n      fontSizeList,\n      fileSuffixCodeModeMap,\n      codeMirrorThemeList,\n      visible: false,\n      // 代码预览遮罩层组件是否显示\n      originalCodeText: '',\n      // 代码原本的文本\n      codeMirrorText: '',\n      // 代码实时修改的文本\n      codeMirrorLoading: false,\n      // 代码内容是否加载中\n      // codemirror 配置项，参考 https://codemirror.net/doc/manual.html#config\n      codeMirrorOptions: {\n        tabSize: 4,\n        //  制表符的宽度。默认为 4。\n        mode: 'text/html',\n        //  解析当前代码的模式，参考 https://codemirror.net/mode/ 每种语言的示例页面的底部都有对应的 MIME 类型，如果当前文件后缀没有匹配的语言，按照 html 来解析\n        theme: 'default',\n        //  代码高亮主题色，其他主题色参考 https://codemirror.net/theme/\n        readOnly: true,\n        //  true 只读不可编辑 | false 可编辑 | \"nocursor\"（而不是简单的 true ），不允许编辑器聚焦。\n        lineNumbers: true,\n        //  是否在编辑器左侧显示行号\n        line: true,\n        autoCloseBrackets: true,\n        //  自动补全括号\n        foldGutter: true,\n        //  创建带有指示可折叠块的标记的装订线\n        lineWrapping: true,\n        //  长行处理：false 滚动 | true 换行\n        // 额外的装订线\n        gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter', 'CodeMirror-lint-markers']\n      },\n      isShow: true,\n      //  codemirror 是否展示\n      // codemirror 自定义配置项\n      codeMirrorCustomOptions: {\n        fontSize: 14\n      }\n    };\n  },\n  computed: {\n    // 屏幕宽度\n    screenWidth() {\n      return store.state.common.screenWidth;\n    },\n    // 是否修改\n    isModify() {\n      return this.originalCodeText !== this.codeMirrorText;\n    }\n  },\n  watch: {\n    // 监听代码查看组件 显隐状态变化\n    visible(val) {\n      if (val) {\n        // codemirror 解析模式设置\n        let fileSuffix = this.fileInfo.extendName.toLowerCase();\n        if (fileSuffix === 'yaml') {\n          fileSuffix = 'yml';\n        }\n        if (this.fileSuffixCodeModeMap.has(fileSuffix)) {\n          this.codeMirrorOptions.mode = this.fileSuffixCodeModeMap.get(fileSuffix).mime;\n        }\n        this.codeMirrorOptions.readOnly = !this.isEdit; //  设置编辑器是否只读\n        // codemirror 主题获取\n        this.codeMirrorOptions.theme = localStorage.getItem('qiwen_file_codemirror_theme') || 'default';\n        this.getCodeText();\n        // 添加键盘 Esc 事件\n        this.$nextTick(() => {\n          document.addEventListener('keyup', e => {\n            if (e.keyCode === 27) {\n              this.closeCodePreview();\n            }\n          });\n        });\n      } else {\n        document.removeEventListener('keyup', e => {\n          if (e.keyCode === 27) {\n            this.closeCodePreview();\n          }\n        });\n      }\n    },\n    // 监听主题变化\n    'codeMirrorOptions.theme'(val) {\n      localStorage.setItem('qiwen_file_codemirror_theme', val);\n    }\n  },\n  methods: {\n    /**\r\n     * 获取代码文本内容\r\n     */\n    getCodeText() {\n      console.log('获取代码文本内容');\n      if (this.fileInfo.sourceType === undefined || this.fileInfo.sourceType === '' || this.fileInfo.sourceType === null) {\n        this.fileInfo.sourceType = '0';\n      }\n      if (this.fileInfo.sourceType === '1') {\n        //兼容知识库文件预览\n        const param = {\n          ...this.fileInfo\n        };\n        getFilePreviewKnowledge(param).then(res => {\n          this.codeMirrorLoading = false;\n          this.originalCodeText = typeof res.data === 'object' ? JSON.stringify(res.data) : res.data;\n          this.codeMirrorText = this.originalCodeText + '';\n        });\n      } else {\n        this.codeMirrorLoading = true;\n        getFilePreview({\n          userFileId: this.fileInfo.userFileId,\n          isMin: false,\n          shareBatchNum: this.fileInfo.shareBatchNum,\n          extractionCode: this.fileInfo.extractionCode,\n          token: this.$common.getCookies(this.$config.tokenKeyName)\n        }).then(res => {\n          this.codeMirrorLoading = false;\n          this.originalCodeText = typeof res.data === 'object' ? JSON.stringify(res.data) : res.data;\n          this.codeMirrorText = this.originalCodeText + '';\n        });\n      }\n    },\n    /**\r\n     * 修改代码文本内容\r\n     */\n    handleModifyFileContent() {\n      // 如果没有修改，或当前为只读状态\n      if (!this.isModify || this.codeMirrorOptions.readOnly) {\n        return false;\n      }\n      this.codeMirrorLoading = true;\n      modifyFileContent({\n        userFileId: this.fileInfo.userFileId,\n        fileContent: this.codeMirrorText\n      }).then(res => {\n        this.codeMirrorLoading = false;\n        console.log('res====handleModifyFileContent\t');\n        console.log(res);\n        if (res.data.code === 200) {\n          this.$message.success('已保存');\n          this.getCodeText();\n        } else {\n          this.$message.error(res.message);\n        }\n      }).catch(err => {\n        this.codeMirrorLoading = false;\n        this.$message.error(err.message);\n      });\n    },\n    /**\r\n     * codemirror 配置项改变时触发\r\n     */\n    handleChangeCodeMirrorOption() {\n      this.isShow = false;\n      this.isShow = true;\n    },\n    /**\r\n     * 关闭代码预览\r\n     */\n    closeCodePreview() {\n      this.visible = false;\n      this.callback('cancel');\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}