{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\nrequire(\"core-js/modules/es.iterator.constructor.js\");\nrequire(\"core-js/modules/es.iterator.filter.js\");\nrequire(\"core-js/modules/es.iterator.for-each.js\");\nvar _default = exports.default = {\n  name: 'WebRTCView',\n  data() {\n    return {\n      // ================= WebRTC (SFU Ê®°Âºè) =================\n      upPC: null,\n      // ‰∏äË°å PeerConnection (ÂèëÂ∏É/Êé®ÊµÅ)\n      downPC: null,\n      // ‰∏ãË°å PeerConnection (ËÆ¢ÈòÖ/ÊãâÊµÅ)\n      localStream: null,\n      // Êú¨Âú∞Â™í‰ΩìÊµÅ\n\n      // ================= WebSocket ‰ø°‰ª§ =================\n      ws: null,\n      userId: '',\n      // ÂΩìÂâçÁî®Êà∑ ID\n      roomID: 'VnWJYC61G72f2Br3G68oYV',\n      // ÊàøÈó¥ ID (‰∏éÊúçÂä°Âô®‰øùÊåÅ‰∏ÄËá¥)\n      isPublisher: false,\n      // Ê†áËÆ∞ÂΩìÂâçÊòØÂê¶Ê≠£Âú®ÂèëÂ∏É‰∏≠\n      onlineUsers: [],\n      // SFU Ê®°Âºè‰∏ãÔºåËøô‰∏™ÂàóË°®ÁöÑ‰ΩúÁî®ÊòØÊòæÁ§∫ÂèëÂ∏ÉËÄÖÔºå‰ΩÜÂú®Ëøô‰∏™ÁÆÄÂçïÁâàÊú¨‰∏≠‰ªÖ‰ΩúÂ±ïÁ§∫\n\n      // ... (ÂÖ∂‰ªñÊï∞ÊçÆ‰øùÊåÅ‰∏çÂèò)\n      iceServers: {\n        iceServers: [{\n          urls: 'stun:stun.l.google.com:19302'\n        } // ÂÖ¨ÂÖ± STUN ÊúçÂä°Âô®\n        ]\n      }\n    };\n  },\n  mounted() {\n    this.userId = Math.random().toString(36).slice(2, 8);\n    this.initSignalWS();\n    this.initMedia(); // ÂÆ¢Êà∑Á´Ø‰∏ÄËøûÊé•Â∞±ÂáÜÂ§áÂ™í‰ΩìÔºå‰ΩÜÂè™ÊúâË∞ÉÁî® startPublish Êó∂ÊâçÂºÄÂßãÂèëÂ∏É\n  },\n  methods: {\n    /* ================= ‰ø°‰ª§ WS & ÊàøÈó¥ÁÆ°ÁêÜ ================= */\n    initSignalWS() {\n      // SFU ÊúçÂä°Âô®ÁöÑËøûÊé•Ë∑ØÂæÑÂ∫îËØ•ÊòØÁªü‰∏ÄÁöÑÔºåÁî±ÊúçÂä°Âô®Âú®ÂÜÖÈÉ®ÁÆ°ÁêÜ roomID Âíå userID\n      this.ws = new WebSocket(`ws://localhost:8080/join?uid=${this.userId}&roomID=${this.roomID}`);\n      this.ws.onopen = () => {\n        console.log('üì° ‰ø°‰ª§ WS Â∑≤ËøûÊé•, userId=', this.userId);\n        // SFU ÊúçÂä°Âô®ÈÄöÂ∏∏‰∏çÈúÄË¶Å \"register\" Ê∂àÊÅØÔºåËøûÊé•ÊàêÂäüÂç≥Ê≥®ÂÜå„ÄÇ\n        // Â¶ÇÊûúÈúÄË¶ÅÔºåÂèØ‰ª•ÂèëÈÄÅ‰∏Ä‰∏™ subscribe Ê∂àÊÅØÊù•Ëé∑ÂèñÁé∞ÊúâÂèëÂ∏ÉËÄÖÁöÑÂàóË°®„ÄÇ\n        this.sendSignal('subscribe', {});\n      };\n      this.ws.onmessage = async e => {\n        const rawMsg = JSON.parse(e.data);\n        console.log('‚¨ÖÔ∏è Êî∂Âà∞ SFU ‰ø°‰ª§:', rawMsg.event, rawMsg.data);\n        await this.handleSignal(rawMsg);\n      };\n      // ... (onerror ‰øùÊåÅ‰∏çÂèò)\n    },\n    // Áªü‰∏ÄÂèëÈÄÅ‰ø°‰ª§Ê∂àÊÅØ (Ê†ºÂºèÊîπ‰∏∫ SFU ÊúçÂä°Âô®Ë¶ÅÊ±ÇÁöÑ {event, data})\n    sendSignal(event, data) {\n      const message = {\n        event: event,\n        data: data\n      };\n      this.ws.send(JSON.stringify(message));\n    },\n    /* ================= Â™í‰Ωì ================= */\n    async initMedia() {\n      if (this.localStream) return;\n      try {\n        this.localStream = await navigator.mediaDevices.getUserMedia({\n          video: true,\n          audio: true\n        });\n        this.$refs.localVideo.srcObject = this.localStream;\n      } catch (error) {\n        console.error(\"Ëé∑ÂèñÂ™í‰ΩìÊµÅÂ§±Ë¥•:\", error);\n      }\n    },\n    /* ================= ÂèëÂ∏ÉËÄÖ (UpPC) ÊµÅÁ®ã ================= */\n    createUpPeerConnection() {\n      if (this.upPC) {\n        this.upPC.close();\n        this.upPC = null;\n      }\n      this.upPC = new RTCPeerConnection(this.iceServers);\n\n      // 1. Â∞ÜÊú¨Âú∞ËΩ®ÈÅìÊ∑ªÂä†Âà∞ UpPC\n      this.localStream.getTracks().forEach(track => {\n        this.upPC.addTrack(track, this.localStream);\n      });\n\n      // 2. ICE candidate ÁîüÊàêÊó∂ÂèëÈÄÅÁªô SFU (up_candidate)\n      this.upPC.onicecandidate = e => {\n        if (e.candidate) {\n          this.sendSignal('up_candidate', {\n            candidate: e.candidate\n          });\n        }\n      };\n\n      // 3. ÁõëÂê¨ËøûÊé•Áä∂ÊÄÅ\n      this.upPC.onconnectionstatechange = () => {\n        console.log(`‚¨ÜÔ∏è UpPC Áä∂ÊÄÅ: ${this.upPC.connectionState}`);\n      };\n    },\n    async startPublish() {\n      if (!this.localStream) {\n        await this.initMedia();\n      }\n      this.createUpPeerConnection();\n\n      // 1. ÂàõÂª∫ offer\n      const offer = await this.upPC.createOffer();\n      await this.upPC.setLocalDescription(offer);\n      console.log('‚û°Ô∏è ÂèëÈÄÅ up_offer (Local SDP):', offer.sdp);\n\n      // 2. ÂèëÈÄÅ up_offer Áªô SFU\n      this.sendSignal('up_offer', {\n        uid: this.userId,\n        sdp: offer.sdp\n      });\n      this.isPublisher = true;\n    },\n    // Áî±‰∫éÊòØ SFU Ê®°ÂºèÔºåP2PÁöÑ startCall/targetId Ê¶ÇÂøµ‰∏çÂÜçÈÄÇÁî®\n    // Êàë‰ª¨Â∞Ü startCall ÊåâÈíÆÊîπ‰∏∫ startPublish \n    startCall() {\n      this.startPublish();\n    },\n    /* ================= ‰ø°‰ª§Â§ÑÁêÜ ================= */\n    async handleSignal(msg) {\n      const event = msg.event;\n      const data = JSON.parse(msg.data); // ÊúçÂä°Âô®ËøîÂõûÁöÑ data Â∑≤ÁªèÊòØ RawMessageÔºåÂÆ¢Êà∑Á´ØÈúÄË¶ÅÂÜçÊ¨°Ëß£Êûê\n\n      switch (event) {\n        // ------------------ ÂèëÂ∏É (Upstream) ------------------\n        case 'up_answer':\n          // SFU ÂõûÂ§çÁöÑ AnswerÔºåËÆæÁΩÆÂà∞ UpPC\n          console.log('‚úÖ Êî∂Âà∞ up_answer');\n          await this.upPC.setRemoteDescription(new RTCSessionDescription({\n            type: 'answer',\n            sdp: data.sdp\n          }));\n          break;\n        case 'up_candidate':\n          // SFU ÂèëÈÄÅÁªôÂÆ¢Êà∑Á´ØÁöÑ ICE candidate\n          if (this.upPC && data.candidate) {\n            await this.upPC.addIceCandidate(data.candidate);\n          }\n          break;\n\n        // ------------------ ËÆ¢ÈòÖ (Downstream) ------------------\n        case 'down_offer':\n          // SFU ÂëäÁü•ÂÆ¢Êà∑Á´ØÊúâÊñ∞ÁöÑÊµÅÈúÄË¶ÅËÆ¢ÈòÖÔºàÈáçÊñ∞ÂçèÂïÜÔºâ\n          await this.handleDownOffer(data);\n          break;\n        case 'down_candidate':\n          // SFU ÂèëÈÄÅÁªôÂÆ¢Êà∑Á´ØÁöÑ ICE candidate\n          if (this.downPC && data.candidate) {\n            await this.downPC.addIceCandidate(data.candidate);\n          }\n          break;\n        case 'publisher_list':\n          // ÊúçÂä°Âô®ÂèØËÉΩÂèëÈÄÅÂΩìÂâçÊàøÈó¥ÂÜÖÊâÄÊúâÂèëÂ∏ÉËÄÖÁöÑÂàóË°® (ÂèØÈÄâ)\n          this.onlineUsers = data.filter(id => id !== this.userId);\n          break;\n        default:\n          console.warn('Êú™Áü• SFU ‰ø°‰ª§‰∫ã‰ª∂:', event);\n      }\n    },\n    /* ================= ËÆ¢ÈòÖËÄÖ (DownPC) ÊµÅÁ®ã ================= */\n    createDownPeerConnection() {\n      if (this.downPC) {\n        // ÁêÜËÆ∫‰∏ä DownPC Âè™ÈúÄË¶ÅÂàõÂª∫‰∏ÄÊ¨°ÔºåÈô§ÈùûËøûÊé•Â§±Ë¥•ÊàñÊåÇÊñ≠\n        // this.downPC.close() \n        // this.downPC = null\n        return; // Â¶ÇÊûúÂ∑≤Â≠òÂú®ÔºåÁõ¥Êé•‰ΩøÁî®\n      }\n      this.downPC = new RTCPeerConnection(this.iceServers);\n\n      // 1. ÁõëÂê¨ËøúÁ´ØÊµÅÔºàÊâÄÊúâÁöÑËÆ¢ÈòÖÊµÅÈÉΩ‰ºöÈÄöËøáËøô‰∏™ÂõûË∞ÉÊî∂Âà∞Ôºâ\n      this.downPC.ontrack = e => {\n        console.log('üéØ Êî∂Âà∞ËøúÁ´ØÊµÅ (DownPC)');\n        // Âú® SFU Ê®°Âºè‰∏ãÔºåÊâÄÊúâËøúÁ´ØÊµÅÈÄöÂ∏∏ÂêàÂπ∂Âà∞‰∏Ä‰∏™ video Ê†áÁ≠æÔºàÂ¶ÇÊûúÂè™Êúâ‰∏Ä‰∏™ËøúÁ´ØÔºâ\n        // ÂÆûÈôÖÂ∫îÁî®‰∏≠ÔºåËøôÈáåÈúÄË¶ÅÊ†πÊçÆ streamId/trackId Êù•Âä®ÊÄÅÂàõÂª∫/Êõ¥Êñ∞ <video> Ê†áÁ≠æ\n        this.$refs.remoteVideo.srcObject = e.streams[0];\n      };\n\n      // 2. ICE candidate ÁîüÊàêÊó∂ÂèëÈÄÅÁªô SFU (down_candidate)\n      this.downPC.onicecandidate = e => {\n        if (e.candidate) {\n          this.sendSignal('down_candidate', {\n            candidate: e.candidate\n          });\n        }\n      };\n\n      // 3. ÁõëÂê¨ËøûÊé•Áä∂ÊÄÅ\n      this.downPC.onconnectionstatechange = () => {\n        console.log(`‚¨áÔ∏è DownPC Áä∂ÊÄÅ: ${this.downPC.connectionState}`);\n      };\n    },\n    async handleDownOffer(payload) {\n      this.createDownPeerConnection();\n\n      // 1. ËÆæÁΩÆ SFU ÂèëÊù•ÁöÑ Offer ‰∏∫ËøúÁ´ØÊèèËø∞\n      await this.downPC.setRemoteDescription(new RTCSessionDescription({\n        type: 'offer',\n        sdp: payload.sdp\n      }));\n\n      // 2. ÂàõÂª∫ Answer\n      const answer = await this.downPC.createAnswer();\n      await this.downPC.setLocalDescription(answer);\n      console.log('‚û°Ô∏è ÂèëÈÄÅ down_answer (Local SDP):', answer.sdp);\n\n      // 3. ÂèëÈÄÅ down_answer Áªô SFU\n      this.sendSignal('down_answer', {\n        sdp: answer.sdp\n      });\n    },\n    /* ================= ÊåÇÊñ≠/Ê∏ÖÁêÜ ================= */\n    hangup() {\n      // ÂÖ≥Èó≠ PeerConnections\n      if (this.upPC) {\n        this.upPC.close();\n        this.upPC = null;\n      }\n      if (this.downPC) {\n        this.downPC.close();\n        this.downPC = null;\n      }\n\n      // ÂÅúÊ≠¢Êú¨Âú∞ÊµÅ\n      if (this.localStream) {\n        this.localStream.getTracks().forEach(t => t.stop());\n        this.localStream = null;\n      }\n\n      // Ê∏ÖÁ©∫ËßÜÈ¢ëÊ†áÁ≠æ\n      this.$refs.localVideo.srcObject = null;\n      this.$refs.remoteVideo.srcObject = null;\n      this.isPublisher = false;\n      console.log('‚òéÔ∏è Â∑≤ÊåÇÊñ≠');\n    }\n    // ... (beforeDestroy ‰øùÊåÅ‰∏çÂèò)\n  }\n};","map":{"version":3,"names":["name","data","upPC","downPC","localStream","ws","userId","roomID","isPublisher","onlineUsers","iceServers","urls","mounted","Math","random","toString","slice","initSignalWS","initMedia","methods","WebSocket","onopen","console","log","sendSignal","onmessage","e","rawMsg","JSON","parse","event","handleSignal","message","send","stringify","navigator","mediaDevices","getUserMedia","video","audio","$refs","localVideo","srcObject","error","createUpPeerConnection","close","RTCPeerConnection","getTracks","forEach","track","addTrack","onicecandidate","candidate","onconnectionstatechange","connectionState","startPublish","offer","createOffer","setLocalDescription","sdp","uid","startCall","msg","setRemoteDescription","RTCSessionDescription","type","addIceCandidate","handleDownOffer","filter","id","warn","createDownPeerConnection","ontrack","remoteVideo","streams","payload","answer","createAnswer","hangup","t","stop"],"sources":["src/views/utils/test2.vue"],"sourcesContent":["<template>\r\n  <div class=\"webrtc-container\">\r\n    <h2>üé• WebRTC Demo</h2>\r\n\r\n    <div class=\"video-box\">\r\n      <div class=\"video-item\">\r\n        <h3>Êú¨Âú∞ËßÜÈ¢ë (ID: {{ userId }})</h3>\r\n        <video ref=\"localVideo\" autoplay muted playsinline></video>\r\n      </div>\r\n      <div class=\"video-item\">\r\n        <h3>ËøúÁ´ØËßÜÈ¢ë</h3>\r\n        <video ref=\"remoteVideo\" autoplay playsinline></video>\r\n      </div>\r\n    </div>\r\n\r\n    <div class=\"actions\">\r\n      <el-input v-model=\"targetId\" placeholder=\"ÂØπÊñπIDÔºà‰ªé‰∏ãÊñπÈÄâÊã©ÊàñÊâãÂä®ËæìÂÖ•Ôºâ\" style=\"width: 250px;\"></el-input>\r\n      <el-button type=\"primary\" :disabled=\"!targetId\" @click=\"startCall\">ÂëºÂè´ {{ targetId }}</el-button>\r\n      <el-button type=\"danger\" @click=\"hangup\">ÊåÇÊñ≠</el-button>\r\n    </div>\r\n\r\n    <div class=\"online-users-box\">\r\n      <h3>üë• Âú®Á∫øÁî®Êà∑ÂàóË°®222</h3>\r\n      <div v-if=\"onlineUsers.length === 0\">ÊöÇÊó†ÂÖ∂‰ªñÁî®Êà∑Âú®Á∫ø</div>\r\n      <ul v-else>\r\n        <li v-for=\"user in onlineUsers\" :key=\"user\" @click=\"setTarget(user)\">\r\n          Áî®Êà∑ ID: **{{ user }}**\r\n          <el-button size=\"mini\" type=\"success\" @click.stop=\"setTarget(user)\">ÂëºÂè´</el-button>\r\n        </li>\r\n      </ul>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nexport default {\r\n    name: 'WebRTCView',\r\n\r\n    data() {\r\n        return {\r\n            // ================= WebRTC (SFU Ê®°Âºè) =================\r\n            upPC: null,          // ‰∏äË°å PeerConnection (ÂèëÂ∏É/Êé®ÊµÅ)\r\n            downPC: null,        // ‰∏ãË°å PeerConnection (ËÆ¢ÈòÖ/ÊãâÊµÅ)\r\n            localStream: null,   // Êú¨Âú∞Â™í‰ΩìÊµÅ\r\n\r\n            // ================= WebSocket ‰ø°‰ª§ =================\r\n            ws: null,\r\n            userId: '',          // ÂΩìÂâçÁî®Êà∑ ID\r\n            roomID: 'VnWJYC61G72f2Br3G68oYV', // ÊàøÈó¥ ID (‰∏éÊúçÂä°Âô®‰øùÊåÅ‰∏ÄËá¥)\r\n            isPublisher: false,  // Ê†áËÆ∞ÂΩìÂâçÊòØÂê¶Ê≠£Âú®ÂèëÂ∏É‰∏≠\r\n            onlineUsers: [],     // SFU Ê®°Âºè‰∏ãÔºåËøô‰∏™ÂàóË°®ÁöÑ‰ΩúÁî®ÊòØÊòæÁ§∫ÂèëÂ∏ÉËÄÖÔºå‰ΩÜÂú®Ëøô‰∏™ÁÆÄÂçïÁâàÊú¨‰∏≠‰ªÖ‰ΩúÂ±ïÁ§∫\r\n\r\n            // ... (ÂÖ∂‰ªñÊï∞ÊçÆ‰øùÊåÅ‰∏çÂèò)\r\n            iceServers: {\r\n                iceServers: [\r\n                    { urls: 'stun:stun.l.google.com:19302' } // ÂÖ¨ÂÖ± STUN ÊúçÂä°Âô®\r\n                ]\r\n            }\r\n        }\r\n    },\r\n\r\n    mounted() {\r\n        this.userId = Math.random().toString(36).slice(2, 8)\r\n        this.initSignalWS()\r\n        this.initMedia() // ÂÆ¢Êà∑Á´Ø‰∏ÄËøûÊé•Â∞±ÂáÜÂ§áÂ™í‰ΩìÔºå‰ΩÜÂè™ÊúâË∞ÉÁî® startPublish Êó∂ÊâçÂºÄÂßãÂèëÂ∏É\r\n    },\r\n\r\n    methods: {\r\n        /* ================= ‰ø°‰ª§ WS & ÊàøÈó¥ÁÆ°ÁêÜ ================= */\r\n        initSignalWS() {\r\n            // SFU ÊúçÂä°Âô®ÁöÑËøûÊé•Ë∑ØÂæÑÂ∫îËØ•ÊòØÁªü‰∏ÄÁöÑÔºåÁî±ÊúçÂä°Âô®Âú®ÂÜÖÈÉ®ÁÆ°ÁêÜ roomID Âíå userID\r\n            this.ws = new WebSocket(`ws://localhost:8080/join?uid=${this.userId}&roomID=${this.roomID}`)\r\n\r\n            this.ws.onopen = () => {\r\n                console.log('üì° ‰ø°‰ª§ WS Â∑≤ËøûÊé•, userId=', this.userId)\r\n                // SFU ÊúçÂä°Âô®ÈÄöÂ∏∏‰∏çÈúÄË¶Å \"register\" Ê∂àÊÅØÔºåËøûÊé•ÊàêÂäüÂç≥Ê≥®ÂÜå„ÄÇ\r\n                // Â¶ÇÊûúÈúÄË¶ÅÔºåÂèØ‰ª•ÂèëÈÄÅ‰∏Ä‰∏™ subscribe Ê∂àÊÅØÊù•Ëé∑ÂèñÁé∞ÊúâÂèëÂ∏ÉËÄÖÁöÑÂàóË°®„ÄÇ\r\n                this.sendSignal('subscribe', {}) \r\n            }\r\n\r\n            this.ws.onmessage = async e => {\r\n                const rawMsg = JSON.parse(e.data)\r\n                console.log('‚¨ÖÔ∏è Êî∂Âà∞ SFU ‰ø°‰ª§:', rawMsg.event, rawMsg.data)\r\n                await this.handleSignal(rawMsg)\r\n            }\r\n            // ... (onerror ‰øùÊåÅ‰∏çÂèò)\r\n        },\r\n\r\n        // Áªü‰∏ÄÂèëÈÄÅ‰ø°‰ª§Ê∂àÊÅØ (Ê†ºÂºèÊîπ‰∏∫ SFU ÊúçÂä°Âô®Ë¶ÅÊ±ÇÁöÑ {event, data})\r\n        sendSignal(event, data) {\r\n            const message = {\r\n                event: event,\r\n                data: data\r\n            }\r\n            this.ws.send(JSON.stringify(message))\r\n        },\r\n\r\n        /* ================= Â™í‰Ωì ================= */\r\n        async initMedia() {\r\n            if (this.localStream) return\r\n            try {\r\n                this.localStream = await navigator.mediaDevices.getUserMedia({\r\n                    video: true,\r\n                    audio: true\r\n                })\r\n                this.$refs.localVideo.srcObject = this.localStream\r\n            } catch (error) {\r\n                console.error(\"Ëé∑ÂèñÂ™í‰ΩìÊµÅÂ§±Ë¥•:\", error)\r\n            }\r\n        },\r\n\r\n        /* ================= ÂèëÂ∏ÉËÄÖ (UpPC) ÊµÅÁ®ã ================= */\r\n        createUpPeerConnection() {\r\n            if (this.upPC) {\r\n                this.upPC.close()\r\n                this.upPC = null\r\n            }\r\n            this.upPC = new RTCPeerConnection(this.iceServers)\r\n\r\n            // 1. Â∞ÜÊú¨Âú∞ËΩ®ÈÅìÊ∑ªÂä†Âà∞ UpPC\r\n            this.localStream.getTracks().forEach(track => {\r\n                this.upPC.addTrack(track, this.localStream)\r\n            })\r\n\r\n            // 2. ICE candidate ÁîüÊàêÊó∂ÂèëÈÄÅÁªô SFU (up_candidate)\r\n            this.upPC.onicecandidate = e => {\r\n                if (e.candidate) {\r\n                    this.sendSignal('up_candidate', { candidate: e.candidate })\r\n                }\r\n            }\r\n\r\n            // 3. ÁõëÂê¨ËøûÊé•Áä∂ÊÄÅ\r\n            this.upPC.onconnectionstatechange = () => {\r\n                console.log(`‚¨ÜÔ∏è UpPC Áä∂ÊÄÅ: ${this.upPC.connectionState}`)\r\n            }\r\n        },\r\n\r\n        async startPublish() {\r\n            if (!this.localStream) {\r\n                await this.initMedia()\r\n            }\r\n            this.createUpPeerConnection() \r\n            \r\n            // 1. ÂàõÂª∫ offer\r\n            const offer = await this.upPC.createOffer()\r\n            await this.upPC.setLocalDescription(offer)\r\n\r\n            console.log('‚û°Ô∏è ÂèëÈÄÅ up_offer (Local SDP):', offer.sdp)\r\n\r\n            // 2. ÂèëÈÄÅ up_offer Áªô SFU\r\n            this.sendSignal('up_offer', { uid: this.userId, sdp: offer.sdp })\r\n            this.isPublisher = true\r\n        },\r\n        \r\n        // Áî±‰∫éÊòØ SFU Ê®°ÂºèÔºåP2PÁöÑ startCall/targetId Ê¶ÇÂøµ‰∏çÂÜçÈÄÇÁî®\r\n        // Êàë‰ª¨Â∞Ü startCall ÊåâÈíÆÊîπ‰∏∫ startPublish \r\n        startCall() { \r\n            this.startPublish() \r\n        },\r\n\r\n        /* ================= ‰ø°‰ª§Â§ÑÁêÜ ================= */\r\n        async handleSignal(msg) {\r\n            const event = msg.event\r\n            const data = JSON.parse(msg.data) // ÊúçÂä°Âô®ËøîÂõûÁöÑ data Â∑≤ÁªèÊòØ RawMessageÔºåÂÆ¢Êà∑Á´ØÈúÄË¶ÅÂÜçÊ¨°Ëß£Êûê\r\n\r\n            switch (event) {\r\n                // ------------------ ÂèëÂ∏É (Upstream) ------------------\r\n                case 'up_answer':\r\n                    // SFU ÂõûÂ§çÁöÑ AnswerÔºåËÆæÁΩÆÂà∞ UpPC\r\n                    console.log('‚úÖ Êî∂Âà∞ up_answer')\r\n                    await this.upPC.setRemoteDescription(new RTCSessionDescription({\r\n                        type: 'answer',\r\n                        sdp: data.sdp\r\n                    }))\r\n                    break\r\n\r\n                case 'up_candidate':\r\n                    // SFU ÂèëÈÄÅÁªôÂÆ¢Êà∑Á´ØÁöÑ ICE candidate\r\n                    if (this.upPC && data.candidate) {\r\n                        await this.upPC.addIceCandidate(data.candidate)\r\n                    }\r\n                    break\r\n                \r\n                // ------------------ ËÆ¢ÈòÖ (Downstream) ------------------\r\n                case 'down_offer':\r\n                    // SFU ÂëäÁü•ÂÆ¢Êà∑Á´ØÊúâÊñ∞ÁöÑÊµÅÈúÄË¶ÅËÆ¢ÈòÖÔºàÈáçÊñ∞ÂçèÂïÜÔºâ\r\n                    await this.handleDownOffer(data)\r\n                    break\r\n\r\n                case 'down_candidate':\r\n                    // SFU ÂèëÈÄÅÁªôÂÆ¢Êà∑Á´ØÁöÑ ICE candidate\r\n                    if (this.downPC && data.candidate) {\r\n                        await this.downPC.addIceCandidate(data.candidate)\r\n                    }\r\n                    break\r\n\r\n                case 'publisher_list':\r\n                    // ÊúçÂä°Âô®ÂèØËÉΩÂèëÈÄÅÂΩìÂâçÊàøÈó¥ÂÜÖÊâÄÊúâÂèëÂ∏ÉËÄÖÁöÑÂàóË°® (ÂèØÈÄâ)\r\n                    this.onlineUsers = data.filter(id => id !== this.userId)\r\n                    break\r\n                \r\n                default:\r\n                    console.warn('Êú™Áü• SFU ‰ø°‰ª§‰∫ã‰ª∂:', event)\r\n            }\r\n        },\r\n\r\n        /* ================= ËÆ¢ÈòÖËÄÖ (DownPC) ÊµÅÁ®ã ================= */\r\n        createDownPeerConnection() {\r\n            if (this.downPC) {\r\n                // ÁêÜËÆ∫‰∏ä DownPC Âè™ÈúÄË¶ÅÂàõÂª∫‰∏ÄÊ¨°ÔºåÈô§ÈùûËøûÊé•Â§±Ë¥•ÊàñÊåÇÊñ≠\r\n                // this.downPC.close() \r\n                // this.downPC = null\r\n                return // Â¶ÇÊûúÂ∑≤Â≠òÂú®ÔºåÁõ¥Êé•‰ΩøÁî®\r\n            }\r\n            \r\n            this.downPC = new RTCPeerConnection(this.iceServers)\r\n\r\n            // 1. ÁõëÂê¨ËøúÁ´ØÊµÅÔºàÊâÄÊúâÁöÑËÆ¢ÈòÖÊµÅÈÉΩ‰ºöÈÄöËøáËøô‰∏™ÂõûË∞ÉÊî∂Âà∞Ôºâ\r\n            this.downPC.ontrack = e => {\r\n                console.log('üéØ Êî∂Âà∞ËøúÁ´ØÊµÅ (DownPC)')\r\n                // Âú® SFU Ê®°Âºè‰∏ãÔºåÊâÄÊúâËøúÁ´ØÊµÅÈÄöÂ∏∏ÂêàÂπ∂Âà∞‰∏Ä‰∏™ video Ê†áÁ≠æÔºàÂ¶ÇÊûúÂè™Êúâ‰∏Ä‰∏™ËøúÁ´ØÔºâ\r\n                // ÂÆûÈôÖÂ∫îÁî®‰∏≠ÔºåËøôÈáåÈúÄË¶ÅÊ†πÊçÆ streamId/trackId Êù•Âä®ÊÄÅÂàõÂª∫/Êõ¥Êñ∞ <video> Ê†áÁ≠æ\r\n                this.$refs.remoteVideo.srcObject = e.streams[0]\r\n            }\r\n\r\n            // 2. ICE candidate ÁîüÊàêÊó∂ÂèëÈÄÅÁªô SFU (down_candidate)\r\n            this.downPC.onicecandidate = e => {\r\n                if (e.candidate) {\r\n                    this.sendSignal('down_candidate', { candidate: e.candidate })\r\n                }\r\n            }\r\n\r\n            // 3. ÁõëÂê¨ËøûÊé•Áä∂ÊÄÅ\r\n            this.downPC.onconnectionstatechange = () => {\r\n                console.log(`‚¨áÔ∏è DownPC Áä∂ÊÄÅ: ${this.downPC.connectionState}`)\r\n            }\r\n        },\r\n\r\n        async handleDownOffer(payload) {\r\n            this.createDownPeerConnection()\r\n            \r\n            // 1. ËÆæÁΩÆ SFU ÂèëÊù•ÁöÑ Offer ‰∏∫ËøúÁ´ØÊèèËø∞\r\n            await this.downPC.setRemoteDescription(new RTCSessionDescription({\r\n                type: 'offer',\r\n                sdp: payload.sdp\r\n            }))\r\n\r\n            // 2. ÂàõÂª∫ Answer\r\n            const answer = await this.downPC.createAnswer()\r\n            await this.downPC.setLocalDescription(answer)\r\n\r\n            console.log('‚û°Ô∏è ÂèëÈÄÅ down_answer (Local SDP):', answer.sdp)\r\n\r\n            // 3. ÂèëÈÄÅ down_answer Áªô SFU\r\n            this.sendSignal('down_answer', { sdp: answer.sdp })\r\n        },\r\n\r\n        /* ================= ÊåÇÊñ≠/Ê∏ÖÁêÜ ================= */\r\n        hangup() {\r\n            // ÂÖ≥Èó≠ PeerConnections\r\n            if (this.upPC) {\r\n                this.upPC.close()\r\n                this.upPC = null\r\n            }\r\n            if (this.downPC) {\r\n                this.downPC.close()\r\n                this.downPC = null\r\n            }\r\n\r\n            // ÂÅúÊ≠¢Êú¨Âú∞ÊµÅ\r\n            if (this.localStream) {\r\n                this.localStream.getTracks().forEach(t => t.stop())\r\n                this.localStream = null\r\n            }\r\n\r\n            // Ê∏ÖÁ©∫ËßÜÈ¢ëÊ†áÁ≠æ\r\n            this.$refs.localVideo.srcObject = null\r\n            this.$refs.remoteVideo.srcObject = null\r\n            this.isPublisher = false\r\n            console.log('‚òéÔ∏è Â∑≤ÊåÇÊñ≠')\r\n        }\r\n        // ... (beforeDestroy ‰øùÊåÅ‰∏çÂèò)\r\n    }\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n.webrtc-container {\r\n  padding: 20px;\r\n}\r\n.video-box {\r\n  display: flex;\r\n  gap: 20px;\r\n  margin-bottom: 20px;\r\n}\r\n.video-item h3 {\r\n  font-size: 16px;\r\n  margin-bottom: 5px;\r\n}\r\nvideo {\r\n  width: 320px;\r\n  height: 240px;\r\n  background: #222;\r\n  border-radius: 8px;\r\n  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);\r\n}\r\n.actions {\r\n  display: flex;\r\n  gap: 10px;\r\n  margin-bottom: 30px;\r\n}\r\n.online-users-box {\r\n  margin-top: 30px;\r\n  padding: 15px;\r\n  border: 1px solid #ddd;\r\n  border-radius: 8px;\r\n}\r\n.online-users-box ul {\r\n  list-style: none;\r\n  padding: 0;\r\n}\r\n.online-users-box li {\r\n  padding: 8px 0;\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  border-bottom: 1px dashed #f0f0f0;\r\n}\r\n.online-users-box li:hover {\r\n  background-color: #f9f9f9;\r\n  cursor: pointer;\r\n}\r\n</style>"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}