{"ast":null,"code":"import \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.filter.js\";\nimport \"core-js/modules/es.iterator.for-each.js\";\nimport \"core-js/modules/es.iterator.map.js\";\nimport { getFileDetail } from '@/api/file.js';\nimport * as Base64 from 'js-base64';\nexport default {\n  name: 'AudioPreview',\n  data() {\n    return {\n      visible: false,\n      //  音频预览组件是否可见\n      activeIndex: 0,\n      //  当前打开的音频索引\n      activePlayIcon: require('_a/images/audio/wave.gif'),\n      cycleType: 1,\n      //  音频播放的循环模式\n      // 音频循环模式和图标对应的 Map\n      cycleTypeMap: {\n        1: {\n          icon: 'icon-xunhuanbofang',\n          text: '列表循环'\n        },\n        2: {\n          icon: 'icon-danquxunhuan1',\n          text: '单曲循环'\n        },\n        3: {\n          icon: 'icon-suijibofang1',\n          text: '随机播放'\n        }\n      },\n      isPlay: false,\n      //  是否正在播放\n      currentTime: 0,\n      //  当前播放的秒\n      isDrop: false,\n      //  是否正在拖拽播放进度滑块\n      volume: 0,\n      //  音量\n      audioInfo: {},\n      //  音频信息\n      lyricsList: [],\n      //  歌词列表\n      currentLyricsLineIndex: 0 //  当前高亮的歌词行索引，从 0 开始\n    };\n  },\n  computed: {\n    // 当前显示的文件信息\n    activeFileObj() {\n      const res = this.audioList.length ? this.audioList[this.activeIndex] : {};\n      return res;\n    },\n    // 隐藏的 audio 标签\n    audioElement() {\n      return this.$refs.audioRef;\n    },\n    // 歌曲封面\n    musicImgUrl() {\n      return this.audioInfo.albumImage ? `data:image/jpeg;base64,${this.audioInfo.albumImage}` : require('_a/images/file/file_music.png');\n    },\n    // 播放进度条步长\n    progressStep() {\n      return this.audioInfo.duration / 100;\n    }\n  },\n  watch: {\n    // 监听音频预览组件状态\n    visible(newValue) {\n      if (newValue) {\n        this.activeIndex = this.defaultIndex;\n        this.getFileDetailData();\n        // 添加键盘相关事件\n        document.addEventListener('keyup', this.handleAddKeyupEvent);\n      } else {\n        // 移除键盘相关事件\n        document.removeEventListener('keyup', this.handleAddKeyupEvent);\n      }\n    },\n    // 监听当前索引变化\n    activeIndex() {\n      this.getFileDetailData();\n    }\n  },\n  methods: {\n    /**\r\n     * DOM 绑定 Esc 键、左方向键、右方向键的键盘按下事件\r\n     * @param {event} event 事件\r\n     */\n    handleAddKeyupEvent(event) {\n      switch (event.code) {\n        // 关闭预览\n        case 'Escape':\n          {\n            this.handleClosePreview();\n            break;\n          }\n        // 切换到上一个\n        case 'ArrowLeft':\n          {\n            this.handleChangeAudioIndex('pre');\n            break;\n          }\n        // 切换到下一个\n        case 'ArrowRight':\n          {\n            this.handleChangeAudioIndex('next');\n            break;\n          }\n        // 音量调大\n        case 'ArrowUp':\n          {\n            this.volume = this.volume === 1 ? 1 : this.volume + 0.1;\n            this.volume = Number(this.volume.toFixed(1));\n            this.handleChangeVolumeBar(this.volume);\n            break;\n          }\n        // 音量调小\n        case 'ArrowDown':\n          {\n            this.volume = this.volume === 0 ? 0 : this.volume - 0.1;\n            this.volume = Number(this.volume.toFixed(1));\n            this.handleChangeVolumeBar(this.volume);\n            break;\n          }\n        // 暂停/播放\n        case 'Space':\n          {\n            this.handleChangeAudioIndex('manual', this.activeIndex);\n            break;\n          }\n      }\n    },\n    /**\r\n     * 获取文件信息\r\n     */\n    getFileDetailData() {\n      this.handleClickPauseIcon();\n      this.loading = true;\n      getFileDetail({\n        userFileId: this.activeFileObj.userFileId\n      }).then(res => {\n        this.loading = false;\n        if (res.success) {\n          this.audioInfo = {\n            ...res.data.music,\n            duration: res.data.music.trackLength\n          };\n          // Base64 解码为 lrc 格式的歌词文件\n          let lyricsStr = Base64.decode(this.audioInfo.lyrics);\n          if (lyricsStr.includes('[offset:0]')) {\n            // 有歌词，从标志位 [offset:0] 下一行开始截取\n            lyricsStr = lyricsStr.split('[offset:0]\\n')[1];\n          }\n          this.lyricsList = lyricsStr.split('\\n').map(item => {\n            const line = item.split('[')[1].split(']');\n            return {\n              time: line[0],\n              //  当前行歌词开始播放的秒数\n              text: line[1] //  当前歌词文本\n            };\n          }).filter(item => item.text !== '');\n          this.lyricsList = this.lyricsList.map((item, index) => {\n            return {\n              ...item,\n              // 当前行歌词起始秒数\n              startSeconds: this.transferTimeToSeconds(item.time),\n              // 当前行歌词结束秒数\n              endSeconds: index < this.lyricsList.length - 1 ? this.transferTimeToSeconds(this.lyricsList[index + 1].time) : this.audioInfo.duration\n            };\n          });\n          // 当切换完歌曲时，歌词重新滚动到顶部\n          this.$refs.lyricsListRef.scrollTo({\n            top: 0,\n            behavior: 'smooth'\n          });\n          this.currentLyricsLineIndex = 0;\n        }\n      }).catch(() => {\n        this.loading = false;\n      });\n    },\n    /**\r\n     * 获取播放器参数\r\n     */\n    handleLoadedmetadata(event) {\n      const audioDom = event.target;\n      this.volume = audioDom.volume || 0.5;\n      this.currentTime = audioDom.currentTime;\n      this.handleClickPlayIcon();\n    },\n    /**\r\n     * 将秒转化为时分秒\r\n     * @param {number} duration 总秒数\r\n     */\n    transferSecondsToTime(duration) {\n      const hour = Math.floor(duration / 3600);\n      const minutes = Math.floor(duration / 60);\n      const seconds = Math.ceil(duration % 60);\n      return `${hour < 10 ? `0${hour}` : hour}:${minutes < 10 ? `0${minutes}` : minutes}:${seconds < 10 ? `0${seconds}` : seconds}`;\n    },\n    /**\r\n     * 将分秒转化为秒\r\n     * @param {string} time 分秒，格式 00:00\r\n     */\n    transferTimeToSeconds(time) {\n      const timeList = time.split('.')[0].split(':');\n      return Number(timeList[1]) + Number(timeList[0]) * 60;\n    },\n    /**\r\n     * 当前播放时间改变时触发\r\n     */\n    handleTimeUpdate(event) {\n      // 如果正在拖拽进度滑块，函数结束，不计算当前时间\n      if (this.isDrop) return;\n      this.currentTime = event.target.currentTime;\n      if (this.lyricsList.length) {\n        // 遍历歌词，当前秒对应的歌词整行添加高亮效果\n        this.lyricsList.forEach((item, index) => {\n          if (item.startSeconds <= this.currentTime && this.currentTime < item.endSeconds && this.currentLyricsLineIndex !== index) {\n            // 确定高亮歌词行索引\n            this.currentLyricsLineIndex = index;\n            // 使高亮歌词行永远保持在第二行\n            if (this.currentLyricsLineIndex > 2) {\n              // 平滑滚动\n              this.$refs.lyricsListRef.scrollTo({\n                top: this.$refs.lyricsLineRef[index].clientHeight * (index - 2),\n                behavior: 'smooth'\n              });\n            }\n          }\n        });\n      }\n    },\n    /**\r\n     * 拖动播放进度滑块触发\r\n     */\n    handleChangeProgress(progress) {\n      this.audioElement.currentTime = progress;\n      this.isDrop = false;\n    },\n    /**\r\n     * 切换循环播放类型\r\n     */\n    handleChangeCycleType() {\n      if (this.cycleType === 3) {\n        this.cycleType = 1;\n      } else if (this.cycleType >= 1) {\n        this.cycleType++;\n      }\n    },\n    /**\r\n     * 点击播放图标触发\r\n     * @description 开始播放音频\r\n     */\n    handleClickPlayIcon() {\n      this.isPlay = true;\n      this.audioElement.play();\n    },\n    /**\r\n     * 点击暂停图标触发\r\n     * @description 暂停音频\r\n     */\n    handleClickPauseIcon() {\n      this.isPlay = false;\n      this.audioElement.pause();\n    },\n    /**\r\n     * 切换、暂停或播放歌曲\r\n     * @param {string} type pre - 上一首 | next - 下一首 | manual 手动切换\r\n     * @param {number} index 手动切换的音频索引，从 0 开始\r\n     */\n    handleChangeAudioIndex(type, index) {\n      // 如果当前手动切换\n      if (type === 'manual') {\n        if (this.activeIndex === index) {\n          if (this.isPlay) {\n            this.handleClickPauseIcon();\n          } else {\n            this.handleClickPlayIcon();\n          }\n        } else {\n          this.activeIndex = index;\n        }\n      } else {\n        this.handleClickPauseIcon();\n        // 判断当前循环播放类型\n        switch (this.cycleType) {\n          case 3:\n            {\n              let activeIndex = 0;\n              do {\n                activeIndex = Math.floor(Math.random() * (this.audioList.length - 1)) + 1;\n              } while (this.activeIndex === activeIndex);\n              this.activeIndex = activeIndex;\n              break;\n            }\n          default:\n            {\n              if (type === 'pre') {\n                if (this.activeIndex === 0) {\n                  this.activeIndex = this.audioList.length - 1;\n                } else {\n                  this.activeIndex--;\n                }\n              } else if (type === 'next') {\n                if (this.activeIndex === this.audioList.length - 1) {\n                  this.activeIndex = 0;\n                } else {\n                  this.activeIndex++;\n                }\n              }\n              break;\n            }\n        }\n      }\n    },\n    /**\r\n     * 点击音量图标\r\n     */\n    handleClickVolumeIcon() {\n      this.volume = this.volume === 0 ? 0.5 : 0;\n      this.handleChangeVolumeBar(this.volume);\n    },\n    /**\r\n     * 音量滑块改变时触发\r\n     */\n    handleChangeVolumeBar(volume) {\n      this.audioElement.volume = Number(volume.toFixed(1));\n    },\n    // 关闭音频预览\n    handleClosePreview() {\n      this.visible = false;\n      this.callback('cancel');\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}