{"ast":null,"code":"import \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.filter.js\";\nimport \"core-js/modules/es.iterator.find.js\";\nimport \"core-js/modules/es.iterator.reduce.js\";\nimport moment from 'moment';\nexport default {\n  name: 'ChatView',\n  data() {\n    return {\n      sidebarCollapsed: false,\n      // ä¾§è¾¹æ æ˜¯å¦æŠ˜å \n      isMobile: false,\n      // æ˜¯å¦ä¸ºç§»åŠ¨ç«¯\n      search: '',\n      // æœç´¢æ¡†å†…å®¹\n      activeMenu: 'message',\n      // å½“å‰æ¿€æ´»çš„èœå•é¡¹\n      groups: [{\n        group_id: '5',\n        group_name: 'äº§å“å¼€å‘ç»„',\n        group_avatar: 'https://design.gemcoder.com/staticResource/echoAiSystemImages/15bd703716eb575eb049d376ef18625e.png',\n        last_message_time: '10:25',\n        last_message_author: 'èµµå·¥ç¨‹å¸ˆ',\n        last_message: 'åç«¯APIå·²ç»å‡†å¤‡å¥½äº†'\n      }, {\n        group_id: '6',\n        group_name: 'å¸‚åœºéƒ¨',\n        group_avatar: 'https://design.gemcoder.com/staticResource/echoAiSystemImages/2f7e3cc5e3e5a3d0e681096b58281846.png',\n        last_message_time: 'å‘¨äº”',\n        last_message_author: 'æè¥é”€',\n        last_message: 'æ–°æ´»åŠ¨æ–¹æ¡ˆå·²æ›´æ–°'\n      }],\n      // ç¾¤ç»„åˆ—è¡¨\n      currentContactId: '',\n      // å½“å‰é€‰ä¸­çš„è”ç³»äººæˆ–ç¾¤ç»„ID\n      inputMessage: '',\n      //è¾“å…¥æ¡†ä¿¡æ¯\n      isTyping: false //æ˜¯å¦æ­£åœ¨è¾“å…¥\n    };\n  },\n  computed: {\n    isOnline() {\n      return this.$store.getters['user/isLogin'];\n    },\n    // å½“å‰è”ç³»äººåœ¨çº¿çŠ¶æ€\n    statusText() {\n      return this.currentContact?.Status === 'online' ? 'ğŸŸ¢ åœ¨çº¿' : 'ğŸ”´ ç¦»çº¿';\n    },\n    //æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨\n    userList() {\n      return this.$store.getters['message/getUserList'];\n    },\n    // å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯\n    userInfo() {\n      return this.$store.state.user.userInfo || {};\n    },\n    /**\r\n    * æ ¹æ®æœç´¢å†…å®¹ç­›é€‰è”ç³»äºº\r\n    */\n    filteredContacts() {\n      if (!this.search) return this.userList;\n      return this.userList.filter(c => c.UserName.includes(this.search) || c.UserIntroduction.includes(this.search));\n    },\n    /**\r\n    * æ ¹æ®æœç´¢å†…å®¹ç­›é€‰ç¾¤ç»„\r\n    */\n    filteredGroups() {\n      if (!this.search) return this.groups;\n      return this.groups.filter(g => g.group_name.includes(this.search) || g.last_message.includes(this.search));\n    },\n    /**\r\n     * å½“å‰é€‰ä¸­çš„è”ç³»äººæˆ–ç¾¤ç»„å¯¹è±¡\r\n     */\n    currentContact() {\n      return this.userList.find(c => c.UserID === this.currentContactId) || this.groups.find(g => g.group_id === this.currentContactId) || {};\n    },\n    /**\r\n     * å½“å‰è”ç³»äººæˆ–ç¾¤ç»„åç§°\r\n     */\n    currentContactName() {\n      return this.currentContact.UserName || this.currentContact.group_name || '';\n    },\n    /**\r\n     * å½“å‰è”ç³»äººæˆ–ç¾¤ç»„å¤´åƒ\r\n     */\n    currentContactAvatar() {\n      return this.currentContact.AvatarURL || this.currentContact.group_avatar || '';\n    },\n    /**\r\n     * å½“å‰è”ç³»äººåœ¨çº¿çŠ¶æ€\r\n     */\n    currentContactStatus() {\n      return this.currentContact.Status || '';\n    },\n    /**\r\n     * æ‰€æœ‰è”ç³»äººæœªè¯»æ¶ˆæ¯æ€»æ•°\r\n     */\n    unreadTotal() {\n      return this.userList.reduce((sum, c) => sum + (c.unread_count || 0), 0);\n    },\n    // ä»Vuex Store ä¸­è·å–èŠå¤©ä¿¡æ¯\n    messages() {\n      console.log('this.currentContactId===' + this.currentContactId);\n      console.log(\"è·å–èŠå¤©ä¿¡æ¯ï¼š\", this.$store.getters['message/getMessages'](this.currentContactId));\n      return this.$store.getters['message/getMessages'](this.currentContactId);\n    }\n  },\n  methods: {\n    /**\r\n     * åˆ‡æ¢ä¾§è¾¹æ æŠ˜å çŠ¶æ€\r\n     */\n    toggleSidebar() {\n      this.sidebarCollapsed = !this.sidebarCollapsed;\n    },\n    /**\r\n      * æ˜¾ç¤ºä¾§è¾¹æ ï¼ˆç§»åŠ¨ç«¯ï¼‰\r\n      */\n    showSidebar() {\n      this.sidebarCollapsed = false;\n    },\n    /**\r\n      * èœå•é€‰æ‹©äº‹ä»¶å¤„ç†\r\n      * @param {string} index é€‰ä¸­çš„èœå•é¡¹ç´¢å¼•\r\n      */\n    handleMenuSelect(index) {\n      this.activeMenu = index;\n    },\n    /**\r\n      * é€‰æ‹©è”ç³»äººæˆ–ç¾¤ç»„\r\n      * @param {string} id è”ç³»äººæˆ–ç¾¤ç»„ID\r\n      */\n    selectContact(id) {\n      this.currentContactId = id;\n      // TODO: åŠ è½½å¯¹åº”èŠå¤©è®°å½•\n    },\n    /**\r\n     * æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º\r\n     * @param {string} time æ—¶é—´å­—ç¬¦ä¸²\r\n     * @returns {string}\r\n     */\n    formatTime(time) {\n      if (!time) return '';\n      const m = moment(time);\n      if (!m.isValid()) return ''; // é˜²æ­¢éæ³•æ—¶é—´æ ¼å¼\n\n      return m.format('YYYY-MM-DD HH:mm:ss'); // è¿”å›å®Œæ•´æ—¶é—´æ ¼å¼\n    },\n    formatTime2(time) {\n      if (!time) return '';\n      const m = moment(time);\n      if (!m.isValid()) return ''; // é˜²æ­¢éæ³•æ—¶é—´æ ¼å¼\n\n      return m.format('HH:mm:ss'); // è¿”å›å®Œæ•´æ—¶é—´æ ¼å¼\n    },\n    /**\r\n      * è¾“å…¥æ¡†é”®ç›˜äº‹ä»¶å¤„ç†ï¼ˆå›è½¦å‘é€æ¶ˆæ¯ï¼‰\r\n      * @param {KeyboardEvent} e\r\n      */\n    handleInputKeydown(e) {\n      if (e.key === 'Enter' && !e.shiftKey) {\n        e.preventDefault();\n        this.sendMessage();\n      }\n    },\n    /**\r\n     * å‘é€æ¶ˆæ¯\r\n     */\n    sendMessage() {\n      if (!this.inputMessage.trim()) return;\n      console.log('[Chat] ğŸ’¬ å‘é€æ¶ˆæ¯:', this.inputMessage);\n      const content = this.inputMessage.trim();\n      const receiverId = this.currentContactId;\n      const senderId = this.userInfo.userId;\n      const messagePayload = {\n        messageId: 'client-' + Date.now(),\n        // ä¸´æ—¶ IDï¼Œåç»­å¯æœåŠ¡ç«¯å›å¡«\n        senderId: senderId,\n        //å‘é€ç”¨æˆ·ï¼šå…ˆå†™æ­»\n        reciverId: receiverId,\n        content,\n        targetType: 'user',\n        messageType: 'æ–‡æœ¬',\n        sendTime: new Date().toISOString(),\n        readStatus: 'sent'\n      };\n      this.$ws.send({\n        cmd: 100001,\n        data: {\n          messageId: 'client-' + Date.now(),\n          senderId: senderId,\n          reciverId: receiverId,\n          content: content,\n          targetType: 'user',\n          messageType: 'æ–‡æœ¬',\n          sendTime: new Date().toISOString(),\n          readStatus: 'sent'\n        }\n      });\n\n      // 2ï¸âƒ£ åŒæ­¥å†™å…¥ Vuex æ¶ˆæ¯æ¨¡å—ï¼ˆæ³¨æ„å°è£…æ€§ï¼‰\n      // å‘æŸä¸ªä¼šè¯è¿½åŠ ä¸€æ¡æ¶ˆæ¯\n      this.$store.commit('message/ADD_MESSAGE', {\n        contactId: receiverId,\n        message: messagePayload\n      });\n\n      // âœ… é‡ç½®æŒ‡å®šä¼šè¯æœªè¯»æ¶ˆæ¯æ•°ä¸º 0ï¼ˆå·²è¯»ï¼‰\n      this.$store.commit('message/RESET_UNREAD', receiverId);\n      console.log('ç”¨æˆ· ã€111ã€‘æ¶ˆæ¯ä¸ºï¼š===');\n      console.log(this.$store.getters['message/getMessages'](\"111\"));\n      console.log('ç”¨æˆ· ã€222ã€‘æ¶ˆæ¯ä¸ºï¼š===');\n      console.log(this.$store.getters['message/getMessages'](\"222\"));\n\n      //æƒ…å†µè¾“å…¥æ¡†å¹¶æ»šåŠ¨åˆ°åº•éƒ¨\n      this.inputMessage = '';\n      // æ»šåŠ¨åˆ°åº•éƒ¨\n      this.$nextTick(() => {\n        if (this.$refs.chatBody) {\n          this.$refs.chatBody.scrollTop = this.$refs.chatBody.scrollHeight;\n        }\n      });\n    },\n    /**\r\n     * é€€å‡ºç™»å½•\r\n     */\n    logout() {\n      // TODO: é€€å‡ºç™»å½•é€»è¾‘\n\n      this.$store.dispatch('user/logout');\n      this.$message.success('å·²é€€å‡ºç™»å½•');\n    },\n    /**\r\n    * æ ¹æ®çª—å£å¤§å°åˆ¤æ–­æ˜¯å¦ä¸ºç§»åŠ¨ç«¯\r\n    */\n    handleResize() {\n      this.isMobile = true;\n      if (this.isMobile) {\n        this.sidebarCollapsed = true;\n      } else {\n        this.sidebarCollapsed = false;\n      }\n    }\n  },\n  mounted() {\n    /** æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨ */\n    if (this.$ws) {\n      this.$ws.send({\n        cmd: 100003,\n        data: {}\n      });\n    }\n\n    // åˆå§‹åŒ–æ—¶åˆ¤æ–­æ˜¯å¦ä¸ºç§»åŠ¨ç«¯ï¼Œå¹¶ç›‘å¬çª—å£å¤§å°å˜åŒ–\n    this.handleResize();\n    window.addEventListener('resize', this.handleResize);\n    // èŠå¤©åŒºåŸŸæ»šåŠ¨åˆ°åº•éƒ¨\n    this.$nextTick(() => {\n      if (this.$refs.chatBody) {\n        this.$refs.chatBody.scrollTop = this.$refs.chatBody.scrollHeight;\n      }\n    });\n  },\n  beforeDestroy() {\n    // ç§»é™¤çª—å£å¤§å°å˜åŒ–ç›‘å¬\n    window.removeEventListener('resize', this.handleResize);\n  }\n};","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}