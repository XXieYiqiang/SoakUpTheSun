{"ast":null,"code":"import store from '@/store/index.js';\nexport default {\n  name: 'ImgPreview',\n  data() {\n    return {\n      visible: false,\n      //  图片预览遮罩层组件是否显示\n      inputActiveIndex: 1,\n      //  对用户而言 显示的图片索引 从 1 开始 顶部栏输入框控制此值变化\n      rotate: 0,\n      //  旋转角度\n      activeIndex: 0,\n      //  当前图片索引 从 0 开始\n      imgZoom: 100,\n      //  图片缩放比例\n      imgZoomMin: 1,\n      //  图片缩放最小比例\n      imgZoomMax: 200,\n      //  图片缩放最大比例\n      isShowMinImgList: true //  是否显示缩略图列表\n    };\n  },\n  computed: {\n    activeImage() {\n      return this.imgList[this.activeIndex];\n    },\n    activeImageName() {\n      return this.$file.getFileNameComplete(this.activeImage);\n    },\n    imageHeight() {\n      return this.activeImage.imageHeight;\n    },\n    imageWidth() {\n      return this.activeImage.imageWidth;\n    },\n    // 当前显示的图片下载链接\n    activeDownloadLink() {\n      return this.activeImage.downloadLink;\n    },\n    // 屏幕宽度\n    screenWidth() {\n      return store.state.common.screenWidth;\n    }\n  },\n  watch: {\n    // 监听 图片查看组件 显隐状态变化\n    visible(val) {\n      if (val) {\n        this.activeIndex = this.defaultIndex;\n        document.addEventListener('keyup', this.handleAddKeyupEvent); // 添加键盘相关事件\n        // 获取用户是否显示缩略图的操作习惯设置\n        this.isShowMinImgList = localStorage.getItem('qiwen_file_img_preview_show_min') === 'false' ? false : true;\n        this.$nextTick(() => {\n          this.handleCalculateImgZoom(this.activeIndex); // 确定图片缩放比例\n          this.handleScrollMinImg(); // 将当前查看图片对应的缩略图滚动到视野中\n        });\n      } else {\n        // 移除键盘相关事件\n        document.removeEventListener('keyup', this.handleAddKeyupEvent);\n      }\n    },\n    // 监听 图片索引变化\n    activeIndex(newValue) {\n      this.rotate = 0;\n      this.$nextTick(() => {\n        if (this.$refs.imgLarge[newValue].style.zoom) {\n          this.imgZoom = Number(this.$refs.imgLarge[newValue].style.zoom.split('%')[0]);\n        } else {\n          // 确定图片缩放比例\n          this.handleCalculateImgZoom(newValue);\n        }\n      });\n    },\n    // 监听 是否展示缩略图列表，将变化值保存在 localStorage 中\n    isShowMinImgList(val) {\n      localStorage.setItem('qiwen_file_img_preview_show_min', val);\n    }\n  },\n  methods: {\n    /**\r\n     * 顶部栏输入框绑定值被改变时触发\r\n     * @param {number} currentValue 当前值\r\n     */\n    handleChangeInputIndex(currentValue) {\n      this.activeIndex = currentValue - 1;\n      this.handleChangeActiveImg(currentValue - 1);\n    },\n    /**\r\n     * DOM 绑定 Esc 键、左方向键、右方向键的键盘按下事件\r\n     * @param {event} event 事件\r\n     */\n    handleAddKeyupEvent(event) {\n      switch (event.key) {\n        case 'Escape':\n          {\n            this.handleCloseImgPreview(); // 关闭预览\n            break;\n          }\n        case 'ArrowLeft':\n          {\n            this.handleChangeActiveImg(this.activeIndex - 1); // 切换到上一张\n            break;\n          }\n        case 'ArrowRight':\n          {\n            this.handleChangeActiveImg(this.activeIndex + 1); // 切换到下一张\n            break;\n          }\n      }\n    },\n    /**\r\n     * 计算图片缩放比例\r\n     */\n    handleCalculateImgZoom(currentIndex) {\n      // 包裹元素\n      const wrapperDom = document.querySelector('.img-wrapper');\n      // 宽度原比例\n      const widthRate = Number(((wrapperDom.clientWidth - 264) / this.imageWidth).toFixed(2));\n      // 高度原比例\n      const heightRate = Number(((wrapperDom.clientHeight - 80) / this.imageHeight).toFixed(2));\n      let zoomRate = 1; // 缩放比例\n      if (widthRate >= 1 && heightRate >= 1) {\n        // 原图宽、高都小于/等于包裹元素\n        zoomRate = 1;\n      } else if (widthRate >= 1 && heightRate < 1) {\n        // 原图宽小于/等于显示区域，高大于包裹元素\n        zoomRate = heightRate;\n      } else if (widthRate < 1 && heightRate >= 1) {\n        // 原图宽大于显示区域，高小于/等于包裹元素\n        zoomRate = widthRate;\n      } else if (widthRate < 1 && heightRate < 1) {\n        // 原图宽、高都大于包裹元素\n        zoomRate = Math.min(widthRate, heightRate);\n      }\n      this.imgZoom = Number(zoomRate.toFixed(2)) * 100; //  缩放百分比\n      this.$refs.imgLarge[currentIndex].style.zoom = `${this.imgZoom}%`;\n    },\n    /**\r\n     * 关闭图片预览，恢复旋转角度\r\n     */\n    handleCloseImgPreview() {\n      this.rotate = 0;\n      this.$refs.imgLarge[this.activeIndex].style.transform = `rotate(${this.rotate}deg)`;\n      this.visible = false;\n      this.callback('cancel');\n    },\n    /**\r\n     * 格式化 tooltip message - 显示图片缩放比例\r\n     * @param {number} value 缩放数字\r\n     * @returns {string}  图片缩放比例\r\n     */\n    formatZoomSize(value) {\n      return value + '%';\n    },\n    /**\r\n     * 数据改变时触发（使用鼠标拖曳时，活动过程实时触发）\r\n     * @param {number} value 缩放数字\r\n     */\n    handleZoomImg(value) {\n      if (this.$refs.imgLarge) {\n        this.$refs.imgLarge[this.activeIndex].style.zoom = value + '%'; //  实时设置图片缩放比例\n      }\n    },\n    /**\r\n     * 鼠标滚动事件\r\n     * @description 缩放图片\r\n     */\n    handleMouseWheel() {\n      let zoom = parseInt(this.$refs.imgLarge[this.activeIndex].style.zoom) || 100;\n      zoom += event.wheelDelta / 12;\n      if (zoom >= this.imgZoomMin && zoom < this.imgZoomMax) {\n        this.imgZoom = zoom;\n        this.$refs.imgLarge[this.activeIndex].style.zoom = zoom + '%';\n      }\n      return false;\n    },\n    /**\r\n     * 旋转图片\r\n     */\n    handleRotateImg() {\n      this.rotate += 90;\n      this.$refs.imgLarge[this.activeIndex].style.transform = `rotate(${this.rotate}deg)`;\n    },\n    /**\r\n     * 改变当前查看的图片索引\r\n     */\n    handleChangeActiveImg(index) {\n      if (index >= 0 && index < this.imgList.length) {\n        this.activeIndex = index;\n        this.handleScrollMinImg();\n      }\n    },\n    /**\r\n     * 将缩略图中当前查看的图片缩略图滚动到视野中\r\n     */\n    handleScrollMinImg() {\n      const parentEle = this.$refs.minImgListRef; //  包裹缩略图的父元素\n      const activeEle = this.$refs.minImgRef[this.activeIndex]; //  当前缩略图\n      // 当前元素距离可视区域顶部的距离\n      const currentEleTop = activeEle.offsetTop - activeEle.clientHeight;\n      // 当前元素距离可视区域底部的距离\n      const currentEleBottom = parentEle.clientHeight - activeEle.offsetTop;\n      // 如果当前查看的图片缩略图有一部分在可视区域之外（之上或之下）\n      if (currentEleBottom < activeEle.clientHeight || currentEleTop < activeEle.clientHeight) {\n        // 将父元素的滚动条向可视区域方向滚动两个图片的高度\n        parentEle.scrollTop = -currentEleBottom + activeEle.clientHeight * 2;\n      }\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}