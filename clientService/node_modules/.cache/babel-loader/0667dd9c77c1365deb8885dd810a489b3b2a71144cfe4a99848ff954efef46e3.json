{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"C:/Users/Administrator/Desktop/GimChat/gimChatVue/node_modules/@babel/runtime/helpers/interopRequireDefault.js\").default;\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\nvar _store = _interopRequireDefault(require(\"@/store\"));\nvar _user = require(\"@/api/user\");\n/**\r\n * WebSocketService Â∞ÅË£ÖÁ±ª\r\n * - Ëá™Âä®ÈáçËøû\r\n * - ÂøÉË∑≥Êú∫Âà∂\r\n * - Áªü‰∏ÄÊ∂àÊÅØÂàÜÂèëÂà∞ Vuex\r\n */\n\n// Ë∑ØÂæÑÊ†πÊçÆ‰Ω†ÁöÑÈ°πÁõÆË∞ÉÊï¥\n\nclass WebSocketService {\n  constructor(store) {\n    this.store = store;\n    this.socket = null;\n    this.userId = null;\n    this.reconnectInterval = 5000;\n    this.heartbeatInterval = 30000;\n    this.heartbeatTimer = null;\n  }\n\n  /**\r\n   * Âª∫Á´ã WebSocket ËøûÊé•\r\n   * @param {string} userId ÂΩìÂâçÁôªÂΩïÁî®Êà∑ ID\r\n   */\n  connect(userId) {\n    this.userId = userId;\n    const url = `ws://127.0.0.1:8888/ws?userId=${encodeURIComponent(userId)}`;\n    console.log(`[WebSocket][ËøûÊé•] Ê≠£Âú®ËøûÊé• userId=${userId} Âú∞ÂùÄ: ${url}`);\n    this.socket = new WebSocket(url);\n    this.socket.onopen = () => {\n      console.log(`[WebSocket][‚úÖ ÊàêÂäü] Áî®Êà∑ ${userId} ËøûÊé•Â∑≤Âª∫Á´ã`);\n      this.startHeartbeat();\n    };\n    this.socket.onmessage = event => {\n      try {\n        console.log(`[WebSocket][üì© ÂéüÂßãÊï∞ÊçÆ] ${event.data}`);\n        const data = JSON.parse(event.data);\n        console.log(`[WebSocket][üì• Â∑≤Ëß£Êûê] cmd=${data.cmd}`, data);\n        this.handleMessage(data);\n      } catch (err) {\n        console.error('[WebSocket][‚ùå Ëß£ÊûêÂ§±Ë¥•]', event.data, err);\n      }\n    };\n    this.socket.onclose = () => {\n      console.warn(`[WebSocket][‚ö†Ô∏è ÂÖ≥Èó≠] ËøûÊé•Â∑≤ÂÖ≥Èó≠Ôºå5ÁßíÂêéÈáçËøû userId=${userId}`);\n      this.reconnect();\n    };\n    this.socket.onerror = err => {\n      console.error('[WebSocket][‚ùå ÈîôËØØ] ËøûÊé•ÂºÇÂ∏∏:', err);\n      this.socket.close(); // Ëß¶Âèë onclose -> reconnect\n\n      // ËøûÊé•Â§±Ë¥•ÂêéÂÅöÁôªÂá∫Êìç‰ΩúÔºåÊõ¥Êñ∞Áî®Êà∑Âú®Á∫øÁä∂ÊÄÅ\n      // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ\n      const userInfo = _store.default.getters['user/userInfo'];\n      console.log('userInfo===');\n      console.log(userInfo);\n      if (userInfo) {\n        const param = {\n          userId: userInfo.userId\n        };\n        (0, _user.handleLogout)(param).then(res => {\n          console.log(\"Áî®Êà∑ËøûÊé•Â§±Ë¥•ÂêéÂÅöÁôªÂá∫Êìç‰ΩúÔºåÊõ¥Êñ∞ Êï∞ÊçÆÂ∫ìÁî®Êà∑Âú®Á∫øÁä∂ÊÄÅ\");\n        });\n        _store.default.dispatch('user/logout');\n      }\n    };\n  }\n\n  /**\r\n   * Ëá™Âä®ÈáçËøû\r\n   */\n  reconnect() {\n    if (!this.userId) {\n      console.warn('[WebSocket][‚ö†Ô∏è ÈáçËøûÂèñÊ∂à] userId ‰∏∫Á©∫');\n      return;\n    }\n    setTimeout(() => {\n      console.log(`[WebSocket][üîÑ ÈáçËøû‰∏≠] Ê≠£Âú®Â∞ùËØïÈáçÊñ∞ËøûÊé• userId=${this.userId}...`);\n      this.connect(this.userId);\n    }, this.reconnectInterval);\n  }\n\n  /**\r\n   * ÂêØÂä®ÂøÉË∑≥ÂåÖ\r\n   */\n  startHeartbeat() {\n    if (this.heartbeatTimer) clearInterval(this.heartbeatTimer);\n    this.heartbeatTimer = setInterval(() => {\n      const ping = {\n        cmd: 100002,\n        timestamp: Date.now(),\n        data: {}\n      };\n      console.log('[WebSocket][üü¢ ÂøÉË∑≥] ÂèëÈÄÅ ping:', ping);\n      this.send(ping);\n      this.$ws.send({\n        cmd: 100003,\n        data: {}\n      });\n    }, this.heartbeatInterval);\n  }\n\n  /**\r\n   * ÂèëÈÄÅÊ∂àÊÅØ\r\n   */\n  send(data) {\n    if (this.socket && this.socket.readyState === WebSocket.OPEN) {\n      const str = JSON.stringify(data);\n      console.log('[WebSocket][üì§ ÂèëÈÄÅ]', str);\n      this.socket.send(str);\n    } else {\n      console.warn('[WebSocket][‚ö†Ô∏è Êú™ËøûÊé•] ÂΩìÂâçËøûÊé•‰∏çÂèØÁî®ÔºåÂèëÈÄÅÂ§±Ë¥•');\n    }\n  }\n\n  /**\r\n   * Ê¥æÂèëÊ∂àÊÅØÂà∞ Vuex\r\n   */\n  handleMessage(msg) {\n    console.log(`[WebSocket][üì¨ ÂàÜÂèë] Ê¥æÂèëËá≥ messageDispatcher: cmd=${msg.cmd}`);\n    this.store.dispatch('messageDispatcher/dispatch', msg);\n  }\n\n  /**\r\n   * ÊâãÂä®ÂÖ≥Èó≠ËøûÊé•ÔºàÁî®‰∫éÊ≥®ÈîÄ/ÂàáÊç¢Áî®Êà∑Ôºâ\r\n   */\n  close() {\n    console.log('[WebSocket][‚ùé ÂÖ≥Èó≠] ÊâãÂä®ÂÖ≥Èó≠ËøûÊé•');\n    if (this.socket) {\n      this.socket.close();\n      this.socket = null;\n    }\n    clearInterval(this.heartbeatTimer);\n  }\n}\nvar _default = exports.default = WebSocketService;","map":{"version":3,"names":["_store","_interopRequireDefault","require","_user","WebSocketService","constructor","store","socket","userId","reconnectInterval","heartbeatInterval","heartbeatTimer","connect","url","encodeURIComponent","console","log","WebSocket","onopen","startHeartbeat","onmessage","event","data","JSON","parse","cmd","handleMessage","err","error","onclose","warn","reconnect","onerror","close","userInfo","getters","param","handleLogout","then","res","dispatch","setTimeout","clearInterval","setInterval","ping","timestamp","Date","now","send","$ws","readyState","OPEN","str","stringify","msg","_default","exports","default"],"sources":["C:/Users/Administrator/Desktop/GimChat/gimChatVue/src/plugins/ws.js"],"sourcesContent":["/**\r\n * WebSocketService Â∞ÅË£ÖÁ±ª\r\n * - Ëá™Âä®ÈáçËøû\r\n * - ÂøÉË∑≥Êú∫Âà∂\r\n * - Áªü‰∏ÄÊ∂àÊÅØÂàÜÂèëÂà∞ Vuex\r\n */\r\n\r\nimport store from '@/store'  // Ë∑ØÂæÑÊ†πÊçÆ‰Ω†ÁöÑÈ°πÁõÆË∞ÉÊï¥\r\nimport { handleLogout } from '@/api/user'\r\n\r\nclass WebSocketService {\r\n  constructor(store) {\r\n    this.store = store;\r\n    this.socket = null;\r\n    this.userId = null;\r\n    this.reconnectInterval = 5000;\r\n    this.heartbeatInterval = 30000;\r\n    this.heartbeatTimer = null;\r\n  }\r\n\r\n  /**\r\n   * Âª∫Á´ã WebSocket ËøûÊé•\r\n   * @param {string} userId ÂΩìÂâçÁôªÂΩïÁî®Êà∑ ID\r\n   */\r\n  connect(userId) {\r\n    this.userId = userId;\r\n    const url = `ws://127.0.0.1:8888/ws?userId=${encodeURIComponent(userId)}`;\r\n    console.log(`[WebSocket][ËøûÊé•] Ê≠£Âú®ËøûÊé• userId=${userId} Âú∞ÂùÄ: ${url}`);\r\n\r\n    this.socket = new WebSocket(url);\r\n\r\n    this.socket.onopen = () => {\r\n      console.log(`[WebSocket][‚úÖ ÊàêÂäü] Áî®Êà∑ ${userId} ËøûÊé•Â∑≤Âª∫Á´ã`);\r\n      this.startHeartbeat();\r\n    };\r\n\r\n    this.socket.onmessage = (event) => {\r\n      try {\r\n        console.log(`[WebSocket][üì© ÂéüÂßãÊï∞ÊçÆ] ${event.data}`);\r\n        const data = JSON.parse(event.data);\r\n        console.log(`[WebSocket][üì• Â∑≤Ëß£Êûê] cmd=${data.cmd}`, data);\r\n        this.handleMessage(data);\r\n      } catch (err) {\r\n        console.error('[WebSocket][‚ùå Ëß£ÊûêÂ§±Ë¥•]', event.data, err);\r\n      }\r\n    };\r\n\r\n    this.socket.onclose = () => {\r\n      console.warn(`[WebSocket][‚ö†Ô∏è ÂÖ≥Èó≠] ËøûÊé•Â∑≤ÂÖ≥Èó≠Ôºå5ÁßíÂêéÈáçËøû userId=${userId}`);\r\n      this.reconnect();\r\n    };\r\n\r\n    this.socket.onerror = (err) => {\r\n      console.error('[WebSocket][‚ùå ÈîôËØØ] ËøûÊé•ÂºÇÂ∏∏:', err);\r\n      this.socket.close(); // Ëß¶Âèë onclose -> reconnect\r\n\r\n      // ËøûÊé•Â§±Ë¥•ÂêéÂÅöÁôªÂá∫Êìç‰ΩúÔºåÊõ¥Êñ∞Áî®Êà∑Âú®Á∫øÁä∂ÊÄÅ\r\n      // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ\r\n      const userInfo = store.getters['user/userInfo'];\r\n\r\n      console.log('userInfo===')\r\n      console.log(userInfo)\r\n\r\n      if (userInfo) {\r\n        const param = {\r\n          userId: userInfo.userId\r\n        }\r\n\r\n\r\n        handleLogout(param).then(res => {\r\n          console.log(\"Áî®Êà∑ËøûÊé•Â§±Ë¥•ÂêéÂÅöÁôªÂá∫Êìç‰ΩúÔºåÊõ¥Êñ∞ Êï∞ÊçÆÂ∫ìÁî®Êà∑Âú®Á∫øÁä∂ÊÄÅ\")\r\n        })\r\n\r\n        store.dispatch('user/logout')\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Ëá™Âä®ÈáçËøû\r\n   */\r\n  reconnect() {\r\n    if (!this.userId) {\r\n      console.warn('[WebSocket][‚ö†Ô∏è ÈáçËøûÂèñÊ∂à] userId ‰∏∫Á©∫');\r\n      return;\r\n    }\r\n\r\n    setTimeout(() => {\r\n      console.log(`[WebSocket][üîÑ ÈáçËøû‰∏≠] Ê≠£Âú®Â∞ùËØïÈáçÊñ∞ËøûÊé• userId=${this.userId}...`);\r\n      this.connect(this.userId);\r\n    }, this.reconnectInterval);\r\n  }\r\n\r\n  /**\r\n   * ÂêØÂä®ÂøÉË∑≥ÂåÖ\r\n   */\r\n  startHeartbeat() {\r\n    if (this.heartbeatTimer) clearInterval(this.heartbeatTimer);\r\n\r\n    this.heartbeatTimer = setInterval(() => {\r\n      const ping = { cmd: 100002, timestamp: Date.now(), data: {} };\r\n      console.log('[WebSocket][üü¢ ÂøÉË∑≥] ÂèëÈÄÅ ping:', ping);\r\n      this.send(ping);\r\n\r\n      this.$ws.send({\r\n        cmd: 100003,\r\n        data: {}\r\n      });\r\n    }, this.heartbeatInterval);\r\n\r\n\r\n  }\r\n\r\n  /**\r\n   * ÂèëÈÄÅÊ∂àÊÅØ\r\n   */\r\n  send(data) {\r\n    if (this.socket && this.socket.readyState === WebSocket.OPEN) {\r\n      const str = JSON.stringify(data);\r\n      console.log('[WebSocket][üì§ ÂèëÈÄÅ]', str);\r\n      this.socket.send(str);\r\n    } else {\r\n      console.warn('[WebSocket][‚ö†Ô∏è Êú™ËøûÊé•] ÂΩìÂâçËøûÊé•‰∏çÂèØÁî®ÔºåÂèëÈÄÅÂ§±Ë¥•');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Ê¥æÂèëÊ∂àÊÅØÂà∞ Vuex\r\n   */\r\n  handleMessage(msg) {\r\n    console.log(`[WebSocket][üì¨ ÂàÜÂèë] Ê¥æÂèëËá≥ messageDispatcher: cmd=${msg.cmd}`);\r\n    this.store.dispatch('messageDispatcher/dispatch', msg);\r\n  }\r\n\r\n  /**\r\n   * ÊâãÂä®ÂÖ≥Èó≠ËøûÊé•ÔºàÁî®‰∫éÊ≥®ÈîÄ/ÂàáÊç¢Áî®Êà∑Ôºâ\r\n   */\r\n  close() {\r\n    console.log('[WebSocket][‚ùé ÂÖ≥Èó≠] ÊâãÂä®ÂÖ≥Èó≠ËøûÊé•');\r\n    if (this.socket) {\r\n      this.socket.close();\r\n      this.socket = null;\r\n    }\r\n    clearInterval(this.heartbeatTimer);\r\n  }\r\n}\r\n\r\nexport default WebSocketService;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}