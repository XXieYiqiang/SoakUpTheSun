{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\nrequire(\"core-js/modules/es.array.push.js\");\nrequire(\"core-js/modules/es.iterator.constructor.js\");\nrequire(\"core-js/modules/es.iterator.for-each.js\");\nvar _default = exports.default = {\n  name: \"SFURoom\",\n  data() {\n    return {\n      // ÈÖçÁΩÆÈ°π\n      wsUrl: \"ws://192.168.43.143:8080/room/join\",\n      roomID: \"ToRhXRHjv8MEMHn9RE8rLt\",\n      uid: \"user_\" + Math.floor(Math.random() * 1000),\n      // Áä∂ÊÄÅÊéßÂà∂\n      joined: false,\n      loading: false,\n      logs: [],\n      // WebRTC Ê†∏ÂøÉÂØπË±°\n      ws: null,\n      localStream: null,\n      upPC: null,\n      downPC: null,\n      // ÊµÅÁÆ°ÁêÜ\n      remoteStreams: {},\n      // { uid: MediaStream }\n\n      // ÂçèÂïÜÈîÅ‰∏éÈòüÂàó (Ëß£ÂÜ≥Âπ∂Âèë Offer ÂÜ≤Á™Å)\n      isDownNegotiating: false,\n      offerQueue: [],\n      pendingCandidates: [],\n      // ÁºìÂ≠ò SDP Êú™Â∞±Áª™Êó∂ÁöÑ Candidate\n\n      // ÁõëÊéßÊï∞ÊçÆ\n      qualityStats: {},\n      statsTimer: null,\n      lastBytesReceived: {} // { ssrc: { bytes, time } }\n    };\n  },\n  methods: {\n    log(msg) {\n      const time = new Date().toLocaleTimeString();\n      this.logs.unshift(`[${time}] ${msg}`);\n      if (this.logs.length > 50) this.logs.pop();\n      console.log(`[SFU] ${msg}`);\n    },\n    async joinRoom() {\n      if (!this.roomID || !this.uid) return alert(\"ËØ∑ËæìÂÖ•ÊàøÈó¥Âè∑ÂíåUID\");\n      this.loading = true;\n      try {\n        // 1. Ëé∑ÂèñÊú¨Âú∞Â™í‰Ωì\n        this.localStream = await navigator.mediaDevices.getUserMedia({\n          video: {\n            width: 640,\n            height: 360,\n            frameRate: 15\n          },\n          audio: false // Ê†πÊçÆÈúÄË¶ÅÂºÄÂêØ\n        });\n        this.$refs.localVideo.srcObject = this.localStream;\n        this.log(\"Êú¨Âú∞Â™í‰ΩìÊµÅÂ∑≤Â∞±Áª™\");\n\n        // 2. ËøûÊé•‰ø°‰ª§\n        this.connectWebSocket();\n      } catch (e) {\n        this.log(\"Â™í‰ΩìËé∑ÂèñÂ§±Ë¥•: \" + e.message);\n        this.loading = false;\n      }\n    },\n    connectWebSocket() {\n      const url = `${this.wsUrl}?uid=${this.uid}&roomID=${this.roomID}`;\n      this.ws = new WebSocket(url);\n      this.ws.onopen = () => {\n        this.log(\"‰ø°‰ª§ÊúçÂä°Âô®Â∑≤ËøûÊé•\");\n        this.joined = true;\n        this.loading = false;\n        this.createUpstream();\n        this.startStatsMonitor(); // ÂºÄÂêØÁõëÊéß\n      };\n      this.ws.onmessage = event => {\n        const msg = JSON.parse(event.data);\n        this.handleSignal(msg);\n      };\n      this.ws.onclose = () => {\n        this.log(\"‰ø°‰ª§ÈÄöÈÅìÂ∑≤Êñ≠ÂºÄ\");\n        this.leaveRoom(false);\n      };\n    },\n    async handleSignal(msg) {\n      const {\n        event,\n        data\n      } = msg;\n      switch (event) {\n        case \"up_answer\":\n          await this.upPC.setRemoteDescription(new RTCSessionDescription({\n            type: 'answer',\n            sdp: data.sdp\n          }));\n          this.log(\"Êé®ÊµÅ SDP ÂçèÂïÜÂÆåÊàê\");\n          break;\n        case \"up_candidate\":\n          if (this.upPC) await this.upPC.addIceCandidate(data.candidate);\n          break;\n        case \"down_offer\":\n          this.enqueueDownOffer(data);\n          break;\n        case \"down_candidate\":\n          this.handleRemoteCandidate(this.downPC, data.candidate);\n          break;\n        case \"user_leave\":\n        case \"unpublish_stream\":\n          const targetId = data.uid || data.publisherId;\n          this.removeRemoteUser(targetId);\n          break;\n      }\n    },\n    // ================= Êé®ÊµÅÈÄªËæë (Publish) =================\n    async createUpstream() {\n      this.upPC = new RTCPeerConnection({\n        iceServers: [{\n          urls: \"stun:stun.l.google.com:19302\"\n        }]\n      });\n      this.localStream.getTracks().forEach(track => {\n        this.upPC.addTrack(track, this.localStream);\n      });\n      this.upPC.onicecandidate = e => {\n        if (e.candidate) this.sendSignal(\"up_candidate\", {\n          candidate: e.candidate\n        });\n      };\n      const offer = await this.upPC.createOffer();\n      await this.upPC.setLocalDescription(offer);\n      this.sendSignal(\"up_offer\", {\n        uid: this.uid,\n        sdp: offer.sdp\n      });\n    },\n    // ================= ÊãâÊµÅ‰∏éÈòüÂàóÂçèÂïÜ (Subscribe) =================\n    async enqueueDownOffer(data) {\n      this.offerQueue.push(data);\n      if (this.isDownNegotiating) return;\n      while (this.offerQueue.length > 0) {\n        const currentOffer = this.offerQueue.shift();\n        await this.processDownOffer(currentOffer);\n      }\n    },\n    async processDownOffer(data) {\n      if (!this.downPC) this.initDownPC();\n      this.isDownNegotiating = true;\n      this.log(`Â§ÑÁêÜÊãâÊµÅÂçèÂïÜ: Êù•Ëá™ ${data.from}`);\n      try {\n        await this.downPC.setRemoteDescription(new RTCSessionDescription({\n          type: 'offer',\n          sdp: data.sdp\n        }));\n\n        // SDP Â∞±Áª™ÂêéÔºåÁ´ãÂç≥Â§ÑÁêÜÁºìÂ≠òÁöÑ Candidate\n        while (this.pendingCandidates.length > 0) {\n          const cand = this.pendingCandidates.shift();\n          await this.downPC.addIceCandidate(new RTCIceCandidate(cand));\n        }\n        const answer = await this.downPC.createAnswer();\n        await this.downPC.setLocalDescription(answer);\n        this.sendSignal(\"down_answer\", {\n          sdp: answer.sdp\n        });\n      } catch (e) {\n        this.log(\"ÊãâÊµÅÂçèÂïÜÂºÇÂ∏∏: \" + e.message);\n      } finally {\n        await new Promise(resolve => setTimeout(resolve, 150)); // Áä∂ÊÄÅËá™ÊÑàÁºìÂÜ≤\n        this.isDownNegotiating = false;\n      }\n    },\n    async handleRemoteCandidate(pc, candidateInit) {\n      if (!candidateInit || !candidateInit.candidate) return;\n      if (!pc || !pc.remoteDescription || !pc.remoteDescription.type) {\n        this.pendingCandidates.push(candidateInit);\n        return;\n      }\n      try {\n        await pc.addIceCandidate(new RTCIceCandidate(candidateInit));\n      } catch (e) {\n        console.warn(\"Candidate Ê∑ªÂä†Â§±Ë¥•\", e);\n      }\n    },\n    initDownPC() {\n      this.downPC = new RTCPeerConnection({\n        iceServers: [{\n          urls: \"stun:stun.l.google.com:19302\"\n        }]\n      });\n      this.downPC.onicecandidate = e => {\n        if (e.candidate) this.sendSignal(\"down_candidate\", {\n          candidate: e.candidate\n        });\n      };\n      this.downPC.ontrack = event => {\n        const stream = event.streams[0];\n        if (!stream) return;\n        const remoteUid = stream.id; // ÂêéÁ´Ø NewTrackLocalStaticRTP ÁöÑ streamID\n        this.log(`Ê£ÄÊµãÂà∞ËøúÁ®ãËΩ®ÈÅì: ${remoteUid}`);\n        if (!this.remoteStreams[remoteUid]) {\n          this.$set(this.remoteStreams, remoteUid, stream);\n        }\n      };\n      this.downPC.onconnectionstatechange = () => {\n        this.log(`DownPC Áä∂ÊÄÅ: ${this.downPC.connectionState}`);\n      };\n    },\n    // ================= Ë¥®ÈáèÁõëÊéß (Stats) =================\n    startStatsMonitor() {\n      this.statsTimer = setInterval(async () => {\n        if (!this.downPC || this.downPC.connectionState !== 'connected') return;\n        const stats = await this.downPC.getStats();\n        const newStats = {};\n        stats.forEach(report => {\n          if (report.type === 'inbound-rtp' && report.kind === 'video') {\n            // 1. ËÆ°ÁÆóÁ†ÅÁéá\n            const bytes = report.bytesReceived || 0;\n            const now = report.timestamp;\n            const last = this.lastBytesReceived[report.ssrc] || {\n              bytes,\n              time: now\n            };\n            const bitrate = Math.floor((bytes - last.bytes) * 8 / (now - last.time));\n            this.lastBytesReceived[report.ssrc] = {\n              bytes,\n              time: now\n            };\n\n            // 2. ËÆ°ÁÆó‰∏¢ÂåÖÁéá\n            const lost = report.packetsLost || 0;\n            const received = report.packetsReceived || 0;\n            const lossRate = lost + received > 0 ? (lost / (lost + received) * 100).toFixed(1) : 0;\n\n            // 3. ÂåπÈÖç UID (ÈÄöËøá trackIdentifier Êò†Â∞Ñ)\n            let displayUid = \"Êú™Áü•Áî®Êà∑\";\n            for (let uid in this.remoteStreams) {\n              if (this.remoteStreams[uid].getVideoTracks()[0]?.id === report.trackIdentifier) {\n                displayUid = uid;\n                break;\n              }\n            }\n            if (displayUid === \"Êú™Áü•Áî®Êà∑\") displayUid = `SSRC-${report.ssrc}`;\n            newStats[displayUid] = {\n              width: report.frameWidth || 0,\n              height: report.frameHeight || 0,\n              fps: report.framesPerSecond || 0,\n              bitrate: bitrate < 0 ? 0 : bitrate,\n              packetLoss: lossRate\n            };\n          }\n        });\n        this.qualityStats = newStats;\n      }, 1000);\n    },\n    removeRemoteUser(uid) {\n      if (this.remoteStreams[uid]) {\n        this.log(`ÁßªÈô§Áî®Êà∑ÊµÅ: ${uid}`);\n        this.$delete(this.remoteStreams, uid);\n        this.$delete(this.qualityStats, uid);\n      }\n    },\n    sendSignal(event, data) {\n      if (this.ws?.readyState === WebSocket.OPEN) {\n        this.ws.send(JSON.stringify({\n          event,\n          data\n        }));\n      }\n    },\n    leaveRoom(closeWs = true) {\n      this.joined = false;\n      if (this.statsTimer) clearInterval(this.statsTimer);\n      if (this.upPC) this.upPC.close();\n      if (this.downPC) this.downPC.close();\n      if (this.localStream) this.localStream.getTracks().forEach(t => t.stop());\n      if (closeWs && this.ws) this.ws.close();\n      this.remoteStreams = {};\n      this.qualityStats = {};\n      this.offerQueue = [];\n      this.upPC = null;\n      this.downPC = null;\n      this.log(\"ËµÑÊ∫êÂ∑≤Ê∏ÖÁêÜÔºåÂ∑≤Á¶ªÂºÄÊàøÈó¥\");\n    }\n  },\n  beforeDestroy() {\n    this.leaveRoom();\n  }\n};","map":{"version":3,"names":["name","data","wsUrl","roomID","uid","Math","floor","random","joined","loading","logs","ws","localStream","upPC","downPC","remoteStreams","isDownNegotiating","offerQueue","pendingCandidates","qualityStats","statsTimer","lastBytesReceived","methods","log","msg","time","Date","toLocaleTimeString","unshift","length","pop","console","joinRoom","alert","navigator","mediaDevices","getUserMedia","video","width","height","frameRate","audio","$refs","localVideo","srcObject","connectWebSocket","e","message","url","WebSocket","onopen","createUpstream","startStatsMonitor","onmessage","event","JSON","parse","handleSignal","onclose","leaveRoom","setRemoteDescription","RTCSessionDescription","type","sdp","addIceCandidate","candidate","enqueueDownOffer","handleRemoteCandidate","targetId","publisherId","removeRemoteUser","RTCPeerConnection","iceServers","urls","getTracks","forEach","track","addTrack","onicecandidate","sendSignal","offer","createOffer","setLocalDescription","push","currentOffer","shift","processDownOffer","initDownPC","from","cand","RTCIceCandidate","answer","createAnswer","Promise","resolve","setTimeout","pc","candidateInit","remoteDescription","warn","ontrack","stream","streams","remoteUid","id","$set","onconnectionstatechange","connectionState","setInterval","stats","getStats","newStats","report","kind","bytes","bytesReceived","now","timestamp","last","ssrc","bitrate","lost","packetsLost","received","packetsReceived","lossRate","toFixed","displayUid","getVideoTracks","trackIdentifier","frameWidth","frameHeight","fps","framesPerSecond","packetLoss","$delete","readyState","OPEN","send","stringify","closeWs","clearInterval","close","t","stop","beforeDestroy"],"sources":["src/views/utils/test2.vue"],"sourcesContent":["<template>\r\n  <div class=\"sfu-room\">\r\n    <div class=\"controls\">\r\n      <h2>SFU ËßÜÈ¢ë‰ºöËÆÆ (ÂèåÂêëËá™ÊÑàÁõëÊéßÁâà)</h2>\r\n      <div v-if=\"!joined\" class=\"login-form\">\r\n        <input v-model=\"roomID\" placeholder=\"ÊàøÈó¥Âè∑\" />\r\n        <input v-model=\"uid\" placeholder=\"ÊàëÁöÑUID\" />\r\n        <button @click=\"joinRoom\" :disabled=\"loading\">ËøõÂÖ•ÊàøÈó¥</button>\r\n      </div>\r\n      <div v-else class=\"actions\">\r\n        <span>ÊàøÈó¥: <b>{{ roomID }}</b> | ÊàëÁöÑUID: <b>{{ uid }}</b></span>\r\n        <button class=\"btn-leave\" @click=\"leaveRoom\">Á¶ªÂºÄÊàøÈó¥</button>\r\n      </div>\r\n    </div>\r\n\r\n    <div class=\"video-grid\">\r\n      <div class=\"video-card local\">\r\n        <video ref=\"localVideo\" autoplay playsinline muted></video>\r\n        <div class=\"label\">Êàë ({{ uid }})</div>\r\n      </div>\r\n\r\n      <div v-for=\"(stream, remoteUid) in remoteStreams\" :key=\"remoteUid\" class=\"video-card remote\">\r\n        <video :src-object.prop=\"stream\" autoplay playsinline></video>\r\n        <div class=\"label\">\r\n          Áî®Êà∑: {{ remoteUid }}\r\n          <span class=\"status-tag\">Â∑≤ÂêåÊ≠•</span>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <div class=\"monitor-panel\" v-if=\"joined && Object.keys(qualityStats).length > 0\">\r\n      <div class=\"monitor-header\">\r\n        <h3>üì° ÂÆûÊó∂‰∏ãË°åË¥®ÈáèÁõëÊéß (DownPC)</h3>\r\n        <span class=\"tip\">ÊèêÁ§∫ÔºöËã•Á†ÅÁéá‰∏∫ 0ÔºåËØ∑Ê£ÄÊü•ÊúçÂä°Á´Ø UDP Á´ØÂè£ÂºÄÊîæÊÉÖÂÜµ</span>\r\n      </div>\r\n      <div class=\"stats-grid\">\r\n        <div v-for=\"(stat, targetUid) in qualityStats\" :key=\"targetUid\" class=\"stat-card-mini\">\r\n          <div class=\"stat-uid\">Ê∫êÁî®Êà∑: {{ targetUid }}</div>\r\n          <div class=\"stat-body\">\r\n            <div class=\"stat-item\">\r\n              <span class=\"stat-label\">ÂàÜËæ®Áéá</span>\r\n              <span class=\"stat-value\">{{ stat.width }}x{{ stat.height }}</span>\r\n            </div>\r\n            <div class=\"stat-item\">\r\n              <span class=\"stat-label\">Á†ÅÁéá</span>\r\n              <span class=\"stat-value\">{{ stat.bitrate }} kbps</span>\r\n            </div>\r\n            <div class=\"stat-item\">\r\n              <span class=\"stat-label\">Â∏ßÁéá</span>\r\n              <span class=\"stat-value\">{{ stat.fps }} fps</span>\r\n            </div>\r\n            <div class=\"stat-item\">\r\n              <span class=\"stat-label\">‰∏¢ÂåÖ</span>\r\n              <span :class=\"['stat-value', stat.packetLoss > 5 ? 'danger' : 'safe']\">\r\n                {{ stat.packetLoss }}%\r\n              </span>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <div class=\"logs\">\r\n      <div v-for=\"(log, i) in logs\" :key=\"i\" class=\"log-item\">\r\n        {{ log }}\r\n      </div>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nexport default {\r\n  name: \"SFURoom\",\r\n  data() {\r\n    return {\r\n      // ÈÖçÁΩÆÈ°π\r\n      wsUrl: \"ws://192.168.43.143:8080/room/join\",\r\n      roomID: \"ToRhXRHjv8MEMHn9RE8rLt\",\r\n      uid: \"user_\" + Math.floor(Math.random() * 1000),\r\n\r\n      // Áä∂ÊÄÅÊéßÂà∂\r\n      joined: false,\r\n      loading: false,\r\n      logs: [],\r\n\r\n      // WebRTC Ê†∏ÂøÉÂØπË±°\r\n      ws: null,\r\n      localStream: null,\r\n      upPC: null,\r\n      downPC: null,\r\n\r\n      // ÊµÅÁÆ°ÁêÜ\r\n      remoteStreams: {}, // { uid: MediaStream }\r\n\r\n      // ÂçèÂïÜÈîÅ‰∏éÈòüÂàó (Ëß£ÂÜ≥Âπ∂Âèë Offer ÂÜ≤Á™Å)\r\n      isDownNegotiating: false,\r\n      offerQueue: [],\r\n      pendingCandidates: [], // ÁºìÂ≠ò SDP Êú™Â∞±Áª™Êó∂ÁöÑ Candidate\r\n\r\n      // ÁõëÊéßÊï∞ÊçÆ\r\n      qualityStats: {},\r\n      statsTimer: null,\r\n      lastBytesReceived: {}, // { ssrc: { bytes, time } }\r\n    };\r\n  },\r\n  methods: {\r\n    log(msg) {\r\n      const time = new Date().toLocaleTimeString();\r\n      this.logs.unshift(`[${time}] ${msg}`);\r\n      if (this.logs.length > 50) this.logs.pop();\r\n      console.log(`[SFU] ${msg}`);\r\n    },\r\n\r\n    async joinRoom() {\r\n      if (!this.roomID || !this.uid) return alert(\"ËØ∑ËæìÂÖ•ÊàøÈó¥Âè∑ÂíåUID\");\r\n      this.loading = true;\r\n\r\n      try {\r\n        // 1. Ëé∑ÂèñÊú¨Âú∞Â™í‰Ωì\r\n        this.localStream = await navigator.mediaDevices.getUserMedia({\r\n          video: { width: 640, height: 360, frameRate: 15 },\r\n          audio: false // Ê†πÊçÆÈúÄË¶ÅÂºÄÂêØ\r\n        });\r\n        this.$refs.localVideo.srcObject = this.localStream;\r\n        this.log(\"Êú¨Âú∞Â™í‰ΩìÊµÅÂ∑≤Â∞±Áª™\");\r\n\r\n        // 2. ËøûÊé•‰ø°‰ª§\r\n        this.connectWebSocket();\r\n      } catch (e) {\r\n        this.log(\"Â™í‰ΩìËé∑ÂèñÂ§±Ë¥•: \" + e.message);\r\n        this.loading = false;\r\n      }\r\n    },\r\n\r\n    connectWebSocket() {\r\n      const url = `${this.wsUrl}?uid=${this.uid}&roomID=${this.roomID}`;\r\n      this.ws = new WebSocket(url);\r\n\r\n      this.ws.onopen = () => {\r\n        this.log(\"‰ø°‰ª§ÊúçÂä°Âô®Â∑≤ËøûÊé•\");\r\n        this.joined = true;\r\n        this.loading = false;\r\n        this.createUpstream();\r\n        this.startStatsMonitor(); // ÂºÄÂêØÁõëÊéß\r\n      };\r\n\r\n      this.ws.onmessage = (event) => {\r\n        const msg = JSON.parse(event.data);\r\n        this.handleSignal(msg);\r\n      };\r\n\r\n      this.ws.onclose = () => {\r\n        this.log(\"‰ø°‰ª§ÈÄöÈÅìÂ∑≤Êñ≠ÂºÄ\");\r\n        this.leaveRoom(false);\r\n      };\r\n    },\r\n\r\n    async handleSignal(msg) {\r\n      const { event, data } = msg;\r\n\r\n      switch (event) {\r\n        case \"up_answer\":\r\n          await this.upPC.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: data.sdp }));\r\n          this.log(\"Êé®ÊµÅ SDP ÂçèÂïÜÂÆåÊàê\");\r\n          break;\r\n\r\n        case \"up_candidate\":\r\n          if (this.upPC) await this.upPC.addIceCandidate(data.candidate);\r\n          break;\r\n\r\n        case \"down_offer\":\r\n          this.enqueueDownOffer(data);\r\n          break;\r\n\r\n        case \"down_candidate\":\r\n          this.handleRemoteCandidate(this.downPC, data.candidate);\r\n          break;\r\n\r\n        case \"user_leave\":\r\n        case \"unpublish_stream\":\r\n          const targetId = data.uid || data.publisherId;\r\n          this.removeRemoteUser(targetId);\r\n          break;\r\n      }\r\n    },\r\n\r\n    // ================= Êé®ÊµÅÈÄªËæë (Publish) =================\r\n    async createUpstream() {\r\n      this.upPC = new RTCPeerConnection({\r\n        iceServers: [{ urls: \"stun:stun.l.google.com:19302\" }]\r\n      });\r\n\r\n      this.localStream.getTracks().forEach(track => {\r\n        this.upPC.addTrack(track, this.localStream);\r\n      });\r\n\r\n      this.upPC.onicecandidate = (e) => {\r\n        if (e.candidate) this.sendSignal(\"up_candidate\", { candidate: e.candidate });\r\n      };\r\n\r\n      const offer = await this.upPC.createOffer();\r\n      await this.upPC.setLocalDescription(offer);\r\n      this.sendSignal(\"up_offer\", { uid: this.uid, sdp: offer.sdp });\r\n    },\r\n\r\n    // ================= ÊãâÊµÅ‰∏éÈòüÂàóÂçèÂïÜ (Subscribe) =================\r\n    async enqueueDownOffer(data) {\r\n      this.offerQueue.push(data);\r\n      if (this.isDownNegotiating) return;\r\n\r\n      while (this.offerQueue.length > 0) {\r\n        const currentOffer = this.offerQueue.shift();\r\n        await this.processDownOffer(currentOffer);\r\n      }\r\n    },\r\n\r\n    async processDownOffer(data) {\r\n      if (!this.downPC) this.initDownPC();\r\n\r\n      this.isDownNegotiating = true;\r\n      this.log(`Â§ÑÁêÜÊãâÊµÅÂçèÂïÜ: Êù•Ëá™ ${data.from}`);\r\n\r\n      try {\r\n        await this.downPC.setRemoteDescription(new RTCSessionDescription({\r\n          type: 'offer',\r\n          sdp: data.sdp\r\n        }));\r\n\r\n        // SDP Â∞±Áª™ÂêéÔºåÁ´ãÂç≥Â§ÑÁêÜÁºìÂ≠òÁöÑ Candidate\r\n        while (this.pendingCandidates.length > 0) {\r\n          const cand = this.pendingCandidates.shift();\r\n          await this.downPC.addIceCandidate(new RTCIceCandidate(cand));\r\n        }\r\n\r\n        const answer = await this.downPC.createAnswer();\r\n        await this.downPC.setLocalDescription(answer);\r\n\r\n        this.sendSignal(\"down_answer\", { sdp: answer.sdp });\r\n      } catch (e) {\r\n        this.log(\"ÊãâÊµÅÂçèÂïÜÂºÇÂ∏∏: \" + e.message);\r\n      } finally {\r\n        await new Promise(resolve => setTimeout(resolve, 150)); // Áä∂ÊÄÅËá™ÊÑàÁºìÂÜ≤\r\n        this.isDownNegotiating = false;\r\n      }\r\n    },\r\n\r\n    async handleRemoteCandidate(pc, candidateInit) {\r\n      if (!candidateInit || !candidateInit.candidate) return;\r\n\r\n      if (!pc || !pc.remoteDescription || !pc.remoteDescription.type) {\r\n        this.pendingCandidates.push(candidateInit);\r\n        return;\r\n      }\r\n\r\n      try {\r\n        await pc.addIceCandidate(new RTCIceCandidate(candidateInit));\r\n      } catch (e) {\r\n        console.warn(\"Candidate Ê∑ªÂä†Â§±Ë¥•\", e);\r\n      }\r\n    },\r\n\r\n    initDownPC() {\r\n      this.downPC = new RTCPeerConnection({\r\n        iceServers: [{ urls: \"stun:stun.l.google.com:19302\" }]\r\n      });\r\n\r\n      this.downPC.onicecandidate = (e) => {\r\n        if (e.candidate) this.sendSignal(\"down_candidate\", { candidate: e.candidate });\r\n      };\r\n\r\n      this.downPC.ontrack = (event) => {\r\n        const stream = event.streams[0];\r\n        if (!stream) return;\r\n\r\n        const remoteUid = stream.id; // ÂêéÁ´Ø NewTrackLocalStaticRTP ÁöÑ streamID\r\n        this.log(`Ê£ÄÊµãÂà∞ËøúÁ®ãËΩ®ÈÅì: ${remoteUid}`);\r\n\r\n        if (!this.remoteStreams[remoteUid]) {\r\n          this.$set(this.remoteStreams, remoteUid, stream);\r\n        }\r\n      };\r\n\r\n      this.downPC.onconnectionstatechange = () => {\r\n        this.log(`DownPC Áä∂ÊÄÅ: ${this.downPC.connectionState}`);\r\n      };\r\n    },\r\n\r\n    // ================= Ë¥®ÈáèÁõëÊéß (Stats) =================\r\n    startStatsMonitor() {\r\n      this.statsTimer = setInterval(async () => {\r\n        if (!this.downPC || this.downPC.connectionState !== 'connected') return;\r\n\r\n        const stats = await this.downPC.getStats();\r\n        const newStats = {};\r\n\r\n        stats.forEach(report => {\r\n          if (report.type === 'inbound-rtp' && report.kind === 'video') {\r\n            // 1. ËÆ°ÁÆóÁ†ÅÁéá\r\n            const bytes = report.bytesReceived || 0;\r\n            const now = report.timestamp;\r\n            const last = this.lastBytesReceived[report.ssrc] || { bytes, time: now };\r\n            const bitrate = Math.floor(((bytes - last.bytes) * 8) / (now - last.time));\r\n            this.lastBytesReceived[report.ssrc] = { bytes, time: now };\r\n\r\n            // 2. ËÆ°ÁÆó‰∏¢ÂåÖÁéá\r\n            const lost = report.packetsLost || 0;\r\n            const received = report.packetsReceived || 0;\r\n            const lossRate = (lost + received) > 0 ? ((lost / (lost + received)) * 100).toFixed(1) : 0;\r\n\r\n            // 3. ÂåπÈÖç UID (ÈÄöËøá trackIdentifier Êò†Â∞Ñ)\r\n            let displayUid = \"Êú™Áü•Áî®Êà∑\";\r\n            for (let uid in this.remoteStreams) {\r\n              if (this.remoteStreams[uid].getVideoTracks()[0]?.id === report.trackIdentifier) {\r\n                displayUid = uid;\r\n                break;\r\n              }\r\n            }\r\n            if (displayUid === \"Êú™Áü•Áî®Êà∑\") displayUid = `SSRC-${report.ssrc}`;\r\n\r\n            newStats[displayUid] = {\r\n              width: report.frameWidth || 0,\r\n              height: report.frameHeight || 0,\r\n              fps: report.framesPerSecond || 0,\r\n              bitrate: bitrate < 0 ? 0 : bitrate,\r\n              packetLoss: lossRate\r\n            };\r\n          }\r\n        });\r\n        this.qualityStats = newStats;\r\n      }, 1000);\r\n    },\r\n\r\n    removeRemoteUser(uid) {\r\n      if (this.remoteStreams[uid]) {\r\n        this.log(`ÁßªÈô§Áî®Êà∑ÊµÅ: ${uid}`);\r\n        this.$delete(this.remoteStreams, uid);\r\n        this.$delete(this.qualityStats, uid);\r\n      }\r\n    },\r\n\r\n    sendSignal(event, data) {\r\n      if (this.ws?.readyState === WebSocket.OPEN) {\r\n        this.ws.send(JSON.stringify({ event, data }));\r\n      }\r\n    },\r\n\r\n    leaveRoom(closeWs = true) {\r\n      this.joined = false;\r\n      if (this.statsTimer) clearInterval(this.statsTimer);\r\n      if (this.upPC) this.upPC.close();\r\n      if (this.downPC) this.downPC.close();\r\n      if (this.localStream) this.localStream.getTracks().forEach(t => t.stop());\r\n      if (closeWs && this.ws) this.ws.close();\r\n      \r\n      this.remoteStreams = {};\r\n      this.qualityStats = {};\r\n      this.offerQueue = [];\r\n      this.upPC = null;\r\n      this.downPC = null;\r\n      this.log(\"ËµÑÊ∫êÂ∑≤Ê∏ÖÁêÜÔºåÂ∑≤Á¶ªÂºÄÊàøÈó¥\");\r\n    }\r\n  },\r\n  beforeDestroy() {\r\n    this.leaveRoom();\r\n  }\r\n};\r\n</script>\r\n\r\n<style scoped>\r\n.sfu-room { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background: #f0f2f5; min-height: 100vh; color: #333; }\r\n.controls { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: flex; flex-direction: column; gap: 10px; }\r\n.login-form input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; }\r\nbutton { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; transition: 0.2s; }\r\nbutton:hover { background: #0056b3; }\r\n.btn-leave { background: #ff4d4f; }\r\n.btn-leave:hover { background: #d9363e; }\r\n\r\n.video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }\r\n.video-card { background: #000; border-radius: 12px; overflow: hidden; aspect-ratio: 16/9; position: relative; border: 2px solid #eee; }\r\nvideo { width: 100%; height: 100%; object-fit: cover; }\r\n.local video { transform: scaleX(-1); }\r\n.label { position: absolute; bottom: 12px; left: 12px; background: rgba(0,0,0,0.6); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; }\r\n.status-tag { margin-left: 8px; color: #52c41a; font-weight: bold; }\r\n\r\n/* ÁõëÊéßÈù¢ÊùøÊ†∑Âºè */\r\n.monitor-panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }\r\n.monitor-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; margin-bottom: 15px; }\r\n.tip { font-size: 12px; color: #888; }\r\n.stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }\r\n.stat-card-mini { background: #fafafa; border: 1px solid #f0f0f0; border-radius: 8px; padding: 12px; }\r\n.stat-uid { font-weight: bold; font-size: 13px; margin-bottom: 8px; color: #1890ff; overflow: hidden; text-overflow: ellipsis; }\r\n.stat-item { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; }\r\n.stat-label { color: #666; }\r\n.stat-value { font-weight: bold; font-family: 'Courier New', Courier, monospace; }\r\n.stat-value.safe { color: #52c41a; }\r\n.stat-value.danger { color: #f5222d; }\r\n\r\n.logs { background: #1e1e1e; color: #d4d4d4; padding: 15px; height: 180px; overflow-y: auto; border-radius: 8px; font-family: 'Consolas', monospace; font-size: 12px; }\r\n.log-item { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; }\r\n</style>"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}