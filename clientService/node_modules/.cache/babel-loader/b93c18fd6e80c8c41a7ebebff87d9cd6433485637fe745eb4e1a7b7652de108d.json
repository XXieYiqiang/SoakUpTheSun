{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"C:/Users/Administrator/Desktop/GimChat/gimChatVue/node_modules/@babel/runtime/helpers/interopRequireDefault.js\").default;\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\nrequire(\"core-js/modules/es.iterator.constructor.js\");\nrequire(\"core-js/modules/es.iterator.for-each.js\");\nvar _ws = _interopRequireDefault(require(\"@/plugins/ws\"));\nvar _default = exports.default = {\n  data() {\n    return {\n      // WebRTC / 视频\n      stream: null,\n      videoEl: null,\n      canvasEl: null,\n      ctx: null,\n      // WebSocket\n      ws: null,\n      wsReady: false,\n      // 定时器\n      captureTimer: null\n    };\n  },\n  computed: {},\n  mounted() {\n    this.videoEl = this.$refs.video;\n    this.canvasEl = this.$refs.canvas;\n    this.ctx = this.canvasEl.getContext('2d');\n  },\n  methods: {\n    /* ================= 摄像头 ================= */\n    async startCamera() {\n      this.stream = await navigator.mediaDevices.getUserMedia({\n        video: {\n          width: 640,\n          height: 480,\n          frameRate: {\n            ideal: 10,\n            max: 15\n          }\n        },\n        audio: false\n      });\n      this.videoEl.srcObject = this.stream;\n    },\n    stopCamera() {\n      if (!this.stream) return;\n      this.stream.getTracks().forEach(t => t.stop());\n      this.stream = null;\n    },\n    /* ================= WebSocket ================= */\n    initWS() {\n      return new Promise((resolve, reject) => {\n        this.ws = new WebSocket('ws://localhost:8080/video');\n        this.ws.binaryType = 'arraybuffer';\n        this.ws.onopen = () => {\n          this.wsReady = true;\n          resolve();\n        };\n        this.ws.onerror = err => {\n          this.wsReady = false;\n          reject(err);\n        };\n        this.ws.onclose = () => {\n          this.wsReady = false;\n        };\n      });\n    },\n    closeWS() {\n      if (this.ws) {\n        this.ws.close();\n        this.ws = null;\n      }\n    },\n    /* ================= 抽帧 ================= */\n    startCapture() {\n      this.canvasEl.width = 640;\n      this.canvasEl.height = 480;\n      this.captureTimer = setInterval(() => {\n        if (!this.wsReady) return;\n        if (this.ws.bufferedAmount > 2 * 1024 * 1024) return;\n        this.ctx.drawImage(this.videoEl, 0, 0, this.canvasEl.width, this.canvasEl.height);\n        this.canvasEl.toBlob(blob => {\n          blob && this.ws.send(blob);\n        }, 'image/jpeg', 0.6);\n      }, 100);\n    },\n    stopCapture() {\n      if (this.captureTimer) {\n        clearInterval(this.captureTimer);\n        this.captureTimer = null;\n      }\n    },\n    /* ================= 总控 ================= */\n    async start() {\n      try {\n        await this.startCamera();\n        // await this.initWS()\n\n        this.initWebSocket('111');\n        this.startCapture();\n      } catch (e) {\n        console.error('启动失败', e);\n        this.stop();\n      }\n    },\n    stop() {\n      this.stopCapture();\n      this.stopCamera();\n      this.closeWS();\n    }\n  },\n  beforeDestroy() {\n    this.stop();\n  }\n};","map":{"version":3,"names":["_ws","_interopRequireDefault","require","_default","exports","default","data","stream","videoEl","canvasEl","ctx","ws","wsReady","captureTimer","computed","mounted","$refs","video","canvas","getContext","methods","startCamera","navigator","mediaDevices","getUserMedia","width","height","frameRate","ideal","max","audio","srcObject","stopCamera","getTracks","forEach","t","stop","initWS","Promise","resolve","reject","WebSocket","binaryType","onopen","onerror","err","onclose","closeWS","close","startCapture","setInterval","bufferedAmount","drawImage","toBlob","blob","send","stopCapture","clearInterval","start","initWebSocket","e","console","error","beforeDestroy"],"sources":["src/views/utils/test.vue"],"sourcesContent":["<template>\r\n  <div class=\"chat-view\">\r\n\r\n    <!-- 视频采集区域 -->\r\n    <section class=\"video-box\">\r\n      <video ref=\"video\" autoplay muted playsinline />\r\n      <canvas ref=\"canvas\" style=\"display:none\" />\r\n\r\n      <div class=\"actions\">\r\n        <el-button type=\"primary\" @click=\"start\">开始</el-button>\r\n        <el-button type=\"danger\" @click=\"stop\">停止</el-button>\r\n      </div>\r\n    </section>\r\n  </div>\r\n</template>\r\n\r\n\r\n<script>\r\nimport WebSocketService from '@/plugins/ws';\r\nexport default {\r\n  data() {\r\n    return {\r\n      // WebRTC / 视频\r\n      stream: null,\r\n      videoEl: null,\r\n      canvasEl: null,\r\n      ctx: null,\r\n\r\n      // WebSocket\r\n      ws: null,\r\n      wsReady: false,\r\n\r\n      // 定时器\r\n      captureTimer: null\r\n    }\r\n  },\r\n\r\n  computed: {\r\n  },\r\n\r\n  mounted() {\r\n    this.videoEl = this.$refs.video\r\n    this.canvasEl = this.$refs.canvas\r\n    this.ctx = this.canvasEl.getContext('2d')\r\n  },\r\n\r\n  methods: {\r\n    /* ================= 摄像头 ================= */\r\n    async startCamera() {\r\n      this.stream = await navigator.mediaDevices.getUserMedia({\r\n        video: {\r\n          width: 640,\r\n          height: 480,\r\n          frameRate: { ideal: 10, max: 15 }\r\n        },\r\n        audio: false\r\n      })\r\n\r\n      this.videoEl.srcObject = this.stream\r\n    },\r\n\r\n    stopCamera() {\r\n      if (!this.stream) return\r\n      this.stream.getTracks().forEach(t => t.stop())\r\n      this.stream = null\r\n    },\r\n\r\n    /* ================= WebSocket ================= */\r\n    initWS() {\r\n      return new Promise((resolve, reject) => {\r\n        this.ws = new WebSocket('ws://localhost:8080/video')\r\n        this.ws.binaryType = 'arraybuffer'\r\n\r\n        this.ws.onopen = () => {\r\n          this.wsReady = true\r\n          resolve()\r\n        }\r\n\r\n        this.ws.onerror = err => {\r\n          this.wsReady = false\r\n          reject(err)\r\n        }\r\n\r\n        this.ws.onclose = () => {\r\n          this.wsReady = false\r\n        }\r\n      })\r\n    },\r\n\r\n    closeWS() {\r\n      if (this.ws) {\r\n        this.ws.close()\r\n        this.ws = null\r\n      }\r\n    },\r\n\r\n    /* ================= 抽帧 ================= */\r\n    startCapture() {\r\n      this.canvasEl.width = 640\r\n      this.canvasEl.height = 480\r\n\r\n      this.captureTimer = setInterval(() => {\r\n        if (!this.wsReady) return\r\n        if (this.ws.bufferedAmount > 2 * 1024 * 1024) return\r\n\r\n        this.ctx.drawImage(\r\n          this.videoEl,\r\n          0,\r\n          0,\r\n          this.canvasEl.width,\r\n          this.canvasEl.height\r\n        )\r\n\r\n        this.canvasEl.toBlob(blob => {\r\n          blob && this.ws.send(blob)\r\n        }, 'image/jpeg', 0.6)\r\n      }, 100)\r\n    },\r\n\r\n    stopCapture() {\r\n      if (this.captureTimer) {\r\n        clearInterval(this.captureTimer)\r\n        this.captureTimer = null\r\n      }\r\n    },\r\n\r\n    /* ================= 总控 ================= */\r\n    async start() {\r\n      try {\r\n        await this.startCamera()\r\n        // await this.initWS()\r\n\r\n        this.initWebSocket('111')\r\n        this.startCapture()\r\n      } catch (e) {\r\n        console.error('启动失败', e)\r\n        this.stop()\r\n      }\r\n    },\r\n\r\n    stop() {\r\n      this.stopCapture()\r\n      this.stopCamera()\r\n      this.closeWS()\r\n    }\r\n  },\r\n\r\n  beforeDestroy() {\r\n    this.stop()\r\n  }\r\n}\r\n\r\n</script>\r\n\r\n<style scoped></style>"],"mappings":";;;;;;;;;AAkBA,IAAAA,GAAA,GAAAC,sBAAA,CAAAC,OAAA;AAAA,IAAAC,QAAA,GAAAC,OAAA,CAAAC,OAAA,GACA;EACAC,KAAA;IACA;MACA;MACAC,MAAA;MACAC,OAAA;MACAC,QAAA;MACAC,GAAA;MAEA;MACAC,EAAA;MACAC,OAAA;MAEA;MACAC,YAAA;IACA;EACA;EAEAC,QAAA,GACA;EAEAC,QAAA;IACA,KAAAP,OAAA,QAAAQ,KAAA,CAAAC,KAAA;IACA,KAAAR,QAAA,QAAAO,KAAA,CAAAE,MAAA;IACA,KAAAR,GAAA,QAAAD,QAAA,CAAAU,UAAA;EACA;EAEAC,OAAA;IACA;IACA,MAAAC,YAAA;MACA,KAAAd,MAAA,SAAAe,SAAA,CAAAC,YAAA,CAAAC,YAAA;QACAP,KAAA;UACAQ,KAAA;UACAC,MAAA;UACAC,SAAA;YAAAC,KAAA;YAAAC,GAAA;UAAA;QACA;QACAC,KAAA;MACA;MAEA,KAAAtB,OAAA,CAAAuB,SAAA,QAAAxB,MAAA;IACA;IAEAyB,WAAA;MACA,UAAAzB,MAAA;MACA,KAAAA,MAAA,CAAA0B,SAAA,GAAAC,OAAA,CAAAC,CAAA,IAAAA,CAAA,CAAAC,IAAA;MACA,KAAA7B,MAAA;IACA;IAEA;IACA8B,OAAA;MACA,WAAAC,OAAA,EAAAC,OAAA,EAAAC,MAAA;QACA,KAAA7B,EAAA,OAAA8B,SAAA;QACA,KAAA9B,EAAA,CAAA+B,UAAA;QAEA,KAAA/B,EAAA,CAAAgC,MAAA;UACA,KAAA/B,OAAA;UACA2B,OAAA;QACA;QAEA,KAAA5B,EAAA,CAAAiC,OAAA,GAAAC,GAAA;UACA,KAAAjC,OAAA;UACA4B,MAAA,CAAAK,GAAA;QACA;QAEA,KAAAlC,EAAA,CAAAmC,OAAA;UACA,KAAAlC,OAAA;QACA;MACA;IACA;IAEAmC,QAAA;MACA,SAAApC,EAAA;QACA,KAAAA,EAAA,CAAAqC,KAAA;QACA,KAAArC,EAAA;MACA;IACA;IAEA;IACAsC,aAAA;MACA,KAAAxC,QAAA,CAAAgB,KAAA;MACA,KAAAhB,QAAA,CAAAiB,MAAA;MAEA,KAAAb,YAAA,GAAAqC,WAAA;QACA,UAAAtC,OAAA;QACA,SAAAD,EAAA,CAAAwC,cAAA;QAEA,KAAAzC,GAAA,CAAA0C,SAAA,CACA,KAAA5C,OAAA,EACA,GACA,GACA,KAAAC,QAAA,CAAAgB,KAAA,EACA,KAAAhB,QAAA,CAAAiB,MACA;QAEA,KAAAjB,QAAA,CAAA4C,MAAA,CAAAC,IAAA;UACAA,IAAA,SAAA3C,EAAA,CAAA4C,IAAA,CAAAD,IAAA;QACA;MACA;IACA;IAEAE,YAAA;MACA,SAAA3C,YAAA;QACA4C,aAAA,MAAA5C,YAAA;QACA,KAAAA,YAAA;MACA;IACA;IAEA;IACA,MAAA6C,MAAA;MACA;QACA,WAAArC,WAAA;QACA;;QAEA,KAAAsC,aAAA;QACA,KAAAV,YAAA;MACA,SAAAW,CAAA;QACAC,OAAA,CAAAC,KAAA,SAAAF,CAAA;QACA,KAAAxB,IAAA;MACA;IACA;IAEAA,KAAA;MACA,KAAAoB,WAAA;MACA,KAAAxB,UAAA;MACA,KAAAe,OAAA;IACA;EACA;EAEAgB,cAAA;IACA,KAAA3B,IAAA;EACA;AACA","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}