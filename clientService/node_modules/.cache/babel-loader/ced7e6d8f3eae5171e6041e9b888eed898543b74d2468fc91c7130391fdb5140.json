{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.map.js\";\nimport Vue from 'vue';\nimport router from '@/router/index';\nimport config from '@/config/index.js';\nimport { Message } from 'element-ui';\nimport { fileImgMap, unknownImg, fileSuffixCodeModeMap, markdownFileType } from '@/libs/map.js';\nimport { officeFileType } from '@/libs/map.js';\n\n// 全局函数 - 文件相关\nconst fileFunction = {\n  /**\r\n   * 格式化文件大小\r\n   * @param {number} size 文件大小\r\n   * @param {boolean} isInteger 是否只显示整数位，默认不截取\r\n   * @returns {string} 文件大小（带单位）\r\n   */\n  calculateFileSize(size, isInteger = false) {\n    const B = 1024;\n    const KB = Math.pow(1024, 2);\n    const MB = Math.pow(1024, 3);\n    const GB = Math.pow(1024, 4);\n    if (isInteger) {\n      // 截取为整数\n      if (size < B) {\n        return `${size}B`;\n      } else if (size < KB) {\n        return `${(size / B).toFixed(0)}KB`;\n      } else if (size < MB) {\n        return `${(size / KB).toFixed(0)}MB`;\n      } else if (size < GB) {\n        return `${(size / MB).toFixed(0)}GB`;\n      } else {\n        return `${(size / GB).toFixed(0)}TB`;\n      }\n    } else {\n      // 保留小数位\n      if (size < B) {\n        return `${size}B`;\n      } else if (size < KB) {\n        return `${(size / B).toFixed(0)}KB`;\n      } else if (size < MB) {\n        return `${(size / KB).toFixed(1)}MB`;\n      } else if (size < GB) {\n        return `${(size / MB).toFixed(2)}GB`;\n      } else {\n        return `${(size / GB).toFixed(3)}TB`;\n      }\n    }\n  },\n  /**\r\n   * 获取流式的缩略图、视频封面图\r\n   * @param {object} row 文件信息\r\n   * @returns {string} 流式图片\r\n   */\n  getMinImgStream(row) {\n    return `${config.baseContext}/filetransfer/preview?userFileId=${row.userFileId}&isMin=true&shareBatchNum=${row.shareBatchNum == null ? '' : row.shareBatchNum}&extractionCode=${row.extractionCode == null ? '' : row.extractionCode}`;\n  },\n  /**\r\n   * 获取文件查看路径\r\n   * @param {object} row 文件信息\r\n   * @returns {string} 文件路径\r\n   */\n  getViewFilePath(row) {\n    if (row.sourceType === undefined || row.sourceType === '' || row.sourceType === null) {\n      row.sourceType = '0';\n    }\n    if (row.sourceType === '0') {\n      return `${config.baseContext}/filetransfer/preview?userFileId=${row.userFileId}&isMin=false&shareBatchNum=${row.shareBatchNum == null ? '' : row.shareBatchNum}&extractionCode=${row.extractionCode == null ? '' : row.extractionCode}`;\n    } else {\n      //兼容知识库文件预览\n      return `${config.baseContext}/vectorFileInfo/preview?userFileId=${row.userFileId}\n\t\t\t\t&isMin=false&shareBatchNum=${row.shareBatchNum == null ? '' : row.shareBatchNum}\n\t\t\t\t&extractionCode=${row.extractionCode == null ? '' : row.extractionCode}\n\t\t\t\t&id=${row.id != null && row.id != undefined ? row.id : ''}`; // 条件添加 id 参数\n    }\n  },\n  /**\r\n   * 获取文件下载路径\r\n   * @param {object} row 文件信息\r\n   * @returns {string}  文件下载路径\r\n   */\n  getDownloadFilePath(row) {\n    return `${config.baseContext}/filetransfer/downloadfile?userFileId=${row.userFileId}&shareBatchNum=${row.shareBatchNum == null ? '' : row.shareBatchNum}&extractionCode=${row.extractionCode == null ? '' : row.extractionCode}`;\n  },\n  /**\r\n   * 获取 Onlyoffice 文件创建路径\r\n   * @param {object} row\r\n   * @returns {string} office 文件创建路径\r\n   */\n  createFileOnlineByOffice(data) {\n    let fileUrl = `${location.protocol}//${location.host}${config.baseContext}`;\n    const {\n      href\n    } = router.resolve({\n      name: 'Onlyoffice',\n      query: {\n        fileUrl: fileUrl,\n        fileName: data.fileName,\n        filePath: data.filePath,\n        extendName: data.extendName,\n        ot: 'add'\n      }\n    });\n    window.open(href, '_blank');\n  },\n  /**\r\n   * 获取 Onlyoffice 文件在线预览路径\r\n   * @param {object} row\r\n   * @returns {string} office 文件在线预览路径\r\n   */\n  getFileOnlineViewPathByOffice(row) {\n    let userFileId = row.userFileId;\n    const {\n      href\n    } = router.resolve({\n      name: 'Onlyoffice',\n      query: {\n        userFileId: userFileId,\n        ot: 'detail'\n      }\n    });\n    window.open(href, '_blank');\n  },\n  /**\r\n   * 获取 Onlyoffice 文件在线编辑路径\r\n   * @param {object} row\r\n   * @returns {string} office 文件在线编辑路径\r\n   */\n  getFileOnlineEditPathByOffice(row) {\n    let userFileId = row.userFileId;\n    const {\n      href\n    } = router.resolve({\n      name: 'Onlyoffice',\n      query: {\n        userFileId: userFileId,\n        ot: 'edit'\n      }\n    });\n    window.open(href, '_blank');\n  },\n  /**\r\n   * 获取分享链接\r\n   * @param {string} shareBatchNum\r\n   * @returns {string} 完整的分享链接\r\n   */\n  getShareLink(shareBatchNum) {\n    return `${location.protocol}//${location.host}/share/${shareBatchNum}`;\n  },\n  /**\r\n   * 复制分享链接\r\n   * @param {string} shareBatchNum\r\n   * @param {string} extractionCode\r\n   */\n  copyShareLink(shareBatchNum, extractionCode) {\n    let input = document.createElement('textarea'); // 直接构建textarea以保持换行\n    input.value = extractionCode === null ? `分享链接：${this.getShareLink(shareBatchNum)}\\n复制链接到浏览器中并输入提取码即可查看文件` : `分享链接：${this.getShareLink(shareBatchNum)}\\n提取码：${extractionCode}\\n复制链接到浏览器中并输入提取码即可查看文件`; // 设置内容\n    document.body.appendChild(input); // 添加临时实例\n    input.select(); // 选择实例内容\n    document.execCommand('Copy'); // 执行复制\n    document.body.removeChild(input); // 删除临时实例\n    Message.success('复制成功');\n  },\n  /**\r\n   * 根据文件扩展名设置文件图片\r\n   * @param {object} file 文件信息\r\n   */\n  setFileImg(file) {\n    if (file.isDir === 1) {\n      //  文件夹\n      return fileImgMap.get('dir');\n    } else if (Number(router.currentRoute.query.fileType) !== 6 && ['jpg', 'png', 'jpeg', 'gif', 'mp4'].includes(file.extendName.toLowerCase())) {\n      // 图片、视频类型，直接显示缩略图\n      return this.getMinImgStream(file);\n    } else if (fileImgMap.has(file.extendName.toLowerCase())) {\n      // 可以识别文件类型的文件\n      return fileImgMap.get(file.extendName.toLowerCase());\n    } else {\n      // 无法识别文件类型的文件\n      return unknownImg;\n    }\n  },\n  /**\r\n   * 判断是否是视频文件\r\n   * @param {object} file 文件信息\r\n   */\n  isVideoFile(file) {\n    if (['avi', 'mp4', 'mpg', 'mov', 'swf'].includes(file.extendName?.toLowerCase())) {\n      return true;\n    } else {\n      return false;\n    }\n  },\n  /**\r\n   * 图片预览\r\n   * @param {*} currentIndex 当前图片索引\r\n   * @param {*} imgInfo 单个图片信息\r\n   * @param {*} imgInfoList 多个图片列表\r\n   */\n  handleImgPreview(currentIndex, imgInfo = {}, imgInfoList = []) {\n    // 图片分类下 - 传递整个页面的图片列表；非图片分类下 - 由单个图片构建图片列表\n    console.log('图片预览 handleImgPreview');\n    const imgList = Number(router.currentRoute.query.fileType) === 1 ? imgInfoList.map(item => {\n      return {\n        ...item,\n        fileUrl: this.getViewFilePath(item),\n        downloadLink: this.getDownloadFilePath(item)\n      };\n    }) : [{\n      ...imgInfo,\n      fileUrl: this.getViewFilePath(imgInfo),\n      downloadLink: this.getDownloadFilePath(imgInfo)\n    }];\n    const defaultIndex = Number(router.currentRoute.query.fileType) === 1 ? currentIndex : 0;\n    console.log('imgList==');\n    console.log(imgList);\n    console.log('defaultIndex==' + defaultIndex);\n    Vue.prototype.$openBox.imgPreview({\n      imgList,\n      defaultIndex\n    });\n  },\n  /**\r\n   * 视频预览\r\n   * @param {*} currentIndex 当前视频索引\r\n   * @param {*} videoInfo 单个视频信息\r\n   * @param {*} videoInfoList 多个视频列表\r\n   */\n  handleVideoPreview(currentIndex, videoInfo = {}, videoInfoList = []) {\n    // 视频分类下 - 传递整个页面的视频列表；非视频分类下 - 由单个视频构建视频列表\n    const videoList = Number(router.currentRoute.query.fileType) === 3 ? videoInfoList.map(item => {\n      return {\n        ...item,\n        fileUrl: this.getViewFilePath(item),\n        downloadLink: this.getDownloadFilePath(item)\n      };\n    }) : [{\n      ...videoInfo,\n      fileUrl: this.getViewFilePath(videoInfo),\n      downloadLink: this.getDownloadFilePath(videoInfo)\n    }];\n    const defaultIndex = Number(router.currentRoute.query.fileType) === 3 ? currentIndex : 0;\n    Vue.prototype.$openBox.videoPreview({\n      videoList,\n      defaultIndex\n    });\n  },\n  /**\r\n   * 音频预览\r\n   * @param {*} currentIndex 当前音频索引\r\n   * @param {*} audioInfo 单个音频信息\r\n   * @param {*} audioInfoList 多个音频列表\r\n   */\n  handleAudioPreview(currentIndex, audioInfo = {}, audioInfoList = []) {\n    // 音频分类下 - 传递整个页面的音频列表；非音频分类下 - 由单个音频构建音频列表\n    const audioList = Number(router.currentRoute.query.fileType) === 4 ? audioInfoList.map(item => {\n      return {\n        ...item,\n        fileUrl: this.getViewFilePath(item),\n        downloadLink: this.getDownloadFilePath(item)\n      };\n    }) : [{\n      ...audioInfo,\n      fileUrl: this.getViewFilePath(audioInfo),\n      downloadLink: this.getDownloadFilePath(audioInfo)\n    }];\n    const defaultIndex = Number(router.currentRoute.query.fileType) === 4 ? currentIndex : 0;\n    Vue.prototype.$openBox.audioPreview({\n      audioList,\n      defaultIndex\n    });\n  },\n  /**\r\n   * 文件预览\r\n   * @description 若当前点击的为文件夹，则进入文件夹内部；若是文件，则进行相应的预览。\r\n   * @param {object} row 文件信息\r\n   * @param {number} currentIndex 当前文件索引\r\n   * @param {array} fileList 文件列表\r\n   */\n  handleFileNameClick(row, currentIndex, fileList = []) {\n    console.log('文件预览 ===');\n    console.log(row);\n    // 如果当前文件在回收站中，则不允许预览\n    if (row.deleteFlag !== undefined && row.deleteFlag !== 0) {\n      return false;\n    }\n    // 若是文件夹则进入该文件夹\n    if (row.isDir) {\n      console.log('需要点击进入文件夹');\n      if (router.currentRoute.name === 'Share') {\n        console.log('当前是查看他人分享列表的页面');\n        // 当前是查看他人分享列表的页面\n        router.push({\n          query: {\n            filePath: `${row.shareFilePath === '/' ? '' : row.shareFilePath}/${row.fileName}`\n          }\n        });\n      } else if (Number(router.currentRoute.query.fileType) === 8) {\n        // 当前是我的已分享列表页面\n        console.log('当前是查看他人分享列表的页面');\n        router.push({\n          query: {\n            fileType: 8,\n            filePath: `${row.shareFilePath === '/' ? '' : row.shareFilePath}/${row.fileName}`,\n            shareBatchNum: row.shareBatchNum\n          }\n        });\n      } else if (Number(router.currentRoute.query.fileType) !== 6) {\n        console.log('回收站页面不允许打开文件夹');\n        // 回收站页面不允许打开文件夹\n        // 网盘页面\n        console.log('row====');\n        console.log(row);\n        console.log(`${row.filePath === '/' ? '' : row.filePath}/${row.fileName}`);\n        router.push({\n          query: {\n            filePath: `${row.filePath === '/' ? '' : row.filePath}/${row.fileName}`,\n            fileType: 0\n          }\n        });\n      }\n    }\n    // 若是文件，则进行相应的预览\n    else {\n      console.log('文件扩展名：' + row.extendName.toLowerCase());\n      // 若当前点击项是图片\n      const PIC = ['png', 'jpg', 'jpeg', 'gif', 'svg'];\n      if (PIC.includes(row.extendName.toLowerCase())) {\n        console.log('图片预览操作');\n        this.handleImgPreview(currentIndex, row, fileList);\n        return false;\n      }\n      //  若当前点击项是可以使用office在线预览的\n      if ([...officeFileType].includes(row.extendName.toLowerCase())) {\n        this.getFileOnlineViewPathByOffice(row);\n        return false;\n      }\n      //  若当前点击项是pdf\n      if (row.extendName.toLowerCase() === 'pdf') {\n        window.open(this.getViewFilePath(row), '_blank');\n      }\n      //  若当前点击项是代码或文本文件\n      let codeFileSuffix = row.extendName.toLowerCase();\n      if (codeFileSuffix === 'yaml') {\n        codeFileSuffix = 'yml';\n      }\n      // 无格式文件也可以在线编辑\n      if (fileSuffixCodeModeMap.has(codeFileSuffix) || row.isDir === 0 && row.extendName === '') {\n        Vue.prototype.$openBox.codePreview({\n          fileInfo: row,\n          isEdit: false\n        });\n        return false;\n      }\n      //  若当前点击项是 markdown 文档\n      if (markdownFileType.includes(row.extendName.toLowerCase())) {\n        Vue.prototype.$openBox.markdownPreview({\n          fileInfo: row,\n          editable: false\n        });\n        return false;\n      }\n      //  若当前点击项是视频mp4格式\n      const VIDEO = ['mp4'];\n      if (VIDEO.includes(row.extendName.toLowerCase())) {\n        this.handleVideoPreview(currentIndex, row, fileList);\n        return false;\n      }\n      //  若当前点击项是音频 mp3、flac 格式\n      const AUDIO = ['mp3', 'flac'];\n      if (AUDIO.includes(row.extendName.toLowerCase())) {\n        this.handleAudioPreview(currentIndex, row, fileList);\n        return false;\n      }\n    }\n  },\n  /**\r\n   * 知识库处理文件预览，暂时不支持处理图片、音视频\r\n   */\n  handleKnowledgeFileNameClick(file) {\n    // 兼容性处理\n    file.extendName = file.fileType; //扩展名\n    file.userFileId = '111';\n    file.sourceType = '1';\n    //\n    // this.$message(`预览文件：${file.fileName}`)\n    console.log(`预览文件：${file.fileName}`);\n    console.log('文件类型：' + file.fileType);\n    const fileSuffix = (file.fileType || '').toLowerCase();\n    console.log('文件后缀：' + fileSuffix);\n\n    // 拦截图片、音频、视频类型，不处理\n    const IMAGE_TYPES = ['png', 'jpg', 'jpeg', 'gif', 'svg', 'xlsx', 'xls'];\n    const VIDEO_TYPES = ['mp4'];\n    const AUDIO_TYPES = ['mp3', 'flac'];\n    if (IMAGE_TYPES.includes(fileSuffix) || VIDEO_TYPES.includes(fileSuffix) || AUDIO_TYPES.includes(fileSuffix)) {\n      Message.error('该文件类型不支持预览');\n      return;\n    }\n\n    // PDF 文件新标签页打开\n    if (fileSuffix === 'pdf') {\n      window.open(this.getViewFilePath(file), '_blank');\n      return;\n    }\n\n    // 统一 yaml => yml\n    let codeSuffix = fileSuffix === 'yaml' ? 'yml' : fileSuffix;\n\n    // Markdown 文档\n    if (markdownFileType.includes(codeSuffix)) {\n      console.log('预览：Markdown 文档');\n      Vue.prototype.$openBox.markdownPreview({\n        fileInfo: file,\n        editable: false\n      });\n      return;\n    }\n\n    // 文本/代码类文件 或 无扩展名文件\n    if (fileSuffixCodeModeMap.has(codeSuffix) || !file.extendName) {\n      console.log('文本/代码类文件 或 无扩展名文件 在线预览');\n      Vue.prototype.$openBox.codePreview({\n        fileInfo: file,\n        isEdit: false\n      });\n      return;\n    }\n    Message.error('暂不支持该类型文件预览');\n  },\n  /**\r\n   * 文件名称拼接，包括文件名称 + 文件后缀\r\n   * @param {object} file 文件信息\r\n   * @param {boolean} isHighlight 是否需要展示高亮效果，默认不需要\r\n   * @returns {string} 完整文件名称\r\n   */\n  getFileNameComplete(file, isHighlight = false) {\n    return isHighlight === true && file.highlightFields ? `${file.highlightFields}${file.isDir === 0 && file.extendName ? `.${file.extendName}` : ''}` : `${file.fileName}${file.isDir === 0 && file.extendName ? `.${file.extendName}` : ''}`;\n  },\n  /**\r\n   * 文件类型\r\n   * @param {object} file 文件信息\r\n   */\n  getFileType(file) {\n    return file.isDir === 1 ? '文件夹' : file.extendName ? file.extendName : '文件';\n  },\n  /**\r\n   * 获取文件分享过期状态\r\n   * @param {string} time 日期\r\n   * @returns {boolean} 是否过期\r\n   */\n  getFileShareStatus(time) {\n    if (new Date(time).getTime() > new Date().getTime()) {\n      return false;\n    } else {\n      return true;\n    }\n  }\n};\nexport default fileFunction;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}