{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\nrequire(\"core-js/modules/es.array.push.js\");\nrequire(\"core-js/modules/es.iterator.constructor.js\");\nrequire(\"core-js/modules/es.iterator.find.js\");\nrequire(\"core-js/modules/es.iterator.for-each.js\");\nvar _default = exports.default = {\n  name: \"SFURoom\",\n  data() {\n    return {\n      wsUrl: \"ws://192.168.43.143:8080/room/join\",\n      roomID: \"ToRhXRHjv8MEMHn9RE8rLt\",\n      uid: \"user_\" + Math.floor(Math.random() * 1000),\n      joined: false,\n      loading: false,\n      logs: [],\n      ws: null,\n      localStream: null,\n      upPC: null,\n      // 推流 PC (PeerConnection)\n      downPC: null,\n      // 拉流 PC (单个 PC 接收房间内所有人的流)\n\n      // 存储远端流：{ \"user_123\": MediaStream 对象 }\n      remoteStreams: {},\n      isDownNegotiating: false,\n      // 协商锁\n      offerQueue: [],\n      // 协商任务队列\n\n      pendingCandidates: []\n    };\n  },\n  methods: {\n    log(msg) {\n      const time = new Date().toLocaleTimeString();\n      this.logs.unshift(`[${time}] ${msg}`);\n      if (this.logs.length > 50) this.logs.pop();\n      console.log(`[SFU] ${msg}`);\n    },\n    async joinRoom() {\n      if (!this.roomID || !this.uid) return alert(\"请输入房间号和UID\");\n      this.loading = true;\n      try {\n        // 1. 获取摄像头和麦克风\n        this.localStream = await navigator.mediaDevices.getUserMedia({\n          video: {\n            width: 640,\n            height: 360\n          },\n          audio: false\n        });\n        this.$refs.localVideo.srcObject = this.localStream;\n        this.log(\"本地媒体流就绪\");\n\n        // 2. 连接信令服务器\n        this.connectWebSocket();\n      } catch (e) {\n        this.log(\"无法获取摄像头: \" + e.message);\n        this.loading = false;\n      }\n    },\n    connectWebSocket() {\n      const url = `${this.wsUrl}?uid=${this.uid}&roomID=${this.roomID}`;\n      this.ws = new WebSocket(url);\n      this.ws.onopen = () => {\n        this.log(\"信令通道已连接\");\n        this.joined = true;\n        this.loading = false;\n        // 连接成功后开始推流\n        this.createUpstream();\n      };\n      this.ws.onmessage = event => {\n        const msg = JSON.parse(event.data);\n        this.handleSignal(msg);\n      };\n      this.ws.onclose = () => {\n        this.log(\"信令通道关闭\");\n        this.leaveRoom(false);\n      };\n    },\n    async handleSignal(msg) {\n      const {\n        event,\n        data\n      } = msg;\n      switch (event) {\n        case \"up_answer\":\n          await this.upPC.setRemoteDescription(new RTCSessionDescription({\n            type: 'answer',\n            sdp: data.sdp\n          }));\n          this.log(\"推流协商完成 (UpAnswer)\");\n          break;\n        case \"up_candidate\":\n          if (this.upPC) await this.upPC.addIceCandidate(data.candidate);\n          break;\n        case \"down_offer\":\n          // this.handleDownOffer(data);\n          // 将 Offer 放入队列处理，防止并发冲突\n          this.enqueueDownOffer(data);\n          break;\n        case \"down_candidate\":\n          // Candidate 必须在 RemoteDescription 设置后添加\n          this.handleRemoteCandidate(this.downPC, data.candidate);\n          // if (this.downPC) await this.downPC.addIceCandidate(data.candidate);\n          break;\n        case \"user_leave\":\n        case \"unpublish_stream\":\n          // 处理用户离开或停止推流\n          const targetId = data.uid || data.publisherId;\n          this.removeRemoteUser(targetId);\n          break;\n      }\n    },\n    // ================= 推流 (Publish) =================\n    async createUpstream() {\n      this.log(\"准备建立推流连接...\");\n      this.upPC = new RTCPeerConnection({\n        iceServers: [{\n          urls: \"stun:stun.l.google.com:19302\"\n        }]\n      });\n\n      // 添加轨道\n      this.localStream.getTracks().forEach(track => {\n        // this.upPC.addTrack(track, this.localStream);\n        if (track.kind === 'video') {\n          // ✅ 只添加视频\n          this.upPC.addTrack(track, this.localStream);\n        }\n      });\n      this.upPC.onicecandidate = e => {\n        if (e.candidate) this.sendSignal(\"up_candidate\", {\n          candidate: e.candidate\n        });\n      };\n      const offer = await this.upPC.createOffer();\n      await this.upPC.setLocalDescription(offer);\n      this.sendSignal(\"up_offer\", {\n        uid: this.uid,\n        sdp: offer.sdp\n      });\n    },\n    // ================= 拉流 (Subscribe) =================\n    async handleDownOffer(data) {\n      if (!this.downPC) this.initDownPC();\n      this.log(`收到订阅通知，来自流 ID: ${data.from}`);\n      try {\n        await this.downPC.setRemoteDescription(new RTCSessionDescription({\n          type: 'offer',\n          sdp: data.sdp\n        }));\n        const answer = await this.downPC.createAnswer();\n        await this.downPC.setLocalDescription(answer);\n        this.sendSignal(\"down_answer\", {\n          sdp: answer.sdp\n        });\n      } catch (e) {\n        this.log(\"拉流协商失败: \" + e.message);\n      }\n    },\n    // initDownPC() {\n    //   this.downPC = new RTCPeerConnection({\n    //     iceServers: [{ urls: \"stun:stun.l.google.com:19302\" }]\n    //   });\n\n    //   this.downPC.onicecandidate = (e) => {\n    //     if (e.candidate) this.sendSignal(\"down_candidate\", { candidate: e.candidate });\n    //   };\n\n    //   // 【核心逻辑】绑定远端流到 UID\n    //   this.downPC.ontrack = (event) => {\n    //     // 后端 NewTrackLocalStaticRTP 的 streamID 会出现在 event.streams[0].id\n    //     const stream = event.streams[0];\n    //     if (!stream) return;\n\n    //     console.log('stream=={}',stream)\n\n    //     const remoteUid = stream.id; \n    //     this.log(`检测到远端轨道 [${event.track.kind}], 归属用户: ${remoteUid}`);\n\n    //     // Vue 2 响应式更新：如果该 UID 对应的流不存在，则添加\n    //     if (!this.remoteStreams[remoteUid]) {\n    //       this.$set(this.remoteStreams, remoteUid, stream);\n    //     }\n    //   };\n    // },\n    // ✅ 队列化处理 Offer，确保顺序\n    async enqueueDownOffer(data) {\n      this.offerQueue.push(data);\n      if (this.isDownNegotiating) return;\n      while (this.offerQueue.length > 0) {\n        const currentOffer = this.offerQueue.shift();\n        await this.processDownOffer(currentOffer);\n      }\n    },\n    async processDownOffer(data) {\n      if (!this.downPC) this.initDownPC();\n      this.isDownNegotiating = true;\n      this.log(`开始处理协商: 来自 ${data.from}`);\n      try {\n        // 1. 设置远端描述\n        await this.downPC.setRemoteDescription(new RTCSessionDescription({\n          type: 'offer',\n          sdp: data.sdp\n        }));\n\n        // 2. 创建并设置本地 Answer\n        const answer = await this.downPC.createAnswer();\n        await this.downPC.setLocalDescription(answer);\n        while (this.pendingCandidates.length > 0) {\n          const cand = this.pendingCandidates.shift();\n          await this.handleRemoteCandidate(this.downPC, cand);\n        }\n\n        // 3. 反馈给后端\n        this.sendSignal(\"down_answer\", {\n          sdp: answer.sdp\n        });\n        this.log(\"协商成功，等待轨道同步...\");\n      } catch (e) {\n        this.log(\"协商流程异常: \" + e.message);\n      } finally {\n        // 给予浏览器一小段缓冲时间\n        await new Promise(resolve => setTimeout(resolve, 100));\n        this.isDownNegotiating = false;\n      }\n    },\n    async handleRemoteCandidate(pc, candidateInit) {\n      if (!candidateInit) return;\n\n      // 如果 PC 还没准备好远端描述，先存入队列\n      if (!pc || !pc.remoteDescription || !pc.remoteDescription.type) {\n        this.log(\"SDP 尚未就绪，缓存 Candidate\");\n        this.pendingCandidates.push(candidateInit);\n        return;\n      }\n      try {\n        await pc.addIceCandidate(new RTCIceCandidate(candidateInit));\n      } catch (e) {\n        console.error(\"添加 Candidate 失败\", e);\n      }\n    },\n    initDownPC() {\n      this.downPC = new RTCPeerConnection({\n        iceServers: [{\n          urls: \"stun:stun.l.google.com:19302\"\n        }]\n      });\n      this.downPC.onicecandidate = e => {\n        if (e.candidate) this.sendSignal(\"down_candidate\", {\n          candidate: e.candidate\n        });\n      };\n      this.downPC.ontrack = event => {\n        // 重点：获取 Stream ID\n        const stream = event.streams[0];\n        if (!stream) return;\n        const remoteUid = stream.id;\n        this.log(`轨道就绪 [${event.track.kind}] 用户: ${remoteUid}`);\n\n        // Vue 2 响应式更新\n        if (!this.remoteStreams[remoteUid]) {\n          this.$set(this.remoteStreams, remoteUid, stream);\n        } else {\n          // 如果流已存在，但新轨道（如视频）刚加进来，确保视图刷新\n          const oldStream = this.remoteStreams[remoteUid];\n          if (!oldStream.getTracks().find(t => t.id === event.track.id)) {\n            oldStream.addTrack(event.track);\n          }\n        }\n      };\n\n      // 监控连接状态\n      this.downPC.onconnectionstatechange = () => {\n        this.log(`连接状态变化: ${this.downPC.connectionState}`);\n      };\n    },\n    removeRemoteUser(uid) {\n      if (this.remoteStreams[uid]) {\n        this.log(`清理用户流: ${uid}`);\n        this.$delete(this.remoteStreams, uid);\n      }\n    },\n    sendSignal(event, data) {\n      if (this.ws?.readyState === WebSocket.OPEN) {\n        this.ws.send(JSON.stringify({\n          event,\n          data\n        }));\n      }\n    },\n    leaveRoom(closeWs = true) {\n      this.joined = false;\n      if (this.upPC) this.upPC.close();\n      if (this.downPC) this.downPC.close();\n      if (this.localStream) this.localStream.getTracks().forEach(t => t.stop());\n      if (closeWs && this.ws) this.ws.close();\n      this.remoteStreams = {};\n      this.upPC = null;\n      this.downPC = null;\n      this.log(\"已离开房间并清理资源\");\n    }\n  },\n  beforeDestroy() {\n    this.leaveRoom();\n  }\n};","map":{"version":3,"names":["name","data","wsUrl","roomID","uid","Math","floor","random","joined","loading","logs","ws","localStream","upPC","downPC","remoteStreams","isDownNegotiating","offerQueue","pendingCandidates","methods","log","msg","time","Date","toLocaleTimeString","unshift","length","pop","console","joinRoom","alert","navigator","mediaDevices","getUserMedia","video","width","height","audio","$refs","localVideo","srcObject","connectWebSocket","e","message","url","WebSocket","onopen","createUpstream","onmessage","event","JSON","parse","handleSignal","onclose","leaveRoom","setRemoteDescription","RTCSessionDescription","type","sdp","addIceCandidate","candidate","enqueueDownOffer","handleRemoteCandidate","targetId","publisherId","removeRemoteUser","RTCPeerConnection","iceServers","urls","getTracks","forEach","track","kind","addTrack","onicecandidate","sendSignal","offer","createOffer","setLocalDescription","handleDownOffer","initDownPC","from","answer","createAnswer","push","currentOffer","shift","processDownOffer","cand","Promise","resolve","setTimeout","pc","candidateInit","remoteDescription","RTCIceCandidate","error","ontrack","stream","streams","remoteUid","id","$set","oldStream","find","t","onconnectionstatechange","connectionState","$delete","readyState","OPEN","send","stringify","closeWs","close","stop","beforeDestroy"],"sources":["src/views/utils/test2.vue"],"sourcesContent":["<template>\r\n  <div class=\"sfu-room\">\r\n    <div class=\"controls\">\r\n      <h2>SFU 视频会议 (Vue 2 - ID 绑定版)</h2>\r\n      <div v-if=\"!joined\" class=\"login-form\">\r\n        <input v-model=\"roomID\" placeholder=\"房间号\" />\r\n        <input v-model=\"uid\" placeholder=\"我的UID\" />\r\n        <button @click=\"joinRoom\" :disabled=\"loading\">进入房间</button>\r\n      </div>\r\n      <div v-else class=\"actions\">\r\n        <span>房间: <b>{{ roomID }}</b> | 我的UID: <b>{{ uid }}</b></span>\r\n        <button class=\"btn-leave\" @click=\"leaveRoom\">离开房间</button>\r\n      </div>\r\n    </div>\r\n\r\n    <div class=\"video-grid\">\r\n      <div class=\"video-card local\">\r\n        <video ref=\"localVideo\" autoplay playsinline muted></video>\r\n        <div class=\"label\">我 ({{ uid }})</div>\r\n      </div>\r\n\r\n      <div v-for=\"(stream, remoteUid) in remoteStreams\" :key=\"remoteUid\" class=\"video-card remote\">\r\n        <video :src-object.prop=\"stream\" autoplay playsinline muted></video>\r\n        <div class=\"label\">\r\n          用户: {{ remoteUid }}\r\n          <span class=\"status-tag\">已同步</span>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <div class=\"logs\">\r\n      <div v-for=\"(log, i) in logs\" :key=\"i\" class=\"log-item\">\r\n        {{ log }}\r\n      </div>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nexport default {\r\n  name: \"SFURoom\",\r\n  data() {\r\n    return {\r\n      wsUrl: \"ws://192.168.43.143:8080/room/join\",\r\n      roomID: \"ToRhXRHjv8MEMHn9RE8rLt\",\r\n      uid: \"user_\" + Math.floor(Math.random() * 1000),\r\n\r\n      joined: false,\r\n      loading: false,\r\n      logs: [],\r\n\r\n      ws: null,\r\n      localStream: null,\r\n      upPC: null,   // 推流 PC (PeerConnection)\r\n      downPC: null, // 拉流 PC (单个 PC 接收房间内所有人的流)\r\n\r\n      // 存储远端流：{ \"user_123\": MediaStream 对象 }\r\n      remoteStreams: {},\r\n\r\n      isDownNegotiating: false, // 协商锁\r\n      offerQueue: [],           // 协商任务队列\r\n\r\n      pendingCandidates: []\r\n    };\r\n  },\r\n  methods: {\r\n    log(msg) {\r\n      const time = new Date().toLocaleTimeString();\r\n      this.logs.unshift(`[${time}] ${msg}`);\r\n      if (this.logs.length > 50) this.logs.pop();\r\n      console.log(`[SFU] ${msg}`);\r\n    },\r\n\r\n    async joinRoom() {\r\n      if (!this.roomID || !this.uid) return alert(\"请输入房间号和UID\");\r\n      this.loading = true;\r\n\r\n      try {\r\n        // 1. 获取摄像头和麦克风\r\n        this.localStream = await navigator.mediaDevices.getUserMedia({\r\n          video: { width: 640, height: 360 },\r\n          audio: false\r\n        });\r\n        this.$refs.localVideo.srcObject = this.localStream;\r\n        this.log(\"本地媒体流就绪\");\r\n\r\n        // 2. 连接信令服务器\r\n        this.connectWebSocket();\r\n      } catch (e) {\r\n        this.log(\"无法获取摄像头: \" + e.message);\r\n        this.loading = false;\r\n      }\r\n    },\r\n\r\n    connectWebSocket() {\r\n      const url = `${this.wsUrl}?uid=${this.uid}&roomID=${this.roomID}`;\r\n      this.ws = new WebSocket(url);\r\n\r\n      this.ws.onopen = () => {\r\n        this.log(\"信令通道已连接\");\r\n        this.joined = true;\r\n        this.loading = false;\r\n        // 连接成功后开始推流\r\n        this.createUpstream();\r\n      };\r\n\r\n      this.ws.onmessage = (event) => {\r\n        const msg = JSON.parse(event.data);\r\n        this.handleSignal(msg);\r\n      };\r\n\r\n      this.ws.onclose = () => {\r\n        this.log(\"信令通道关闭\");\r\n        this.leaveRoom(false);\r\n      };\r\n    },\r\n\r\n    async handleSignal(msg) {\r\n      const { event, data } = msg;\r\n\r\n      switch (event) {\r\n        case \"up_answer\":\r\n          await this.upPC.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: data.sdp }));\r\n          this.log(\"推流协商完成 (UpAnswer)\");\r\n          break;\r\n\r\n        case \"up_candidate\":\r\n          if (this.upPC) await this.upPC.addIceCandidate(data.candidate);\r\n          break;\r\n\r\n        case \"down_offer\":\r\n          // this.handleDownOffer(data);\r\n          // 将 Offer 放入队列处理，防止并发冲突\r\n          this.enqueueDownOffer(data);\r\n          break;\r\n\r\n        case \"down_candidate\":\r\n          // Candidate 必须在 RemoteDescription 设置后添加\r\n          this.handleRemoteCandidate(this.downPC, data.candidate);\r\n          // if (this.downPC) await this.downPC.addIceCandidate(data.candidate);\r\n          break;\r\n\r\n        case \"user_leave\":\r\n        case \"unpublish_stream\":\r\n          // 处理用户离开或停止推流\r\n          const targetId = data.uid || data.publisherId;\r\n          this.removeRemoteUser(targetId);\r\n          break;\r\n      }\r\n    },\r\n\r\n    // ================= 推流 (Publish) =================\r\n    async createUpstream() {\r\n      this.log(\"准备建立推流连接...\");\r\n      this.upPC = new RTCPeerConnection({\r\n        iceServers: [{ urls: \"stun:stun.l.google.com:19302\" }]\r\n      });\r\n\r\n      // 添加轨道\r\n      this.localStream.getTracks().forEach(track => {\r\n        // this.upPC.addTrack(track, this.localStream);\r\n        if (track.kind === 'video') { // ✅ 只添加视频\r\n          this.upPC.addTrack(track, this.localStream);\r\n        }\r\n      });\r\n\r\n      this.upPC.onicecandidate = (e) => {\r\n        if (e.candidate) this.sendSignal(\"up_candidate\", { candidate: e.candidate });\r\n      };\r\n\r\n      const offer = await this.upPC.createOffer();\r\n      await this.upPC.setLocalDescription(offer);\r\n      this.sendSignal(\"up_offer\", { uid: this.uid, sdp: offer.sdp });\r\n    },\r\n\r\n    // ================= 拉流 (Subscribe) =================\r\n    async handleDownOffer(data) {\r\n      if (!this.downPC) this.initDownPC();\r\n\r\n      this.log(`收到订阅通知，来自流 ID: ${data.from}`);\r\n\r\n      try {\r\n        await this.downPC.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: data.sdp }));\r\n        const answer = await this.downPC.createAnswer();\r\n        await this.downPC.setLocalDescription(answer);\r\n        this.sendSignal(\"down_answer\", { sdp: answer.sdp });\r\n      } catch (e) {\r\n        this.log(\"拉流协商失败: \" + e.message);\r\n      }\r\n    },\r\n\r\n    // initDownPC() {\r\n    //   this.downPC = new RTCPeerConnection({\r\n    //     iceServers: [{ urls: \"stun:stun.l.google.com:19302\" }]\r\n    //   });\r\n\r\n    //   this.downPC.onicecandidate = (e) => {\r\n    //     if (e.candidate) this.sendSignal(\"down_candidate\", { candidate: e.candidate });\r\n    //   };\r\n\r\n    //   // 【核心逻辑】绑定远端流到 UID\r\n    //   this.downPC.ontrack = (event) => {\r\n    //     // 后端 NewTrackLocalStaticRTP 的 streamID 会出现在 event.streams[0].id\r\n    //     const stream = event.streams[0];\r\n    //     if (!stream) return;\r\n\r\n    //     console.log('stream=={}',stream)\r\n\r\n    //     const remoteUid = stream.id; \r\n    //     this.log(`检测到远端轨道 [${event.track.kind}], 归属用户: ${remoteUid}`);\r\n\r\n    //     // Vue 2 响应式更新：如果该 UID 对应的流不存在，则添加\r\n    //     if (!this.remoteStreams[remoteUid]) {\r\n    //       this.$set(this.remoteStreams, remoteUid, stream);\r\n    //     }\r\n    //   };\r\n    // },\r\n    // ✅ 队列化处理 Offer，确保顺序\r\n    async enqueueDownOffer(data) {\r\n      this.offerQueue.push(data);\r\n      if (this.isDownNegotiating) return;\r\n\r\n      while (this.offerQueue.length > 0) {\r\n        const currentOffer = this.offerQueue.shift();\r\n        await this.processDownOffer(currentOffer);\r\n      }\r\n    },\r\n    async processDownOffer(data) {\r\n      if (!this.downPC) this.initDownPC();\r\n\r\n      this.isDownNegotiating = true;\r\n      this.log(`开始处理协商: 来自 ${data.from}`);\r\n\r\n      try {\r\n        // 1. 设置远端描述\r\n        await this.downPC.setRemoteDescription(new RTCSessionDescription({\r\n          type: 'offer',\r\n          sdp: data.sdp\r\n        }));\r\n\r\n        // 2. 创建并设置本地 Answer\r\n        const answer = await this.downPC.createAnswer();\r\n        await this.downPC.setLocalDescription(answer);\r\n\r\n        while (this.pendingCandidates.length > 0) {\r\n          const cand = this.pendingCandidates.shift();\r\n          await this.handleRemoteCandidate(this.downPC, cand);\r\n        }\r\n\r\n        // 3. 反馈给后端\r\n        this.sendSignal(\"down_answer\", { sdp: answer.sdp });\r\n        this.log(\"协商成功，等待轨道同步...\");\r\n      } catch (e) {\r\n        this.log(\"协商流程异常: \" + e.message);\r\n      } finally {\r\n        // 给予浏览器一小段缓冲时间\r\n        await new Promise(resolve => setTimeout(resolve, 100));\r\n        this.isDownNegotiating = false;\r\n      }\r\n    },\r\n    async handleRemoteCandidate(pc, candidateInit) {\r\n      if (!candidateInit) return;\r\n\r\n      // 如果 PC 还没准备好远端描述，先存入队列\r\n      if (!pc || !pc.remoteDescription || !pc.remoteDescription.type) {\r\n        this.log(\"SDP 尚未就绪，缓存 Candidate\");\r\n        this.pendingCandidates.push(candidateInit);\r\n        return;\r\n      }\r\n\r\n      try {\r\n        await pc.addIceCandidate(new RTCIceCandidate(candidateInit));\r\n      } catch (e) {\r\n        console.error(\"添加 Candidate 失败\", e);\r\n      }\r\n    },\r\n    initDownPC() {\r\n      this.downPC = new RTCPeerConnection({\r\n        iceServers: [{ urls: \"stun:stun.l.google.com:19302\" }]\r\n      });\r\n\r\n      this.downPC.onicecandidate = (e) => {\r\n        if (e.candidate) this.sendSignal(\"down_candidate\", { candidate: e.candidate });\r\n      };\r\n\r\n      this.downPC.ontrack = (event) => {\r\n        // 重点：获取 Stream ID\r\n        const stream = event.streams[0];\r\n        if (!stream) return;\r\n\r\n        const remoteUid = stream.id;\r\n        this.log(`轨道就绪 [${event.track.kind}] 用户: ${remoteUid}`);\r\n\r\n        // Vue 2 响应式更新\r\n        if (!this.remoteStreams[remoteUid]) {\r\n          this.$set(this.remoteStreams, remoteUid, stream);\r\n        } else {\r\n          // 如果流已存在，但新轨道（如视频）刚加进来，确保视图刷新\r\n          const oldStream = this.remoteStreams[remoteUid];\r\n          if (!oldStream.getTracks().find(t => t.id === event.track.id)) {\r\n            oldStream.addTrack(event.track);\r\n          }\r\n        }\r\n      };\r\n\r\n      // 监控连接状态\r\n      this.downPC.onconnectionstatechange = () => {\r\n        this.log(`连接状态变化: ${this.downPC.connectionState}`);\r\n      };\r\n    },\r\n\r\n    removeRemoteUser(uid) {\r\n      if (this.remoteStreams[uid]) {\r\n        this.log(`清理用户流: ${uid}`);\r\n        this.$delete(this.remoteStreams, uid);\r\n      }\r\n    },\r\n\r\n    sendSignal(event, data) {\r\n      if (this.ws?.readyState === WebSocket.OPEN) {\r\n        this.ws.send(JSON.stringify({ event, data }));\r\n      }\r\n    },\r\n\r\n    leaveRoom(closeWs = true) {\r\n      this.joined = false;\r\n      if (this.upPC) this.upPC.close();\r\n      if (this.downPC) this.downPC.close();\r\n      if (this.localStream) this.localStream.getTracks().forEach(t => t.stop());\r\n      if (closeWs && this.ws) this.ws.close();\r\n      this.remoteStreams = {};\r\n      this.upPC = null;\r\n      this.downPC = null;\r\n      this.log(\"已离开房间并清理资源\");\r\n    }\r\n  },\r\n  beforeDestroy() {\r\n    this.leaveRoom();\r\n  }\r\n};\r\n</script>\r\n\r\n<style scoped>\r\n.sfu-room {\r\n  font-family: sans-serif;\r\n  padding: 20px;\r\n  background: #f4f7f9;\r\n  min-height: 100vh;\r\n}\r\n\r\n.controls {\r\n  background: white;\r\n  padding: 15px;\r\n  border-radius: 8px;\r\n  margin-bottom: 20px;\r\n  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);\r\n}\r\n\r\n.login-form input {\r\n  padding: 8px;\r\n  margin-right: 10px;\r\n  border: 1px solid #ccc;\r\n  border-radius: 4px;\r\n}\r\n\r\nbutton {\r\n  padding: 8px 16px;\r\n  background: #007bff;\r\n  color: white;\r\n  border: none;\r\n  border-radius: 4px;\r\n  cursor: pointer;\r\n}\r\n\r\nbutton:hover {\r\n  background: #0056b3;\r\n}\r\n\r\n.btn-leave {\r\n  background: #dc3545;\r\n  margin-left: 10px;\r\n}\r\n\r\n.video-grid {\r\n  display: grid;\r\n  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));\r\n  gap: 20px;\r\n}\r\n\r\n.video-card {\r\n  background: #1a1a1a;\r\n  border-radius: 10px;\r\n  overflow: hidden;\r\n  aspect-ratio: 16/9;\r\n  position: relative;\r\n}\r\n\r\nvideo {\r\n  width: 100%;\r\n  height: 100%;\r\n  object-fit: cover;\r\n}\r\n\r\n.local video {\r\n  transform: scaleX(-1);\r\n}\r\n\r\n.label {\r\n  position: absolute;\r\n  bottom: 10px;\r\n  left: 10px;\r\n  background: rgba(0, 0, 0, 0.7);\r\n  color: white;\r\n  padding: 4px 10px;\r\n  border-radius: 20px;\r\n  font-size: 12px;\r\n  display: flex;\r\n  align-items: center;\r\n}\r\n\r\n.status-tag {\r\n  margin-left: 8px;\r\n  color: #4caf50;\r\n  font-weight: bold;\r\n}\r\n\r\n.logs {\r\n  margin-top: 30px;\r\n  background: #222;\r\n  color: #00ff00;\r\n  padding: 15px;\r\n  height: 200px;\r\n  overflow-y: auto;\r\n  font-family: monospace;\r\n  font-size: 12px;\r\n  border-radius: 5px;\r\n}\r\n\r\n.log-item {\r\n  margin-bottom: 4px;\r\n  border-bottom: 1px solid #333;\r\n  padding-bottom: 2px;\r\n}\r\n</style>"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}