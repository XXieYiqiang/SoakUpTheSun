{"ast":null,"code":"import SparkMD5 from 'spark-md5';\nexport default {\n  name: 'FileUploader',\n  data() {\n    return {\n      filesLength: 0,\n      dropBoxShow: false,\n      collapse: false,\n      panelShow: true,\n      uploadStatus: {},\n      options: {\n        target: `/api/filetransfer/uploadfile`,\n        chunkSize: 1024 * 1024,\n        fileParameterName: 'file',\n        maxChunkRetries: 3,\n        testChunks: true,\n        checkChunkUploadedByResponse: function (chunk, message) {\n          let data = JSON.parse(message).data;\n          if (data.skipUpload) return true;\n          return (data.uploaded || []).indexOf(chunk.offset + 1) >= 0;\n        },\n        headers: {\n          token: '123'\n        },\n        query() {}\n      },\n      attrs: {\n        accept: '*'\n      },\n      fileStatusText: {\n        success: '上传成功',\n        error: 'error',\n        uploading: '上传中',\n        paused: '暂停中',\n        waiting: '等待中'\n      }\n    };\n  },\n  computed: {\n    uploaderInstance() {\n      return this.$refs.uploader.uploader;\n    }\n  },\n  methods: {\n    handleFileSuccess(rootFile, file, response) {\n      const result = JSON.parse(response || '{}');\n      if (!response || result.code !== 200 || result.data.uploaded.at(-1) !== result.data.uploaded.length) {\n        this.$message.error(result.message || '上传失败');\n        this.uploadStatus[file.id] = '上传失败';\n        return;\n      }\n      this.filesLength--;\n    },\n    handleFileError(rootFile, file, response) {\n      this.$message.error(response);\n    },\n    handleFilesAdded(files) {\n      this.computeMD5(files);\n    },\n    computeMD5(file) {\n      const fileReader = new FileReader();\n      const blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice;\n      const chunkSize = 1 * 1024 * 1024;\n      const chunks = Math.ceil(file.size / chunkSize);\n      let currentChunk = 0;\n      const spark = new SparkMD5.ArrayBuffer();\n      this.uploadStatus[file.id] = '计算MD5';\n      file.pause();\n      fileReader.onload = e => {\n        spark.append(e.target.result);\n        if (++currentChunk < chunks) {\n          loadNext();\n          this.uploadStatus[file.id] = `校验MD5 ${(currentChunk / chunks * 100).toFixed(0)}%`;\n          this.uploadStatus = JSON.parse(JSON.stringify(this.uploadStatus));\n        } else {\n          this.calculateFileMD5End(spark.end(), file);\n        }\n      };\n      fileReader.onerror = () => {\n        this.$notify.error({\n          title: '错误',\n          message: `文件${file.name}读取出错，请检查该文件`,\n          duration: 2000\n        });\n        file.cancel();\n      };\n      const loadNext = () => {\n        const start = currentChunk * chunkSize;\n        const end = start + chunkSize >= file.size ? file.size : start + chunkSize;\n        fileReader.readAsArrayBuffer(blobSlice.call(file.file, start, end));\n      };\n      loadNext();\n    },\n    calculateFileMD5End(md5, file) {\n      Object.assign(this.uploaderInstance.opts, {\n        query: {\n          ...this.params\n        }\n      });\n      file.uniqueIdentifier = md5;\n      file.resume();\n      this.uploadStatus[file.id] = '';\n      this.uploadStatus = JSON.parse(JSON.stringify(this.uploadStatus));\n    },\n    handleClosePanel() {\n      this.uploaderInstance.cancel();\n      this.panelShow = false;\n      this.$emit('cancel');\n    }\n  }\n};","map":{"version":3,"names":["SparkMD5","name","data","filesLength","dropBoxShow","collapse","panelShow","uploadStatus","options","target","chunkSize","fileParameterName","maxChunkRetries","testChunks","checkChunkUploadedByResponse","chunk","message","JSON","parse","skipUpload","uploaded","indexOf","offset","headers","token","query","attrs","accept","fileStatusText","success","error","uploading","paused","waiting","computed","uploaderInstance","$refs","uploader","methods","handleFileSuccess","rootFile","file","response","result","code","at","length","$message","id","handleFileError","handleFilesAdded","files","computeMD5","fileReader","FileReader","blobSlice","File","prototype","slice","mozSlice","webkitSlice","chunks","Math","ceil","size","currentChunk","spark","ArrayBuffer","pause","onload","e","append","loadNext","toFixed","stringify","calculateFileMD5End","end","onerror","$notify","title","duration","cancel","start","readAsArrayBuffer","call","md5","Object","assign","opts","params","uniqueIdentifier","resume","handleClosePanel","$emit"],"sources":["src/components/FileUploader.vue"],"sourcesContent":["<template>\r\n  <el-card>\r\n    <uploader ref=\"uploader\" :options=\"options\" :fileStatusText=\"fileStatusText\" @file-added=\"handleFilesAdded\"\r\n      @file-error=\"handleFileError\" @file-success=\"handleFileSuccess\" :autoStart=\"false\">\r\n      <uploader-unsupport></uploader-unsupport>\r\n      <uploader-btn class=\"select-file-btn\" :attrs=\"attrs\" ref=\"uploadBtn\">选择文件</uploader-btn>\r\n      <uploader-list v-show=\"panelShow\">\r\n        <template v-slot:default=\"props\">\r\n          <div class=\"file-panel\">\r\n            <div class=\"file-title\">\r\n              <span class=\"title-span\">\r\n                上传列表<span class=\"count\">（{{ props.fileList.length }}）</span>\r\n              </span>\r\n              <div class=\"operate\">\r\n                <el-button type=\"text\" :title=\"collapse ? '展开' : '折叠'\"\r\n                  :icon=\"collapse ? 'el-icon-full-screen' : 'el-icon-minus'\"\r\n                  @click=\"collapse = !collapse\">\r\n                </el-button>\r\n                <el-button @click=\"handleClosePanel\" type=\"text\" title=\"关闭\" icon=\"el-icon-close\"></el-button>\r\n              </div>\r\n            </div>\r\n            <el-collapse-transition>\r\n              <ul class=\"file-list\" v-show=\"!collapse\">\r\n                <li class=\"file-item\" :class=\"{ 'custom-status-item': uploadStatus[file.id] !== '' }\"\r\n                    v-for=\"file in props.fileList\" :key=\"file.id\">\r\n                  <uploader-file ref=\"fileItem\" :file=\"file\" :list=\"true\"></uploader-file>\r\n                  <span class=\"custom-status\">{{ uploadStatus[file.id] }}</span>\r\n                </li>\r\n                <div class=\"no-file\" v-if=\"!props.fileList.length\">\r\n                  <i class=\"icon-empty-file\"></i> 暂无待上传文件\r\n                </div>\r\n              </ul>\r\n            </el-collapse-transition>\r\n          </div>\r\n        </template>\r\n      </uploader-list>\r\n    </uploader>\r\n  </el-card>\r\n</template>\r\n\r\n<script>\r\nimport SparkMD5 from 'spark-md5';\r\n\r\nexport default {\r\n  name: 'FileUploader',\r\n  data() {\r\n    return {\r\n      filesLength: 0,\r\n      dropBoxShow: false,\r\n      collapse: false,\r\n      panelShow: true,\r\n      uploadStatus: {},\r\n      options: {\r\n        target: `/api/filetransfer/uploadfile`,\r\n        chunkSize: 1024 * 1024,\r\n        fileParameterName: 'file',\r\n        maxChunkRetries: 3,\r\n        testChunks: true,\r\n        checkChunkUploadedByResponse: function (chunk, message) {\r\n          let data = JSON.parse(message).data;\r\n          if (data.skipUpload) return true;\r\n          return (data.uploaded || []).indexOf(chunk.offset + 1) >= 0;\r\n        },\r\n        headers: {\r\n          token: '123'\r\n        },\r\n        query() { }\r\n      },\r\n      attrs: {\r\n        accept: '*'\r\n      },\r\n      fileStatusText: {\r\n        success: '上传成功',\r\n        error: 'error',\r\n        uploading: '上传中',\r\n        paused: '暂停中',\r\n        waiting: '等待中'\r\n      },\r\n    }\r\n  },\r\n  computed: {\r\n    uploaderInstance() {\r\n      return this.$refs.uploader.uploader;\r\n    },\r\n  },\r\n  methods: {\r\n    handleFileSuccess(rootFile, file, response) {\r\n      const result = JSON.parse(response || '{}');\r\n      if (!response || result.code !== 200 || result.data.uploaded.at(-1) !== result.data.uploaded.length) {\r\n        this.$message.error(result.message || '上传失败');\r\n        this.uploadStatus[file.id] = '上传失败';\r\n        return;\r\n      }\r\n      this.filesLength--;\r\n    },\r\n    handleFileError(rootFile, file, response) {\r\n      this.$message.error(response);\r\n    },\r\n    handleFilesAdded(files) {\r\n      this.computeMD5(files);\r\n    },\r\n    computeMD5(file) {\r\n      const fileReader = new FileReader();\r\n      const blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice;\r\n      const chunkSize = 1 * 1024 * 1024;\r\n      const chunks = Math.ceil(file.size / chunkSize);\r\n      let currentChunk = 0;\r\n      const spark = new SparkMD5.ArrayBuffer();\r\n      this.uploadStatus[file.id] = '计算MD5';\r\n      file.pause();\r\n\r\n      fileReader.onload = (e) => {\r\n        spark.append(e.target.result);\r\n        if (++currentChunk < chunks) {\r\n          loadNext();\r\n          this.uploadStatus[file.id] = `校验MD5 ${(currentChunk / chunks * 100).toFixed(0)}%`;\r\n          this.uploadStatus = JSON.parse(JSON.stringify(this.uploadStatus));\r\n        } else {\r\n          this.calculateFileMD5End(spark.end(), file);\r\n        }\r\n      };\r\n\r\n      fileReader.onerror = () => {\r\n        this.$notify.error({ title: '错误', message: `文件${file.name}读取出错，请检查该文件`, duration: 2000 });\r\n        file.cancel();\r\n      };\r\n\r\n      const loadNext = () => {\r\n        const start = currentChunk * chunkSize;\r\n        const end = start + chunkSize >= file.size ? file.size : start + chunkSize;\r\n        fileReader.readAsArrayBuffer(blobSlice.call(file.file, start, end));\r\n      };\r\n\r\n      loadNext();\r\n    },\r\n    calculateFileMD5End(md5, file) {\r\n      Object.assign(this.uploaderInstance.opts, {\r\n        query: {\r\n          ...this.params\r\n        }\r\n      });\r\n      file.uniqueIdentifier = md5;\r\n      file.resume();\r\n      this.uploadStatus[file.id] = '';\r\n      this.uploadStatus = JSON.parse(JSON.stringify(this.uploadStatus));\r\n    },\r\n    handleClosePanel() {\r\n      this.uploaderInstance.cancel();\r\n      this.panelShow = false;\r\n      this.$emit('cancel');\r\n    }\r\n  },\r\n};\r\n</script>\r\n\r\n<style lang=\"less\" scoped>\r\n/* 样式略，与原文件相同 */\r\n</style>\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}