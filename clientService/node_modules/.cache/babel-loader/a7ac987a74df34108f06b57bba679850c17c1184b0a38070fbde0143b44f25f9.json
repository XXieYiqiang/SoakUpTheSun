{"ast":null,"code":"/**\r\n * WebSocketService å°è£…ç±»\r\n * - è‡ªåŠ¨é‡è¿\r\n * - å¿ƒè·³æœºåˆ¶\r\n * - ç»Ÿä¸€æ¶ˆæ¯åˆ†å‘åˆ° Vuex\r\n */\n\nimport store from '@/store'; // è·¯å¾„æ ¹æ®ä½ çš„é¡¹ç›®è°ƒæ•´\nimport { handleLogout } from '@/api/user';\nclass WebSocketService {\n  constructor(store) {\n    this.store = store;\n    this.socket = null;\n    this.userId = null;\n    this.reconnectInterval = 5000;\n    this.heartbeatInterval = 30000;\n    this.heartbeatTimer = null;\n  }\n\n  /**\r\n   * å»ºç«‹ WebSocket è¿æ¥\r\n   * @param {string} userId å½“å‰ç™»å½•ç”¨æˆ· ID\r\n   */\n  connect(userId) {\n    this.userId = userId;\n    const url = `ws://127.0.0.1:8888/ws?userId=${encodeURIComponent(userId)}`;\n    console.log(`[WebSocket][è¿æ¥] æ­£åœ¨è¿æ¥ userId=${userId} åœ°å€: ${url}`);\n    this.socket = new WebSocket(url);\n    this.socket.onopen = () => {\n      console.log(`[WebSocket][âœ… æˆåŠŸ] ç”¨æˆ· ${userId} è¿æ¥å·²å»ºç«‹`);\n      this.send({\n        cmd: 100003,\n        data: {}\n      });\n      this.startHeartbeat();\n    };\n    this.socket.onmessage = event => {\n      try {\n        console.log(`[WebSocket][ğŸ“© åŸå§‹æ•°æ®] ${event.data}`);\n        const data = JSON.parse(event.data);\n        console.log(`[WebSocket][ğŸ“¥ å·²è§£æ] cmd=${data.cmd}`, data);\n        this.handleMessage(data);\n      } catch (err) {\n        console.error('[WebSocket][âŒ è§£æå¤±è´¥]', event.data, err);\n      }\n    };\n    this.socket.onclose = () => {\n      console.warn(`[WebSocket][âš ï¸ å…³é—­] è¿æ¥å·²å…³é—­ï¼Œ5ç§’åé‡è¿ userId=${userId}`);\n      this.reconnect();\n    };\n    this.socket.onerror = err => {\n      console.error('[WebSocket][âŒ é”™è¯¯] è¿æ¥å¼‚å¸¸:', err);\n      this.socket.close(); // è§¦å‘ onclose -> reconnect\n\n      // è¿æ¥å¤±è´¥ååšç™»å‡ºæ“ä½œï¼Œæ›´æ–°ç”¨æˆ·åœ¨çº¿çŠ¶æ€\n      // è·å–ç”¨æˆ·ä¿¡æ¯\n      const userInfo = store.getters['user/userInfo'];\n      console.log('userInfo===');\n      console.log(userInfo);\n      if (userInfo) {\n        const param = {\n          userId: userInfo.userId\n        };\n        handleLogout(param).then(res => {\n          console.log(\"ç”¨æˆ·è¿æ¥å¤±è´¥ååšç™»å‡ºæ“ä½œï¼Œæ›´æ–° æ•°æ®åº“ç”¨æˆ·åœ¨çº¿çŠ¶æ€\");\n        });\n        store.dispatch('user/logout');\n      }\n    };\n  }\n\n  /**\r\n   * è‡ªåŠ¨é‡è¿\r\n   */\n  reconnect() {\n    if (!this.userId) {\n      console.warn('[WebSocket][âš ï¸ é‡è¿å–æ¶ˆ] userId ä¸ºç©º');\n      return;\n    }\n    setTimeout(() => {\n      console.log(`[WebSocket][ğŸ”„ é‡è¿ä¸­] æ­£åœ¨å°è¯•é‡æ–°è¿æ¥ userId=${this.userId}...`);\n      this.connect(this.userId);\n    }, this.reconnectInterval);\n  }\n\n  /**\r\n   * å¯åŠ¨å¿ƒè·³åŒ…\r\n   */\n  startHeartbeat() {\n    if (this.heartbeatTimer) clearInterval(this.heartbeatTimer);\n    this.heartbeatTimer = setInterval(() => {\n      const ping = {\n        cmd: 100002,\n        timestamp: Date.now(),\n        data: {}\n      };\n      console.log('[WebSocket][ğŸŸ¢ å¿ƒè·³] å‘é€ ping:', ping);\n      this.send(ping);\n      this.send({\n        cmd: 100003,\n        data: {}\n      });\n    }, this.heartbeatInterval);\n  }\n\n  /**\r\n   * å‘é€æ¶ˆæ¯\r\n   */\n  send(data) {\n    if (this.socket && this.socket.readyState === WebSocket.OPEN) {\n      const str = JSON.stringify(data);\n      console.log('[WebSocket][ğŸ“¤ å‘é€]', str);\n      this.socket.send(str);\n    } else {\n      console.warn('[WebSocket][âš ï¸ æœªè¿æ¥] å½“å‰è¿æ¥ä¸å¯ç”¨ï¼Œå‘é€å¤±è´¥');\n    }\n  }\n\n  /**\r\n   * æ´¾å‘æ¶ˆæ¯åˆ° Vuex\r\n   */\n  handleMessage(msg) {\n    console.log(`[WebSocket][ğŸ“¬ åˆ†å‘] æ´¾å‘è‡³ messageDispatcher: cmd=${msg.cmd}`);\n    this.store.dispatch('messageDispatcher/dispatch', msg);\n  }\n\n  /**\r\n   * æ‰‹åŠ¨å…³é—­è¿æ¥ï¼ˆç”¨äºæ³¨é”€/åˆ‡æ¢ç”¨æˆ·ï¼‰\r\n   */\n  close() {\n    console.log('[WebSocket][â å…³é—­] æ‰‹åŠ¨å…³é—­è¿æ¥');\n    if (this.socket) {\n      this.socket.close();\n      this.socket = null;\n    }\n    clearInterval(this.heartbeatTimer);\n  }\n}\nexport default WebSocketService;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}