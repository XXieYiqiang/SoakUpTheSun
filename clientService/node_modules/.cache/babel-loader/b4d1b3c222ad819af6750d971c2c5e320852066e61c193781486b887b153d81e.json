{"ast":null,"code":"/**\r\n * ğŸ“¨ æ¶ˆæ¯åˆ†å‘å™¨æ¨¡å—\r\n * - WebSocket æ”¶åˆ°çš„æ¶ˆæ¯å°†ç»Ÿä¸€ç”±è¿™é‡Œåˆ†ç±»åˆ†å‘\r\n * - æ”¯æŒç§èŠã€ç¾¤èŠã€ç³»ç»Ÿé€šçŸ¥ã€å…¨ç«™å¹¿æ’­ã€ping ç­‰ç±»å‹\r\n */\n\n// store/modules/messageDispatcher.js\nimport WebSocketService from '@/plugins/ws'; // âœ… æ­£ç¡®\nexport default {\n  namespaced: true,\n  actions: {\n    /**\r\n     * ğŸ”§ æ¶ˆæ¯æ€»å…¥å£\r\n     * @param {Object} message WebSocket æ¥æ”¶åˆ°çš„åŸå§‹æ¶ˆæ¯å¯¹è±¡\r\n     */\n    dispatch({\n      dispatch\n    }, content) {\n      const {\n        cmd,\n        message,\n        data\n      } = content;\n      console.log(`[Dispatcher] ğŸ“© æ”¶åˆ°æ¶ˆæ¯ç±»å‹: ${cmd}`, data);\n      switch (cmd) {\n        case 111111:\n          console.log(\"å“åº”æˆåŠŸï¼š\" + message);\n          break;\n        // å“åº”æ¶ˆæ¯\n        case 100001:\n          dispatch('handleChatMessage', data);\n          break;\n        //å¤„ç†æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨å“åº”\n        case 1100003:\n          dispatch('handleUserList', data);\n        //åç«¯æ¨é€ï¼šéœ€è¦æ›´æ–°æŸ¥è¯¢åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ä¿¡æ¯  \n        case 1100005:\n          dispatch('updateOnlineUserInfoList', data);\n        case 'chat':\n          dispatch('handleChatMessage', data);\n          break;\n        case 'system':\n          dispatch('handleSystemMessage', data);\n          break;\n        case 'broadcast':\n          dispatch('handleBroadcast', data);\n          break;\n        case 'ping':\n          // å¿ƒè·³å“åº”ï¼ˆå¯é€‰ï¼‰\n          console.log('[Dispatcher] ğŸ’“ æ”¶åˆ° ping å¿ƒè·³');\n          break;\n        default:\n          console.warn('[Dispatcher] âš ï¸ æœªçŸ¥æ¶ˆæ¯ç±»å‹:', cmd, data);\n      }\n    },\n    /**\r\n     * å¤„ç†ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢\r\n     */\n    handleUserList({\n      commit,\n      rootState\n    }, data) {\n      console.log('[Dispatcher] âœ… æ¥æ”¶åˆ°ç”¨æˆ·åˆ—è¡¨:', data);\n      commit('message/SET_USER_LIST', data, {\n        root: true\n      });\n    },\n    /**\r\n     * ğŸ’¬ å¤„ç†ç§èŠ / ç¾¤èŠæ¶ˆæ¯\r\n     * - åˆ¤æ–­æ˜¯å½“å‰èŠå¤©å¯¹è±¡å°±ç›´æ¥å±•ç¤º\r\n     * - å¦åˆ™å¢åŠ æœªè¯»æ•°\r\n     */\n    handleChatMessage({\n      commit,\n      rootState\n    }, data) {\n      const currentId = rootState.chat?.currentContactId;\n      const contactId = data.targetType === 'user' ? data.senderId : data.receiverId;\n      console.log(`[Dispatcher] ğŸ’¬ æ¥è‡ª ${data.targetType === 'user' ? 'ç§èŠ' : 'ç¾¤èŠ'} æ¶ˆæ¯: ${contactId}`, data);\n\n      // æ·»åŠ æ¶ˆæ¯åˆ° Vuex message æ¨¡å—\n      commit('message/ADD_MESSAGE', {\n        contactId,\n        message: data\n      }, {\n        root: true\n      });\n\n      // å½“å‰æ­£åœ¨èŠå¤©çª—å£ä¸æ˜¯è¯¥ä¼šè¯ï¼Œå¢åŠ æœªè¯»æ•°\n      if (contactId !== currentId) {\n        console.log(`[Dispatcher] ğŸ”´ ${contactId} ä¸æ˜¯å½“å‰çª—å£ï¼Œå¢åŠ æœªè¯»æ•°`);\n        commit('message/INCREMENT_UNREAD', contactId, {\n          root: true\n        });\n      } else {\n        console.log(`[Dispatcher] ğŸŸ¢ å½“å‰çª—å£æ¶ˆæ¯ï¼Œè‡ªåŠ¨å·²è¯»`);\n        commit('message/RESET_UNREAD', contactId, {\n          root: true\n        });\n      }\n    },\n    /**\r\n     * æ¨é€æ›´æ–°ï¼šæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨\r\n     */\n    updateOnlineUserInfoList({\n      commit,\n      rootState\n    }, data) {\n      console.log('æ¨é€æ›´æ–°æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨');\n      const webService = new WebSocketService(this.$store);\n      webService.send({\n        cmd: 100003,\n        data: {}\n      });\n    },\n    /**\r\n     * ğŸ“¢ å¤„ç†ç³»ç»Ÿé€šçŸ¥ï¼ˆå¦‚è´¦å·å¼‚å¸¸ã€å®¡æ ¸æˆåŠŸç­‰ï¼‰\r\n     */\n    handleSystemMessage({\n      commit\n    }, data) {\n      // è¿™é‡Œå¯æ‰©å±•ä¸ºä¿å­˜åˆ°ç³»ç»Ÿé€šçŸ¥è¡¨ã€æˆ–ç›´æ¥æ˜¾ç¤º UI é€šçŸ¥\n      console.info('[Dispatcher] ğŸ“¢ ç³»ç»Ÿé€šçŸ¥:', data.title || data.content);\n      // ç¤ºä¾‹ï¼šå¯é›†æˆ notification/toast æ’ä»¶æç¤º\n      // this._vm.$notify({ title: data.title, message: data.content });\n    },\n    /**\r\n     * ğŸŒ å¤„ç†å…¨ç«™å¹¿æ’­æ¶ˆæ¯ï¼ˆå¦‚ç³»ç»Ÿç»´æŠ¤æé†’ï¼‰\r\n     */\n    handleBroadcast({\n      commit\n    }, data) {\n      // é€šå¸¸ç”¨äºä¸æŒä¹…åŒ–çš„å³æ—¶æç¤º\n      console.info('[Dispatcher] ğŸŒ å¹¿æ’­æ¶ˆæ¯:', data);\n      // ç¤ºä¾‹ï¼šä½¿ç”¨å…¨å±€å¼¹çª—ç»„ä»¶æ˜¾ç¤º\n      // this._vm.$toast({ message: data.content, type: data.level || 'info' });\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}