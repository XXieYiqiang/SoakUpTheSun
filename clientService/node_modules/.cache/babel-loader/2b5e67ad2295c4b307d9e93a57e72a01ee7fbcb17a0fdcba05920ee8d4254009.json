{"ast":null,"code":"import \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.for-each.js\";\nimport SparkMD5 from 'spark-md5';\nimport { getToken, getTokenType } from '@/utils/auth';\nexport default {\n  data() {\n    return {\n      params: {},\n      // ✅ 外部传入的参数\n      uploadWay: 0,\n      // ✅ 外部传入上传方式\n      serviceEl: null,\n      // ✅ 外部组件\n      callType: null,\n      // ✅ 外部调用方式\n      callback: () => {},\n      // ✅ 外部回调函数\n      uploadStatus: {},\n      options: {\n        target: '/api/filetransfer/uploadfile',\n        chunkSize: 1024 * 1024,\n        fileParameterName: 'file',\n        maxChunkRetries: 3,\n        testChunks: true,\n        checkChunkUploadedByResponse: function (chunk, message) {\n          let objMessage = JSON.parse(message);\n          if (objMessage.code === 200) {\n            let data = objMessage.data;\n            if (data.skipUpload) return true;\n            return (data.uploaded || []).indexOf(chunk.offset + 1) >= 0;\n          } else {\n            console.log('响应参数：');\n            console.log(objMessage);\n            console.log(objMessage.message);\n            return true;\n          }\n        },\n        headers: {\n          token: getTokenType() + ' ' + getToken()\n        },\n        query() {}\n      },\n      fileStatusText: {\n        success: '上传成功',\n        error: 'error',\n        uploading: '上传中',\n        paused: '暂停中',\n        waiting: '等待中'\n      },\n      attrs: {\n        accept: '*'\n      },\n      panelShow: false,\n      collapse: false,\n      dropBoxShow: false,\n      pasteImg: {\n        src: '',\n        name: ''\n      },\n      pasteImgObj: null,\n      filesLength: 0\n    };\n  },\n  mounted() {\n    this.$nextTick(() => {\n      this.handlePrepareUpload();\n    });\n  },\n  computed: {\n    uploaderInstance() {\n      return this.$refs.uploader?.uploader || null;\n    }\n  },\n  methods: {\n    // 隐藏拖拽上传遮罩\n    hideUploadMask(e) {\n      e.stopPropagation();\n      e.preventDefault();\n      this.dropBoxShow = false;\n    },\n    handlePrepareUpload() {\n      this.options.headers.token = getTokenType() + ' ' + getToken();\n      switch (this.uploadWay) {\n        case 1:\n          this.$refs.uploadBtn?.$el?.click();\n          break;\n        case 2:\n          this.$refs.uploadDirBtn?.$el?.click();\n          break;\n        case 3:\n          this.pasteImg = {\n            src: '',\n            name: ''\n          };\n          this.pasteImgObj = null;\n          this.dropBoxShow = true;\n          break;\n      }\n    },\n    handleUploadPasteImg() {\n      this.uploaderInstance?.addFile(this.pasteImgObj);\n    },\n    handleDeletePasteImg() {\n      this.pasteImg = {\n        src: '',\n        name: ''\n      };\n      this.pasteImgObj = null;\n    },\n    handlePaste(event) {\n      const items = (event.clipboardData || window.clipboardData).items;\n      const imgObj = items?.[0]?.getAsFile();\n      if (!imgObj) {\n        this.$message.error('粘贴内容非图片');\n        return;\n      }\n      this.pasteImgObj = new File([imgObj], `upload_${Date.now()}.png`, {\n        type: imgObj.type\n      });\n      const reader = new FileReader();\n      reader.onload = e => {\n        this.pasteImg.src = e.target.result;\n        this.pasteImg.name = this.pasteImgObj.name;\n      };\n      reader.readAsDataURL(this.pasteImgObj);\n    },\n    handleFilesAdded(files) {\n      this.filesLength += files.length;\n      files.forEach(file => {\n        this.dropBoxShow = false;\n        this.panelShow = true;\n        this.collapse = false;\n        this.computeMD5(file);\n      });\n    },\n    computeMD5(file) {\n      const reader = new FileReader();\n      const blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice;\n      let currentChunk = 0;\n      const chunkSize = 1024 * 1024;\n      const chunks = Math.ceil(file.size / chunkSize);\n      const spark = new SparkMD5.ArrayBuffer();\n      this.uploadStatus[file.id] = '计算MD5';\n      file.pause();\n      const loadNext = () => {\n        const start = currentChunk * chunkSize;\n        const end = Math.min(start + chunkSize, file.size);\n        reader.readAsArrayBuffer(blobSlice.call(file.file, start, end));\n      };\n      reader.onload = e => {\n        spark.append(e.target.result);\n        if (++currentChunk < chunks) {\n          loadNext();\n          this.uploadStatus[file.id] = `校验MD5 ${(currentChunk / chunks * 100).toFixed(0)}%`;\n          this.uploadStatus = {\n            ...this.uploadStatus\n          };\n        } else {\n          this.calculateFileMD5End(spark.end(), file);\n        }\n      };\n      reader.onerror = () => {\n        this.$notify({\n          title: '错误',\n          message: `文件读取失败`,\n          type: 'error'\n        });\n        file.cancel();\n      };\n      loadNext();\n    },\n    calculateFileMD5End(md5, file) {\n      Object.assign(this.uploaderInstance.opts, {\n        query: {\n          ...this.params\n        }\n      });\n      file.uniqueIdentifier = md5;\n      file.resume();\n      this.uploadStatus[file.id] = '';\n      this.uploadStatus = {\n        ...this.uploadStatus\n      };\n    },\n    handleFileSuccess(rootFile, file, response) {\n      console.log(\"文件上传成功：\");\n      console.log(response);\n      let result = {};\n      try {\n        result = JSON.parse(response);\n      } catch {}\n      console.log('响应参数：');\n      console.log(result);\n      if (!result.code === 200) {\n        this.uploadStatus[file.id] = '上传失败';\n        this.$message.error(result.message || '上传失败');\n        return;\n      }\n      if (this.filesLength === 1) {\n        this.$message.success('上传完毕');\n        if (this.callType === 1) {\n          this.serviceEl?.$emit?.('getTableDataByType');\n        } else {\n          this.serviceEl?.getTableDataByType?.();\n        }\n        //计算文件上传 内存\n        // this.serviceEl?.$store?.dispatch('showStorage')\n        this.callback(true);\n      }\n      this.filesLength--;\n    },\n    handleFileError(rootFile, file, response) {\n      this.$message({\n        message: response,\n        type: 'error'\n      });\n    },\n    handleClosePanel() {\n      this.uploaderInstance?.cancel();\n      this.panelShow = false;\n      this.callback('cancel');\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}