{"ast":null,"code":"import RightBar from '@/components/RightBar.vue';\nimport { handleLogin, handleLogout } from '@/api/user';\nimport WebSocketService from '@/plugins/ws'; // ✅ 正确\nimport Vue from 'vue';\nexport default {\n  components: {\n    RightBar\n  },\n  data() {\n    return {\n      defaultAvatar: 'https://iknow-pic.cdn.bcebos.com/962bd40735fae6cd17bafbff1db30f2442a70f25',\n      isRightbarCollapsed: true,\n      loginDialogVisible: false,\n      /// 登录对话框可见性\n      loginForm: {\n        phone: \"\",\n        passWord: \"\"\n      },\n      loginRules: {\n        phone: [{\n          required: true,\n          message: \"请输入手机号\",\n          trigger: \"blur\"\n        }, {\n          pattern: /^1[3-9]\\d{9}$/,\n          message: \"请输入合法的手机号\",\n          trigger: \"blur\"\n        }],\n        passWord: [{\n          required: true,\n          message: \"请输入密码\",\n          trigger: \"blur\"\n        }]\n      }\n    };\n  },\n  mounted() {\n    // 注册关闭页面事件\n    window.addEventListener(\"beforeunload\", this.clearCache);\n  },\n  beforeDestroy() {\n    // 组件卸载时移除监听\n    window.removeEventListener(\"beforeunload\", this.clearCache);\n  },\n  computed: {\n    isLogin() {\n      return this.$store.getters['user/isLogin'];\n    },\n    userInfo() {\n      return this.$store.state.user.userInfo || {};\n    }\n  },\n  methods: {\n    //用户登录表单提交\n    async submitLogin() {\n      const that = this;\n      this.$refs.loginForm.validate(valid => {\n        if (valid) {\n          // TODO: 提交登录逻辑\n          const param = {\n            ...this.loginForm\n          };\n          try {\n            handleLogin(param).then(res => {\n              const data = res.data.data;\n              if (res.data.code === 200 && data.token) {\n                const token = data.token;\n                const user = data.userInfo;\n\n                // 存入 Vuex\n                that.$store.dispatch('user/login', {\n                  token,\n                  userInfo: user\n                });\n                that.loginDialogVisible = false;\n                that.$message.success('登录成功');\n                this.initWebSocket(user.userId);\n              } else {\n                that.loginDialogVisible = false;\n                that.$message.error(res.data.message || '登录失败');\n              }\n            });\n          } catch (e) {\n            console.error(e);\n            that.$message.error('网络错误或服务异常');\n          }\n        }\n      });\n    },\n    /**\n     * 登录预处理操作\n     */\n    async doLogin() {\n      // 打开登录对话框\n      this.loginDialogVisible = true;\n    },\n    /**\n     * 用户登出\n     */\n    async doLogout() {\n      // TODO: 登出逻辑\n\n      const param = {\n        userId: this.userInfo.userId\n      };\n      const res = await handleLogout(param);\n      if (res && res.data && res.data.code === 200) {\n        this.$store.dispatch('user/logout');\n        this.$message.success('已登出');\n      } else {\n        this.$message.error(res.data.message);\n      }\n    },\n    /**\n     * 初始化 AI Chat WebSocket\n     * @param userId \n     */\n    initWebSocket(userId) {\n      if (this.wsService) {\n        this.wsService.close();\n      }\n      this.wsService = new WebSocketService(this.$store);\n      this.wsService.connect(userId);\n      this.$ws = this.wsService; // 全局使用 $ws\n      Vue.prototype.$ws = this.wsService;\n      this.$ws.send({});\n    },\n    /**\n     * 清空缓存\n     */\n    clearCache() {\n      this.$store.dispatch('user/logout');\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}