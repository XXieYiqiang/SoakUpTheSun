{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.find.js\";\nimport \"core-js/modules/es.iterator.for-each.js\";\nimport \"core-js/modules/es.iterator.map.js\";\nimport { marked } from 'marked';\nimport { uploadFile } from '@/api/file';\nimport { nextTick } from 'vue';\nimport hljs from 'highlight.js';\nimport { getFileListByPath } from '@/api/knowledge.js';\nimport 'highlight.js/styles/github.css'; // ä½ å¯ä»¥æ¢æˆå…¶ä»–ä¸»é¢˜æ ·å¼\n\nmarked.setOptions({\n  breaks: true,\n  gfm: true,\n  highlight(code, lang) {\n    return lang && hljs.getLanguage(lang) ? hljs.highlight(code, {\n      language: lang\n    }).value : hljs.highlightAuto(code).value;\n  }\n});\nexport default {\n  data() {\n    return {\n      selectedModel: 'gpt-4.1',\n      //æ‰€é€‰æ¨¡å‹\n      selectedModelOptions: [{\n        label: 'ğŸš€ GPT-4.1ï¼ˆæ¨èæ–‡æœ¬æ¨¡å‹ï¼‰',\n        value: 'gpt-4.1'\n      }, {\n        label: 'ğŸŒŒ GPT-4.1-2025-04-14ï¼ˆæœ€æ–°ç‰ˆï¼‰',\n        value: 'gpt-4.1-2025-04-14'\n      }, {\n        label: 'ğŸ”® GPT-4oï¼ˆå¤šæ¨¡æ€æ——èˆ°ï¼‰',\n        value: 'gpt-4o'\n      }, {\n        label: 'ğŸ§  O3ï¼ˆæ¨ç†ä¼˜åŒ–ç‰ˆï¼‰',\n        value: 'o3'\n      }, {\n        label: 'ğŸ“˜ GPT-4ï¼ˆæ—§ç‰ˆï¼‰',\n        value: 'gpt-4'\n      }, {\n        label: 'ğŸ’¸ GPT-3.5 Turboï¼ˆä½æˆæœ¬ï¼‰',\n        value: 'gpt-3.5-turbo'\n      }],\n      selectedKB: '',\n      selectedKBOptions: [{\n        label: 'ğŸ“š æœªä½¿ç”¨çŸ¥è¯†åº“',\n        value: 'ğŸ“š æœªä½¿ç”¨çŸ¥è¯†åº“'\n      }, {\n        label: 'ğŸ“˜ äº§å“æ–‡æ¡£åº“',\n        value: 'ğŸ“˜ äº§å“æ–‡æ¡£åº“'\n      }, {\n        label: 'ğŸ“’ FAQ çŸ¥è¯†åº“',\n        value: 'ğŸ“’ FAQ çŸ¥è¯†åº“'\n      }, {\n        label: 'ğŸ“™ å†…éƒ¨èµ„æ–™åº“',\n        value: 'ğŸ“™ å†…éƒ¨èµ„æ–™åº“'\n      }],\n      //æ‰€é€‰çŸ¥è¯†åº“\n      socketStatus: 'connecting',\n      // åˆå§‹çŠ¶æ€\n      socket: null,\n      reconnectAttempts: 0,\n      // å½“å‰é‡è¯•æ¬¡æ•°\n      maxReconnectAttempts: 20,\n      // æœ€å¤§é‡è¯•æ¬¡æ•°\n      reconnectDelay: 2000,\n      // åˆå§‹é‡è¿å»¶è¿Ÿ(ms)\n      reconnectTimer: null,\n      selectedFiles: [],\n      // æ”¹æˆæ•°ç»„æ”¯æŒå¤šæ–‡ä»¶\n\n      selectedFile: null,\n      // æ–°å¢ï¼šå·²é€‰æ–‡ä»¶\n      chatMessages: [{\n        id: Date.now(),\n        role: 'ai',\n        content: 'å˜¿ï¼æˆ‘æ˜¯ **AI å°åŠ©æ‰‹**ï¼Œæœ‰ä»»ä½•é—®é¢˜éƒ½å¯ä»¥é—®æˆ‘å“¦ï½',\n        renderedContent: ''\n      }],\n      userInput: '',\n      loading: false,\n      currentAiMessageId: null,\n      typingQueue: [],\n      typingTimer: null,\n      isTyping: false\n    };\n  },\n  mounted() {\n    this.getFileListByPath();\n    // åˆå§‹åŒ– Markdown æ¸²æŸ“\n    this.chatMessages.forEach(msg => {\n      msg.renderedContent = marked.parse(msg.content);\n    });\n    this.initSocket();\n    this.adjustInputHeight(); // åˆå§‹åŒ–ä¸€æ¬¡\n  },\n  watch: {\n    userInput() {\n      this.adjustInputHeight();\n    }\n  },\n  beforeDestroy() {\n    if (this.typingTimer) {\n      clearTimeout(this.typingTimer);\n    }\n    if (this.reconnectTimer) {\n      clearTimeout(this.reconnectTimer);\n    }\n    if (this.socket) {\n      this.socket.close();\n    }\n  },\n  methods: {\n    /**\r\n     * æŸ¥è¯¢çŸ¥è¯†åº“åˆ—è¡¨\r\n     */\n    getFileListByPath() {\n      getFileListByPath().then(res => {\n        if (res && res.data && res.data.data && res.data.data.records) {\n          this.selectedKBOptions = res.data.data.records.map(item => ({\n            label: item.name,\n            value: item.knowledgeCode\n          }));\n        }\n      });\n    },\n    adjustInputHeight() {\n      nextTick(() => {\n        const el = this.$refs.inputBox;\n        if (!el) return;\n        el.style.height = 'auto'; // é‡ç½®é«˜åº¦\n        const lineHeight = parseInt(getComputedStyle(el).lineHeight) || 24;\n        const maxLines = 3;\n        const maxHeight = lineHeight * maxLines + 20; // 20px padding é¢„ç•™\n        el.style.height = Math.min(el.scrollHeight, maxHeight) + 'px';\n      });\n    },\n    /**\r\n     * å¤åˆ¶ç²˜è´´æ–‡ä»¶ä¸Šä¼ \r\n     */\n    handlePaste(e) {\n      const clipboardData = e.clipboardData;\n      if (!clipboardData) return;\n      const files = [];\n      for (let item of clipboardData.items) {\n        if (item.kind === 'file') {\n          const file = item.getAsFile();\n          if (file) files.push(file);\n        }\n      }\n      if (files.length > 0) {\n        // è¿½åŠ æ–‡ä»¶ï¼Œé¿å…è¦†ç›–\n        this.selectedFiles.push(...files);\n        console.log(\"ç²˜è´´æ·»åŠ æ–‡ä»¶ï¼š\");\n        console.log(this.selectedFiles);\n        e.preventDefault(); // é˜»æ­¢ç²˜è´´åˆ°è¾“å…¥æ¡†\n      }\n    },\n    /**\r\n     * æ‰‹åŠ¨é‡è¿\r\n     */\n    manualReconnect() {\n      console.log('[WebSocket] ç”¨æˆ·æ‰‹åŠ¨è§¦å‘é‡è¿');\n      // æ¸…ç†å·²æœ‰è‡ªåŠ¨é‡è¿å®šæ—¶å™¨ï¼Œé¿å…å†²çª\n      if (this.reconnectTimer) {\n        clearTimeout(this.reconnectTimer);\n        this.reconnectTimer = null;\n      }\n      this.reconnectAttempts = 0; // é‡ç½®é‡è¯•è®¡æ•°\n      this.initSocket(); // ç›´æ¥é‡æ–°è¿æ¥\n    },\n    // å¤„ç†æ–‡ä»¶é€‰æ‹©ï¼ˆæ”¯æŒå¤šé€‰ï¼‰\n    handleFileSelect(e) {\n      const files = Array.from(e.target.files);\n      if (!files.length) return;\n      // è¿½åŠ æ–‡ä»¶ï¼Œé¿å…è¦†ç›–\n      this.selectedFiles.push(...files);\n      console.log(\"å·²é€‰æ‹©æ–‡ä»¶ï¼š\");\n      console.log(this.selectedFiles);\n      // æ¸…ç©º input ä»¥ä¾¿åŒåæ–‡ä»¶ä¹Ÿèƒ½è¢«é€‰ä¸­\n      e.target.value = null;\n    },\n    // åˆ é™¤é™„ä»¶\n    removeFile(index) {\n      this.selectedFiles.splice(index, 1);\n    },\n    /**\r\n     * æ¶ˆæ¯Id ç”Ÿæˆ\r\n     */\n    generateId() {\n      return Date.now() + Math.random();\n    },\n    /**\r\n     * åˆå§‹åŒ– Web Socket æœåŠ¡\r\n     */\n    initSocket() {\n      if (this.socket) {\n        this.socket.close();\n        this.socket = null;\n      }\n      this.socket = new WebSocket('ws://127.0.0.1:9876/chat-ws');\n      this.socketStatus = 'connecting';\n      this.socket.addEventListener('open', () => {\n        console.log('WebSocket å·²è¿æ¥');\n        this.socketStatus = 'open';\n        this.reconnectAttempts = 0; // æˆåŠŸè¿æ¥åé‡ç½®è®¡æ•°\n        if (this.reconnectTimer) {\n          clearTimeout(this.reconnectTimer);\n          this.reconnectTimer = null;\n        }\n      });\n      this.socket.addEventListener('message', event => {\n        if (event.data === '[DONE]') {\n          this.loading = false;\n          this.currentAiMessageId = null;\n          return;\n        }\n        this.queueTextForTyping(event.data);\n      });\n      this.socket.addEventListener('close', () => {\n        console.log('WebSocket å·²å…³é—­');\n        this.socketStatus = 'closed';\n        this.tryReconnect();\n      });\n      this.socket.addEventListener('error', error => {\n        console.error('WebSocket é”™è¯¯:', error);\n        this.socketStatus = 'error';\n        this.tryReconnect();\n      });\n    },\n    /** WebSocket é‡è¿ é€»è¾‘ */\n    tryReconnect() {\n      if (this.reconnectAttempts >= this.maxReconnectAttempts) {\n        console.warn('[WebSocket] å·²è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œä¸å†é‡è¯•');\n        return;\n      }\n      if (this.reconnectTimer) return; // å·²æœ‰é‡è¿è®¡åˆ’ï¼Œé¿å…é‡å¤\n\n      const delay = this.reconnectDelay * (this.reconnectAttempts + 1); // ç®€å•æŒ‡æ•°é€€é¿\n      console.log(`[WebSocket] ${delay}ms åå°è¯•ç¬¬ ${this.reconnectAttempts + 1} æ¬¡é‡è¿`);\n      this.reconnectTimer = setTimeout(() => {\n        console.log('[WebSocket] å¼€å§‹é‡è¿...');\n        this.reconnectAttempts++;\n        this.initSocket();\n      }, delay);\n    },\n    // å¤„ç†æ¶ˆæ¯å‘é€\n    async handleSend() {\n      const msg = this.userInput.trim();\n\n      // âœ… æ ¡éªŒè¾“å…¥å’Œ WebSocket çŠ¶æ€\n      if (!msg && this.selectedFiles.length === 0) return;\n      if (!this.socket || this.socket.readyState !== WebSocket.OPEN) {\n        console.warn('[Chat] ğŸš« WebSocket æœªè¿æ¥ï¼Œæ¶ˆæ¯å‘é€å¤±è´¥');\n        return;\n      }\n      let contentWithFiles = msg;\n      if (this.selectedFiles.length) {\n        const names = this.selectedFiles.map(f => f.name).join(', ');\n        contentWithFiles += `\\n\\nğŸ“ é™„ä»¶: ${names}`;\n      }\n      this.chatMessages.push({\n        id: this.generateId(),\n        role: 'user',\n        content: contentWithFiles,\n        renderedContent: marked.parse(contentWithFiles) // âœ… é™„ä»¶åä¹Ÿä¼šæ”¯æŒ Markdown æ¸²æŸ“\n      });\n\n      // æ¸…ç©ºè¾“å…¥æ¡†ï¼Œå¼€å¯åŠ è½½\n      this.userInput = '';\n      this.loading = true;\n      this.scrollToBottom();\n\n      // 2. ç»„è£…ä¸Šä¸‹æ–‡ï¼ˆæ–¹ä¾¿åç«¯ä¿æŒä¼šè¯ï¼‰\n      const context = this.chatMessages.map(m => (m.role === 'user' ? 'ç”¨æˆ·ï¼š' : 'AIï¼š') + m.content).join('\\n');\n      try {\n        // 3. åˆ¤æ–­æ˜¯å‘é€é™„ä»¶è¿˜æ˜¯çº¯æ–‡æœ¬\n        if (this.selectedFiles.length) {\n          console.log('[Chat] ğŸ“ æ­£åœ¨ä¸Šä¼ é™„ä»¶:');\n          const fileUrlList = [];\n          for (let i = 0; i < this.selectedFiles.length; i++) {\n            const resp = await this.uploadFile(this.selectedFiles[i]);\n            console.log('[Chat] ğŸ“ ä¸Šä¼ é™„ä»¶æˆåŠŸ:', resp);\n            for (let j = 0; j < resp.length; j++) {\n              fileUrlList.push(resp[j]);\n            }\n          }\n          this.safeSend({\n            type: 'file',\n            name: 'é™„ä»¶',\n            modelName: this.selectedModel,\n            data: fileUrlList,\n            knowledgeCode: this.selectedKB,\n            text: msg || '',\n            context\n          });\n          this.selectedFiles = [];\n        } else {\n          console.log('[Chat] ğŸ’¬ å‘é€æ–‡æœ¬:', msg);\n          this.safeSend({\n            type: 'text',\n            modelName: this.selectedModel,\n            knowledgeCode: this.selectedKB,\n            text: msg,\n            context\n          });\n        }\n      } catch (err) {\n        console.error('[Chat] âŒ æ¶ˆæ¯å‘é€å¤±è´¥:', err);\n      }\n    },\n    /**\r\n     * âœ… å°è£…å®‰å…¨çš„ WebSocket å‘é€æ–¹æ³•ï¼Œé¿å… TEXT_PARTIAL_WRITING é”™è¯¯\r\n     */\n    safeSend(data) {\n      if (this.socket && this.socket.readyState === WebSocket.OPEN) {\n        this.socket.send(typeof data === 'string' ? data : JSON.stringify(data));\n      } else {\n        console.warn('[Chat] ğŸš« WebSocket æœªè¿æ¥ï¼Œæ¶ˆæ¯æœªå‘é€');\n      }\n    },\n    // æ–‡ä»¶å¤„ç†ä¸ºBase64\n    fileToBase64(file) {\n      return new Promise((resolve, reject) => {\n        const reader = new FileReader();\n        reader.readAsDataURL(file);\n        reader.onload = () => resolve(reader.result);\n        reader.onerror = reject;\n      });\n    },\n    queueTextForTyping(text) {\n      const chars = Array.from(text);\n      this.typingQueue.push(...chars);\n      if (!this.isTyping) {\n        this.startTyping();\n      }\n    },\n    startTyping() {\n      this.isTyping = true;\n      let last = this.chatMessages.find(msg => msg.id === this.currentAiMessageId);\n      if (!last) {\n        last = {\n          id: this.generateId(),\n          role: 'ai',\n          content: '',\n          renderedContent: ''\n        };\n        this.chatMessages.push(last);\n        this.currentAiMessageId = last.id;\n      }\n      const typeNext = () => {\n        if (this.typingQueue.length === 0) {\n          this.isTyping = false;\n          return;\n        }\n        const nextChar = this.typingQueue.shift();\n        last.content += nextChar;\n        last.renderedContent = marked.parse(last.content);\n        this.$forceUpdate();\n        this.scrollToBottom();\n        this.$nextTick(() => {\n          hljs.highlightAll(); // è¯­æ³•é«˜äº®é‡æ–°æ‰§è¡Œ\n        });\n        this.typingTimer = setTimeout(typeNext, 20);\n      };\n      typeNext();\n    },\n    scrollToBottom() {\n      this.$nextTick(() => {\n        const el = this.$refs.chatList;\n        if (el) el.scrollTop = el.scrollHeight;\n      });\n    },\n    /**\r\n     * æ–‡ä»¶ä¸Šä¼ \r\n     */\n    async uploadFile(file) {\n      const formData = new FormData();\n      formData.append('file', file); // å‡è®¾åç«¯å­—æ®µæ˜¯ filesï¼Œå¤šä¸ªåŒåå­—æ®µ\n\n      const res = await uploadFile(formData);\n      return res.data.data || [];\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}