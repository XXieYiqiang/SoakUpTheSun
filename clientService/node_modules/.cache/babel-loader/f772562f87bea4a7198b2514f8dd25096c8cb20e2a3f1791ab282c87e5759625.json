{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\nrequire(\"core-js/modules/es.iterator.constructor.js\");\nrequire(\"core-js/modules/es.iterator.for-each.js\");\nvar _default = exports.default = {\n  name: 'WebRTCView',\n  data() {\n    return {\n      targetId: '',\n      // ================= WebRTC (SFU æ¨¡å¼) =================\n      upPC: null,\n      // ä¸Šè¡Œ PeerConnection (å‘å¸ƒ/æ¨æµ)\n      downPC: null,\n      // ä¸‹è¡Œ PeerConnection (è®¢é˜…/æ‹‰æµ)\n      localStream: null,\n      // æœ¬åœ°åª’ä½“æµ\n\n      // ================= WebSocket ä¿¡ä»¤ =================\n      ws: null,\n      userId: '',\n      // å½“å‰ç”¨æˆ· ID\n      roomID: 'VnWJYC61G72f2Br3G68oYV',\n      // æˆ¿é—´ ID (ä¸æœåŠ¡å™¨ä¿æŒä¸€è‡´)\n      isPublisher: false,\n      // æ ‡è®°å½“å‰æ˜¯å¦æ­£åœ¨å‘å¸ƒä¸­\n      onlineUsers: [],\n      // SFU æ¨¡å¼ä¸‹ï¼Œè¿™ä¸ªåˆ—è¡¨çš„ä½œç”¨æ˜¯æ˜¾ç¤ºå‘å¸ƒè€…ï¼Œä½†åœ¨è¿™ä¸ªç®€å•ç‰ˆæœ¬ä¸­ä»…ä½œå±•ç¤º\n\n      // ... (å…¶ä»–æ•°æ®ä¿æŒä¸å˜)\n      iceServers: {\n        iceServers: [{\n          urls: 'stun:stun.l.google.com:19302'\n        } // å…¬å…± STUN æœåŠ¡å™¨\n        ]\n      }\n    };\n  },\n  mounted() {\n    this.userId = Math.random().toString(36).slice(2, 8);\n    this.initSignalWS();\n    this.initMedia(); // å®¢æˆ·ç«¯ä¸€è¿æ¥å°±å‡†å¤‡åª’ä½“ï¼Œä½†åªæœ‰è°ƒç”¨ startPublish æ—¶æ‰å¼€å§‹å‘å¸ƒ\n  },\n  methods: {\n    /* ================= ä¿¡ä»¤ WS & æˆ¿é—´ç®¡ç† ================= */\n    initSignalWS() {\n      // SFU æœåŠ¡å™¨çš„è¿æ¥è·¯å¾„åº”è¯¥æ˜¯ç»Ÿä¸€çš„ï¼Œç”±æœåŠ¡å™¨åœ¨å†…éƒ¨ç®¡ç† roomID å’Œ userID\n      this.ws = new WebSocket(`ws://localhost:8080/room/join?uid=${this.userId}&roomID=${this.roomID}`);\n      this.ws.onopen = () => {\n        console.log('ğŸ“¡ ä¿¡ä»¤ WS å·²è¿æ¥, userId=', this.userId);\n        // SFU æœåŠ¡å™¨é€šå¸¸ä¸éœ€è¦ \"register\" æ¶ˆæ¯ï¼Œè¿æ¥æˆåŠŸå³æ³¨å†Œã€‚\n        // å¦‚æœéœ€è¦ï¼Œå¯ä»¥å‘é€ä¸€ä¸ª subscribe æ¶ˆæ¯æ¥è·å–ç°æœ‰å‘å¸ƒè€…çš„åˆ—è¡¨ã€‚\n        this.sendSignal('subscribe', {});\n      };\n      this.ws.onmessage = async e => {\n        const rawMsg = JSON.parse(e.data);\n        console.log('â¬…ï¸ æ”¶åˆ° SFU ä¿¡ä»¤:', rawMsg.event, rawMsg.data);\n        await this.handleSignal(rawMsg);\n      };\n      // ... (onerror ä¿æŒä¸å˜)\n    },\n    // ç»Ÿä¸€å‘é€ä¿¡ä»¤æ¶ˆæ¯ (æ ¼å¼æ”¹ä¸º SFU æœåŠ¡å™¨è¦æ±‚çš„ {event, data})\n    sendSignal(event, data) {\n      const message = {\n        event: event,\n        data: data\n      };\n      this.ws.send(JSON.stringify(message));\n    },\n    /* ================= åª’ä½“ ================= */\n    async initMedia() {\n      if (this.localStream) return;\n      try {\n        this.localStream = await navigator.mediaDevices.getUserMedia({\n          video: true,\n          audio: true\n        });\n        this.$refs.localVideo.srcObject = this.localStream;\n      } catch (error) {\n        console.error(\"è·å–åª’ä½“æµå¤±è´¥:\", error);\n      }\n    },\n    /* ================= å‘å¸ƒè€… (UpPC) æµç¨‹ ================= */\n    createUpPeerConnection() {\n      if (this.upPC) {\n        this.upPC.close();\n        this.upPC = null;\n      }\n      this.upPC = new RTCPeerConnection(this.iceServers);\n\n      // 1. å°†æœ¬åœ°è½¨é“æ·»åŠ åˆ° UpPC\n      this.localStream.getTracks().forEach(track => {\n        this.upPC.addTrack(track, this.localStream);\n      });\n\n      // 2. ICE candidate ç”Ÿæˆæ—¶å‘é€ç»™ SFU (up_candidate)\n      this.upPC.onicecandidate = e => {\n        if (e.candidate) {\n          this.sendSignal('up_candidate', {\n            candidate: e.candidate\n          });\n        }\n      };\n\n      // 3. ç›‘å¬è¿æ¥çŠ¶æ€\n      this.upPC.onconnectionstatechange = () => {\n        console.log(`â¬†ï¸ UpPC çŠ¶æ€: ${this.upPC.connectionState}`);\n      };\n    },\n    async startPublish() {\n      if (!this.localStream) {\n        await this.initMedia();\n      }\n      this.createUpPeerConnection();\n\n      // 1. åˆ›å»º offer\n      const offer = await this.upPC.createOffer();\n      await this.upPC.setLocalDescription(offer);\n      console.log('â¡ï¸ å‘é€ up_offer (Local SDP):', offer.sdp);\n\n      // 2. å‘é€ up_offer ç»™ SFU\n      this.sendSignal('up_offer', {\n        uid: this.userId,\n        sdp: offer.sdp\n      });\n      this.isPublisher = true;\n    },\n    // ç”±äºæ˜¯ SFU æ¨¡å¼ï¼ŒP2Pçš„ startCall/targetId æ¦‚å¿µä¸å†é€‚ç”¨\n    // æˆ‘ä»¬å°† startCall æŒ‰é’®æ”¹ä¸º startPublish \n    startCall() {\n      this.startPublish();\n    },\n    /* ================= ä¿¡ä»¤å¤„ç† ================= */\n    async handleSignal(msg) {\n      const event = msg.event;\n      // const data = JSON.parse(msg.data) // æœåŠ¡å™¨è¿”å›çš„ data å·²ç»æ˜¯ RawMessageï¼Œå®¢æˆ·ç«¯éœ€è¦å†æ¬¡è§£æ\n      const data = msg.data;\n      console.log('data===', data);\n      try {\n        // ã€âš ï¸ è¯·æµ‹è¯•è¿™ä¸ªç‰ˆæœ¬ã€‘\n        const dataPayload = JSON.parse(msg.data);\n        console.log(`âœ… æˆåŠŸè§£æ ${event} è½½è·:`, dataPayload);\n\n        // ä½¿ç”¨ dataPayload è¿›è¡Œåç»­æ“ä½œ\n        switch (event) {\n          case 'up_answer':\n            // ... ä½¿ç”¨ dataPayload\n            await this.upPC.setRemoteDescription(new RTCSessionDescription({\n              type: 'answer',\n              sdp: dataPayload.sdp // <--- ä½¿ç”¨ dataPayload\n            }));\n            break;\n          case 'down_offer':\n            await this.handleDownOffer(dataPayload); // <--- ä½¿ç”¨ dataPayload\n            break;\n          case 'up_candidate':\n          case 'down_candidate':\n            // å¯¹äº candidate æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨å‘é€çš„æ˜¯ {\"candidate\": {...}}\n            if (this.upPC && dataPayload.candidate) {\n              // <--- ä½¿ç”¨ dataPayload\n              // candidate å·²ç»æ˜¯ JS å¯¹è±¡ï¼Œæ— éœ€å†æ¬¡è§£æ\n              await this.upPC.addIceCandidate(dataPayload.candidate);\n            }\n            break;\n          default:\n            console.warn('æœªçŸ¥ SFU ä¿¡ä»¤äº‹ä»¶:', event);\n        }\n      } catch (e) {\n        console.error(`è§£æ ${event} æ¶ˆæ¯çš„ Data å­—æ®µå¤±è´¥:`, e);\n        // æ‰“å°å‡ºå¯¼è‡´é”™è¯¯çš„åŸå§‹æ•°æ®ï¼Œä»¥ä¾¿è°ƒè¯• Go æœåŠ¡å™¨çš„è¾“å‡º\n        console.error(\"åŸå§‹ msg.data å†…å®¹:\", msg.data);\n      }\n    },\n    /* ================= è®¢é˜…è€… (DownPC) æµç¨‹ ================= */\n    createDownPeerConnection() {\n      if (this.downPC) {\n        // ç†è®ºä¸Š DownPC åªéœ€è¦åˆ›å»ºä¸€æ¬¡ï¼Œé™¤éè¿æ¥å¤±è´¥æˆ–æŒ‚æ–­\n        // this.downPC.close() \n        // this.downPC = null\n        return; // å¦‚æœå·²å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨\n      }\n      this.downPC = new RTCPeerConnection(this.iceServers);\n\n      // 1. ç›‘å¬è¿œç«¯æµï¼ˆæ‰€æœ‰çš„è®¢é˜…æµéƒ½ä¼šé€šè¿‡è¿™ä¸ªå›è°ƒæ”¶åˆ°ï¼‰\n      this.downPC.ontrack = e => {\n        console.log('ğŸ¯ æ”¶åˆ°è¿œç«¯æµ (DownPC)');\n        // åœ¨ SFU æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰è¿œç«¯æµé€šå¸¸åˆå¹¶åˆ°ä¸€ä¸ª video æ ‡ç­¾ï¼ˆå¦‚æœåªæœ‰ä¸€ä¸ªè¿œç«¯ï¼‰\n        // å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œéœ€è¦æ ¹æ® streamId/trackId æ¥åŠ¨æ€åˆ›å»º/æ›´æ–° <video> æ ‡ç­¾\n        this.$refs.remoteVideo.srcObject = e.streams[0];\n      };\n\n      // 2. ICE candidate ç”Ÿæˆæ—¶å‘é€ç»™ SFU (down_candidate)\n      this.downPC.onicecandidate = e => {\n        if (e.candidate) {\n          this.sendSignal('down_candidate', {\n            candidate: e.candidate\n          });\n        }\n      };\n\n      // 3. ç›‘å¬è¿æ¥çŠ¶æ€\n      this.downPC.onconnectionstatechange = () => {\n        console.log(`â¬‡ï¸ DownPC çŠ¶æ€: ${this.downPC.connectionState}`);\n      };\n    },\n    async handleDownOffer(payload) {\n      this.createDownPeerConnection();\n\n      // 1. è®¾ç½® SFU å‘æ¥çš„ Offer ä¸ºè¿œç«¯æè¿°\n      await this.downPC.setRemoteDescription(new RTCSessionDescription({\n        type: 'offer',\n        sdp: payload.sdp\n      }));\n\n      // 2. åˆ›å»º Answer\n      const answer = await this.downPC.createAnswer();\n      await this.downPC.setLocalDescription(answer);\n      console.log('â¡ï¸ å‘é€ down_answer (Local SDP):', answer.sdp);\n\n      // 3. å‘é€ down_answer ç»™ SFU\n      this.sendSignal('down_answer', {\n        sdp: answer.sdp\n      });\n    },\n    /* ================= æŒ‚æ–­/æ¸…ç† ================= */\n    hangup() {\n      // å…³é—­ PeerConnections\n      if (this.upPC) {\n        this.upPC.close();\n        this.upPC = null;\n      }\n      if (this.downPC) {\n        this.downPC.close();\n        this.downPC = null;\n      }\n\n      // åœæ­¢æœ¬åœ°æµ\n      if (this.localStream) {\n        this.localStream.getTracks().forEach(t => t.stop());\n        this.localStream = null;\n      }\n\n      // æ¸…ç©ºè§†é¢‘æ ‡ç­¾\n      this.$refs.localVideo.srcObject = null;\n      this.$refs.remoteVideo.srcObject = null;\n      this.isPublisher = false;\n      console.log('â˜ï¸ å·²æŒ‚æ–­');\n    }\n    // ... (beforeDestroy ä¿æŒä¸å˜)\n  }\n};","map":{"version":3,"names":["name","data","targetId","upPC","downPC","localStream","ws","userId","roomID","isPublisher","onlineUsers","iceServers","urls","mounted","Math","random","toString","slice","initSignalWS","initMedia","methods","WebSocket","onopen","console","log","sendSignal","onmessage","e","rawMsg","JSON","parse","event","handleSignal","message","send","stringify","navigator","mediaDevices","getUserMedia","video","audio","$refs","localVideo","srcObject","error","createUpPeerConnection","close","RTCPeerConnection","getTracks","forEach","track","addTrack","onicecandidate","candidate","onconnectionstatechange","connectionState","startPublish","offer","createOffer","setLocalDescription","sdp","uid","startCall","msg","dataPayload","setRemoteDescription","RTCSessionDescription","type","handleDownOffer","addIceCandidate","warn","createDownPeerConnection","ontrack","remoteVideo","streams","payload","answer","createAnswer","hangup","t","stop"],"sources":["src/views/utils/test2.vue"],"sourcesContent":["<template>\r\n  <div class=\"webrtc-container\">\r\n    <h2>ğŸ¥ WebRTC Demo</h2>\r\n\r\n    <div class=\"video-box\">\r\n      <div class=\"video-item\">\r\n        <h3>æœ¬åœ°è§†é¢‘ (ID: {{ userId }})</h3>\r\n        <video ref=\"localVideo\" autoplay muted playsinline></video>\r\n      </div>\r\n      <div class=\"video-item\">\r\n        <h3>è¿œç«¯è§†é¢‘</h3>\r\n        <video ref=\"remoteVideo\" autoplay playsinline></video>\r\n      </div>\r\n    </div>\r\n\r\n    <div class=\"actions\">\r\n      <el-input v-model=\"targetId\" placeholder=\"å¯¹æ–¹IDï¼ˆä»ä¸‹æ–¹é€‰æ‹©æˆ–æ‰‹åŠ¨è¾“å…¥ï¼‰\" style=\"width: 250px;\"></el-input>\r\n      <el-button type=\"primary\" :disabled=\"!targetId\" @click=\"startCall\">å‘¼å« {{ targetId }}</el-button>\r\n      <el-button type=\"danger\" @click=\"hangup\">æŒ‚æ–­</el-button>\r\n    </div>\r\n\r\n    <div class=\"online-users-box\">\r\n      <h3>ğŸ‘¥ åœ¨çº¿ç”¨æˆ·åˆ—è¡¨222</h3>\r\n      <div v-if=\"onlineUsers.length === 0\">æš‚æ— å…¶ä»–ç”¨æˆ·åœ¨çº¿</div>\r\n      <ul v-else>\r\n        <li v-for=\"user in onlineUsers\" :key=\"user\" @click=\"setTarget(user)\">\r\n          ç”¨æˆ· ID: **{{ user }}**\r\n          <el-button size=\"mini\" type=\"success\" @click.stop=\"setTarget(user)\">å‘¼å«</el-button>\r\n        </li>\r\n      </ul>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nexport default {\r\n  name: 'WebRTCView',\r\n\r\n  data() {\r\n    return {\r\n      targetId: '',\r\n      // ================= WebRTC (SFU æ¨¡å¼) =================\r\n      upPC: null,          // ä¸Šè¡Œ PeerConnection (å‘å¸ƒ/æ¨æµ)\r\n      downPC: null,        // ä¸‹è¡Œ PeerConnection (è®¢é˜…/æ‹‰æµ)\r\n      localStream: null,   // æœ¬åœ°åª’ä½“æµ\r\n\r\n      // ================= WebSocket ä¿¡ä»¤ =================\r\n      ws: null,\r\n      userId: '',          // å½“å‰ç”¨æˆ· ID\r\n      roomID: 'VnWJYC61G72f2Br3G68oYV', // æˆ¿é—´ ID (ä¸æœåŠ¡å™¨ä¿æŒä¸€è‡´)\r\n      isPublisher: false,  // æ ‡è®°å½“å‰æ˜¯å¦æ­£åœ¨å‘å¸ƒä¸­\r\n      onlineUsers: [],     // SFU æ¨¡å¼ä¸‹ï¼Œè¿™ä¸ªåˆ—è¡¨çš„ä½œç”¨æ˜¯æ˜¾ç¤ºå‘å¸ƒè€…ï¼Œä½†åœ¨è¿™ä¸ªç®€å•ç‰ˆæœ¬ä¸­ä»…ä½œå±•ç¤º\r\n\r\n      // ... (å…¶ä»–æ•°æ®ä¿æŒä¸å˜)\r\n      iceServers: {\r\n        iceServers: [\r\n          { urls: 'stun:stun.l.google.com:19302' } // å…¬å…± STUN æœåŠ¡å™¨\r\n        ]\r\n      }\r\n    }\r\n  },\r\n\r\n  mounted() {\r\n    this.userId = Math.random().toString(36).slice(2, 8)\r\n    this.initSignalWS()\r\n    this.initMedia() // å®¢æˆ·ç«¯ä¸€è¿æ¥å°±å‡†å¤‡åª’ä½“ï¼Œä½†åªæœ‰è°ƒç”¨ startPublish æ—¶æ‰å¼€å§‹å‘å¸ƒ\r\n  },\r\n\r\n  methods: {\r\n    /* ================= ä¿¡ä»¤ WS & æˆ¿é—´ç®¡ç† ================= */\r\n    initSignalWS() {\r\n      // SFU æœåŠ¡å™¨çš„è¿æ¥è·¯å¾„åº”è¯¥æ˜¯ç»Ÿä¸€çš„ï¼Œç”±æœåŠ¡å™¨åœ¨å†…éƒ¨ç®¡ç† roomID å’Œ userID\r\n      this.ws = new WebSocket(`ws://localhost:8080/room/join?uid=${this.userId}&roomID=${this.roomID}`)\r\n\r\n      this.ws.onopen = () => {\r\n        console.log('ğŸ“¡ ä¿¡ä»¤ WS å·²è¿æ¥, userId=', this.userId)\r\n        // SFU æœåŠ¡å™¨é€šå¸¸ä¸éœ€è¦ \"register\" æ¶ˆæ¯ï¼Œè¿æ¥æˆåŠŸå³æ³¨å†Œã€‚\r\n        // å¦‚æœéœ€è¦ï¼Œå¯ä»¥å‘é€ä¸€ä¸ª subscribe æ¶ˆæ¯æ¥è·å–ç°æœ‰å‘å¸ƒè€…çš„åˆ—è¡¨ã€‚\r\n        this.sendSignal('subscribe', {})\r\n      }\r\n\r\n      this.ws.onmessage = async e => {\r\n        const rawMsg = JSON.parse(e.data)\r\n        console.log('â¬…ï¸ æ”¶åˆ° SFU ä¿¡ä»¤:', rawMsg.event, rawMsg.data)\r\n        await this.handleSignal(rawMsg)\r\n      }\r\n      // ... (onerror ä¿æŒä¸å˜)\r\n    },\r\n\r\n    // ç»Ÿä¸€å‘é€ä¿¡ä»¤æ¶ˆæ¯ (æ ¼å¼æ”¹ä¸º SFU æœåŠ¡å™¨è¦æ±‚çš„ {event, data})\r\n    sendSignal(event, data) {\r\n      const message = {\r\n        event: event,\r\n        data: data\r\n      }\r\n      this.ws.send(JSON.stringify(message))\r\n    },\r\n\r\n    /* ================= åª’ä½“ ================= */\r\n    async initMedia() {\r\n      if (this.localStream) return\r\n      try {\r\n        this.localStream = await navigator.mediaDevices.getUserMedia({\r\n          video: true,\r\n          audio: true\r\n        })\r\n        this.$refs.localVideo.srcObject = this.localStream\r\n      } catch (error) {\r\n        console.error(\"è·å–åª’ä½“æµå¤±è´¥:\", error)\r\n      }\r\n    },\r\n\r\n    /* ================= å‘å¸ƒè€… (UpPC) æµç¨‹ ================= */\r\n    createUpPeerConnection() {\r\n      if (this.upPC) {\r\n        this.upPC.close()\r\n        this.upPC = null\r\n      }\r\n      this.upPC = new RTCPeerConnection(this.iceServers)\r\n\r\n      // 1. å°†æœ¬åœ°è½¨é“æ·»åŠ åˆ° UpPC\r\n      this.localStream.getTracks().forEach(track => {\r\n        this.upPC.addTrack(track, this.localStream)\r\n      })\r\n\r\n      // 2. ICE candidate ç”Ÿæˆæ—¶å‘é€ç»™ SFU (up_candidate)\r\n      this.upPC.onicecandidate = e => {\r\n        if (e.candidate) {\r\n          this.sendSignal('up_candidate', { candidate: e.candidate })\r\n        }\r\n      }\r\n\r\n      // 3. ç›‘å¬è¿æ¥çŠ¶æ€\r\n      this.upPC.onconnectionstatechange = () => {\r\n        console.log(`â¬†ï¸ UpPC çŠ¶æ€: ${this.upPC.connectionState}`)\r\n      }\r\n    },\r\n\r\n    async startPublish() {\r\n      if (!this.localStream) {\r\n        await this.initMedia()\r\n      }\r\n      this.createUpPeerConnection()\r\n\r\n      // 1. åˆ›å»º offer\r\n      const offer = await this.upPC.createOffer()\r\n      await this.upPC.setLocalDescription(offer)\r\n\r\n      console.log('â¡ï¸ å‘é€ up_offer (Local SDP):', offer.sdp)\r\n\r\n      // 2. å‘é€ up_offer ç»™ SFU\r\n      this.sendSignal('up_offer', { uid: this.userId, sdp: offer.sdp })\r\n      this.isPublisher = true\r\n    },\r\n\r\n    // ç”±äºæ˜¯ SFU æ¨¡å¼ï¼ŒP2Pçš„ startCall/targetId æ¦‚å¿µä¸å†é€‚ç”¨\r\n    // æˆ‘ä»¬å°† startCall æŒ‰é’®æ”¹ä¸º startPublish \r\n    startCall() {\r\n      this.startPublish()\r\n    },\r\n\r\n    /* ================= ä¿¡ä»¤å¤„ç† ================= */\r\n    async handleSignal(msg) {\r\n      const event = msg.event\r\n      // const data = JSON.parse(msg.data) // æœåŠ¡å™¨è¿”å›çš„ data å·²ç»æ˜¯ RawMessageï¼Œå®¢æˆ·ç«¯éœ€è¦å†æ¬¡è§£æ\r\n      const data = msg.data\r\n\r\n      console.log('data===',data)\r\n\r\n      try {\r\n        // ã€âš ï¸ è¯·æµ‹è¯•è¿™ä¸ªç‰ˆæœ¬ã€‘\r\n        const dataPayload = JSON.parse(msg.data);\r\n        console.log(`âœ… æˆåŠŸè§£æ ${event} è½½è·:`, dataPayload);\r\n\r\n        // ä½¿ç”¨ dataPayload è¿›è¡Œåç»­æ“ä½œ\r\n        switch (event) {\r\n          case 'up_answer':\r\n            // ... ä½¿ç”¨ dataPayload\r\n            await this.upPC.setRemoteDescription(new RTCSessionDescription({\r\n              type: 'answer',\r\n              sdp: dataPayload.sdp // <--- ä½¿ç”¨ dataPayload\r\n            }))\r\n            break\r\n\r\n          case 'down_offer':\r\n            await this.handleDownOffer(dataPayload) // <--- ä½¿ç”¨ dataPayload\r\n            break\r\n\r\n          case 'up_candidate':\r\n          case 'down_candidate':\r\n            // å¯¹äº candidate æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨å‘é€çš„æ˜¯ {\"candidate\": {...}}\r\n            if (this.upPC && dataPayload.candidate) { // <--- ä½¿ç”¨ dataPayload\r\n              // candidate å·²ç»æ˜¯ JS å¯¹è±¡ï¼Œæ— éœ€å†æ¬¡è§£æ\r\n              await this.upPC.addIceCandidate(dataPayload.candidate)\r\n            }\r\n            break\r\n\r\n          default:\r\n            console.warn('æœªçŸ¥ SFU ä¿¡ä»¤äº‹ä»¶:', event)\r\n        }\r\n      } catch (e) {\r\n        console.error(`è§£æ ${event} æ¶ˆæ¯çš„ Data å­—æ®µå¤±è´¥:`, e);\r\n        // æ‰“å°å‡ºå¯¼è‡´é”™è¯¯çš„åŸå§‹æ•°æ®ï¼Œä»¥ä¾¿è°ƒè¯• Go æœåŠ¡å™¨çš„è¾“å‡º\r\n        console.error(\"åŸå§‹ msg.data å†…å®¹:\", msg.data);\r\n      }\r\n    },\r\n\r\n    /* ================= è®¢é˜…è€… (DownPC) æµç¨‹ ================= */\r\n    createDownPeerConnection() {\r\n      if (this.downPC) {\r\n        // ç†è®ºä¸Š DownPC åªéœ€è¦åˆ›å»ºä¸€æ¬¡ï¼Œé™¤éè¿æ¥å¤±è´¥æˆ–æŒ‚æ–­\r\n        // this.downPC.close() \r\n        // this.downPC = null\r\n        return // å¦‚æœå·²å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨\r\n      }\r\n\r\n      this.downPC = new RTCPeerConnection(this.iceServers)\r\n\r\n      // 1. ç›‘å¬è¿œç«¯æµï¼ˆæ‰€æœ‰çš„è®¢é˜…æµéƒ½ä¼šé€šè¿‡è¿™ä¸ªå›è°ƒæ”¶åˆ°ï¼‰\r\n      this.downPC.ontrack = e => {\r\n        console.log('ğŸ¯ æ”¶åˆ°è¿œç«¯æµ (DownPC)')\r\n        // åœ¨ SFU æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰è¿œç«¯æµé€šå¸¸åˆå¹¶åˆ°ä¸€ä¸ª video æ ‡ç­¾ï¼ˆå¦‚æœåªæœ‰ä¸€ä¸ªè¿œç«¯ï¼‰\r\n        // å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œéœ€è¦æ ¹æ® streamId/trackId æ¥åŠ¨æ€åˆ›å»º/æ›´æ–° <video> æ ‡ç­¾\r\n        this.$refs.remoteVideo.srcObject = e.streams[0]\r\n      }\r\n\r\n      // 2. ICE candidate ç”Ÿæˆæ—¶å‘é€ç»™ SFU (down_candidate)\r\n      this.downPC.onicecandidate = e => {\r\n        if (e.candidate) {\r\n          this.sendSignal('down_candidate', { candidate: e.candidate })\r\n        }\r\n      }\r\n\r\n      // 3. ç›‘å¬è¿æ¥çŠ¶æ€\r\n      this.downPC.onconnectionstatechange = () => {\r\n        console.log(`â¬‡ï¸ DownPC çŠ¶æ€: ${this.downPC.connectionState}`)\r\n      }\r\n    },\r\n\r\n    async handleDownOffer(payload) {\r\n      this.createDownPeerConnection()\r\n\r\n      // 1. è®¾ç½® SFU å‘æ¥çš„ Offer ä¸ºè¿œç«¯æè¿°\r\n      await this.downPC.setRemoteDescription(new RTCSessionDescription({\r\n        type: 'offer',\r\n        sdp: payload.sdp\r\n      }))\r\n\r\n      // 2. åˆ›å»º Answer\r\n      const answer = await this.downPC.createAnswer()\r\n      await this.downPC.setLocalDescription(answer)\r\n\r\n      console.log('â¡ï¸ å‘é€ down_answer (Local SDP):', answer.sdp)\r\n\r\n      // 3. å‘é€ down_answer ç»™ SFU\r\n      this.sendSignal('down_answer', { sdp: answer.sdp })\r\n    },\r\n\r\n    /* ================= æŒ‚æ–­/æ¸…ç† ================= */\r\n    hangup() {\r\n      // å…³é—­ PeerConnections\r\n      if (this.upPC) {\r\n        this.upPC.close()\r\n        this.upPC = null\r\n      }\r\n      if (this.downPC) {\r\n        this.downPC.close()\r\n        this.downPC = null\r\n      }\r\n\r\n      // åœæ­¢æœ¬åœ°æµ\r\n      if (this.localStream) {\r\n        this.localStream.getTracks().forEach(t => t.stop())\r\n        this.localStream = null\r\n      }\r\n\r\n      // æ¸…ç©ºè§†é¢‘æ ‡ç­¾\r\n      this.$refs.localVideo.srcObject = null\r\n      this.$refs.remoteVideo.srcObject = null\r\n      this.isPublisher = false\r\n      console.log('â˜ï¸ å·²æŒ‚æ–­')\r\n    }\r\n    // ... (beforeDestroy ä¿æŒä¸å˜)\r\n  }\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n.webrtc-container {\r\n  padding: 20px;\r\n}\r\n\r\n.video-box {\r\n  display: flex;\r\n  gap: 20px;\r\n  margin-bottom: 20px;\r\n}\r\n\r\n.video-item h3 {\r\n  font-size: 16px;\r\n  margin-bottom: 5px;\r\n}\r\n\r\nvideo {\r\n  width: 320px;\r\n  height: 240px;\r\n  background: #222;\r\n  border-radius: 8px;\r\n  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);\r\n}\r\n\r\n.actions {\r\n  display: flex;\r\n  gap: 10px;\r\n  margin-bottom: 30px;\r\n}\r\n\r\n.online-users-box {\r\n  margin-top: 30px;\r\n  padding: 15px;\r\n  border: 1px solid #ddd;\r\n  border-radius: 8px;\r\n}\r\n\r\n.online-users-box ul {\r\n  list-style: none;\r\n  padding: 0;\r\n}\r\n\r\n.online-users-box li {\r\n  padding: 8px 0;\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  border-bottom: 1px dashed #f0f0f0;\r\n}\r\n\r\n.online-users-box li:hover {\r\n  background-color: #f9f9f9;\r\n  cursor: pointer;\r\n}\r\n</style>"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}