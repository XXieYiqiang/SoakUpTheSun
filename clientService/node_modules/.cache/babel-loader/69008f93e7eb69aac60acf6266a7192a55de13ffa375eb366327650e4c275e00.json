{"ast":null,"code":"import SparkMD5 from 'spark-md5';\nexport default {\n  name: 'FileUploadButton',\n  data() {\n    return {\n      uploadStatus: {},\n      options: {\n        target: '/api/filetransfer/uploadfile',\n        chunkSize: 1024 * 1024,\n        fileParameterName: 'file',\n        maxChunkRetries: 3,\n        testChunks: true,\n        checkChunkUploadedByResponse: function (chunk, message) {\n          const data = JSON.parse(message).data;\n          if (data.skipUpload) return true;\n          return (data.uploaded || []).includes(chunk.offset + 1);\n        },\n        headers: {\n          token: '123'\n        },\n        query() {}\n      },\n      attrs: {\n        accept: '*'\n      },\n      fileStatusText: {\n        success: '上传成功',\n        error: 'error',\n        uploading: '上传中',\n        paused: '暂停中',\n        waiting: '等待中'\n      }\n    };\n  },\n  computed: {\n    uploaderInstance() {\n      return this.$refs.uploader.uploader;\n    }\n  },\n  methods: {\n    triggerUpload() {\n      //   this.$refs.uploadBtn.$el.click();\n      this.uploaderInstance.selectFiles();\n    },\n    handleFileSuccess(rootFile, file, response) {\n      const result = JSON.parse(response || '{}');\n      if (!response || result.code !== 200 || result.data.uploaded.at(-1) !== result.data.uploaded.length) {\n        this.uploadStatus[file.id] = '上传失败';\n        this.$message.error(result.message || '上传失败');\n        return;\n      }\n    },\n    handleFileError(rootFile, file, response) {\n      this.$message.error(response);\n    },\n    handleFilesAdded(files) {\n      this.computeMD5(files);\n    },\n    computeMD5(file) {\n      const fileReader = new FileReader();\n      const blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice;\n      const chunkSize = 1 * 1024 * 1024;\n      const chunks = Math.ceil(file.size / chunkSize);\n      let currentChunk = 0;\n      const spark = new SparkMD5.ArrayBuffer();\n      this.uploadStatus[file.id] = '计算MD5';\n      file.pause();\n      const loadNext = () => {\n        const start = currentChunk * chunkSize;\n        const end = start + chunkSize >= file.size ? file.size : start + chunkSize;\n        fileReader.readAsArrayBuffer(blobSlice.call(file.file, start, end));\n      };\n      fileReader.onload = e => {\n        spark.append(e.target.result);\n        currentChunk++;\n        if (currentChunk < chunks) {\n          this.uploadStatus[file.id] = `校验MD5 ${(currentChunk / chunks * 100).toFixed(0)}%`;\n          this.uploadStatus = {\n            ...this.uploadStatus\n          };\n          loadNext();\n        } else {\n          this.calculateFileMD5End(spark.end(), file);\n        }\n      };\n      fileReader.onerror = () => {\n        this.$notify.error({\n          title: '错误',\n          message: `文件${file.name}读取出错`,\n          duration: 2000\n        });\n        file.cancel();\n      };\n      loadNext();\n    },\n    calculateFileMD5End(md5, file) {\n      Object.assign(this.uploaderInstance.opts, {\n        query: {\n          ...this.params\n        }\n      });\n      file.uniqueIdentifier = md5;\n      file.resume();\n      this.uploadStatus[file.id] = '';\n    }\n  }\n};","map":{"version":3,"names":["SparkMD5","name","data","uploadStatus","options","target","chunkSize","fileParameterName","maxChunkRetries","testChunks","checkChunkUploadedByResponse","chunk","message","JSON","parse","skipUpload","uploaded","includes","offset","headers","token","query","attrs","accept","fileStatusText","success","error","uploading","paused","waiting","computed","uploaderInstance","$refs","uploader","methods","triggerUpload","selectFiles","handleFileSuccess","rootFile","file","response","result","code","at","length","id","$message","handleFileError","handleFilesAdded","files","computeMD5","fileReader","FileReader","blobSlice","File","prototype","slice","mozSlice","webkitSlice","chunks","Math","ceil","size","currentChunk","spark","ArrayBuffer","pause","loadNext","start","end","readAsArrayBuffer","call","onload","e","append","toFixed","calculateFileMD5End","onerror","$notify","title","duration","cancel","md5","Object","assign","opts","params","uniqueIdentifier","resume"],"sources":["src/components/uploadFile/Box.vue"],"sourcesContent":["<template>\r\n  <div>\r\n    <el-button type=\"primary\" @click=\"triggerUpload\">选择文件</el-button>\r\n    <uploader\r\n      ref=\"uploader\"\r\n      :options=\"options\"\r\n      :fileStatusText=\"fileStatusText\"\r\n      @file-added=\"handleFilesAdded\"\r\n      @file-error=\"handleFileError\"\r\n      @file-success=\"handleFileSuccess\"\r\n      :autoStart=\"false\"\r\n      style=\"display: none\"\r\n    >\r\n      <uploader-unsupport></uploader-unsupport>\r\n      <uploader-btn :attrs=\"attrs\" ref=\"uploadBtn\"></uploader-btn>\r\n    </uploader>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport SparkMD5 from 'spark-md5';\r\n\r\nexport default {\r\n  name: 'FileUploadButton',\r\n  data() {\r\n    return {\r\n      uploadStatus: {},\r\n      options: {\r\n        target: '/api/filetransfer/uploadfile',\r\n        chunkSize: 1024 * 1024,\r\n        fileParameterName: 'file',\r\n        maxChunkRetries: 3,\r\n        testChunks: true,\r\n        checkChunkUploadedByResponse: function (chunk, message) {\r\n          const data = JSON.parse(message).data;\r\n          if (data.skipUpload) return true;\r\n          return (data.uploaded || []).includes(chunk.offset + 1);\r\n        },\r\n        headers: {\r\n          token: '123',\r\n        },\r\n        query() {},\r\n      },\r\n      attrs: {\r\n        accept: '*',\r\n      },\r\n      fileStatusText: {\r\n        success: '上传成功',\r\n        error: 'error',\r\n        uploading: '上传中',\r\n        paused: '暂停中',\r\n        waiting: '等待中',\r\n      },\r\n    };\r\n  },\r\n  computed: {\r\n    uploaderInstance() {\r\n      return this.$refs.uploader.uploader;\r\n    },\r\n  },\r\n  methods: {\r\n    triggerUpload() {\r\n    //   this.$refs.uploadBtn.$el.click();\r\n\t  this.uploaderInstance.selectFiles();\r\n    },\r\n    handleFileSuccess(rootFile, file, response) {\r\n      const result = JSON.parse(response || '{}');\r\n      if (!response || result.code !== 200 || result.data.uploaded.at(-1) !== result.data.uploaded.length) {\r\n        this.uploadStatus[file.id] = '上传失败';\r\n        this.$message.error(result.message || '上传失败');\r\n        return;\r\n      }\r\n    },\r\n    handleFileError(rootFile, file, response) {\r\n      this.$message.error(response);\r\n    },\r\n    handleFilesAdded(files) {\r\n      this.computeMD5(files);\r\n    },\r\n    computeMD5(file) {\r\n      const fileReader = new FileReader();\r\n      const blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice;\r\n      const chunkSize = 1 * 1024 * 1024;\r\n      const chunks = Math.ceil(file.size / chunkSize);\r\n      let currentChunk = 0;\r\n      const spark = new SparkMD5.ArrayBuffer();\r\n      this.uploadStatus[file.id] = '计算MD5';\r\n      file.pause();\r\n\r\n      const loadNext = () => {\r\n        const start = currentChunk * chunkSize;\r\n        const end = start + chunkSize >= file.size ? file.size : start + chunkSize;\r\n        fileReader.readAsArrayBuffer(blobSlice.call(file.file, start, end));\r\n      };\r\n\r\n      fileReader.onload = (e) => {\r\n        spark.append(e.target.result);\r\n        currentChunk++;\r\n        if (currentChunk < chunks) {\r\n          this.uploadStatus[file.id] = `校验MD5 ${(currentChunk / chunks * 100).toFixed(0)}%`;\r\n          this.uploadStatus = { ...this.uploadStatus };\r\n          loadNext();\r\n        } else {\r\n          this.calculateFileMD5End(spark.end(), file);\r\n        }\r\n      };\r\n\r\n      fileReader.onerror = () => {\r\n        this.$notify.error({ title: '错误', message: `文件${file.name}读取出错`, duration: 2000 });\r\n        file.cancel();\r\n      };\r\n\r\n      loadNext();\r\n    },\r\n    calculateFileMD5End(md5, file) {\r\n      Object.assign(this.uploaderInstance.opts, {\r\n        query: {\r\n          ...this.params\r\n        },\r\n      });\r\n      file.uniqueIdentifier = md5;\r\n      file.resume();\r\n      this.uploadStatus[file.id] = '';\r\n    },\r\n  },\r\n};\r\n</script>\r\n\r\n<style scoped>\r\n.select-file-btn {\r\n  display: none;\r\n}\r\n</style>\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}