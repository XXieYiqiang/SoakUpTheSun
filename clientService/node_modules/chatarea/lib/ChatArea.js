var k=Object.defineProperty;var N=(p,e,t)=>e in p?k(p,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):p[e]=t;var u=(p,e,t)=>(N(p,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();class w{constructor(e){u(this,"richText");u(this,"vnode");u(this,"cursorIndex");u(this,"needCallSpace",!1);this.richText=e,this.textInnerHtmlInit(),this.richText.focus()}textInnerHtmlInit(e=!1,t){if(e||this.getNodeEmpty(this.richText)){this.richText.innerHTML="";const i=this.getGridElm();this.richText.appendChild(i);const s=i.children[0].children[0];t&&(s.innerHTML=t,s.setAttribute("data-set-empty","false"));const o=s.childNodes[0];this.restCursorPos(o,o.textContent==="\uFEFF"?1:o.textContent.length)}}onceCall(e,t=!1,i=""){return new Promise(s=>{const o=this.createAtUserSpan(e),r=this.replaceRegContent(o,!0,t,i)||"";s(r)})}searchCall(e,t){return new Promise(i=>{const s=this.createAtUserSpan(e);this.replaceRegContent(s,t),i()})}upDataNodeOrIndex(){var s,o,r;const{focusNode:e,focusOffset:t}=window.getSelection();(e==null?void 0:e.parentNode.getAttribute("data-set-richType"))!=="richInput"||((r=(o=(s=e==null?void 0:e.parentNode)==null?void 0:s.parentNode)==null?void 0:o.parentNode)==null?void 0:r.parentNode)!==this.richText||(this.vnode=e,this.cursorIndex=t)}showAt(){if(this.upDataNodeOrIndex(),!this.vnode||this.vnode.nodeType!==Node.TEXT_NODE)return!1;const e=this.vnode.textContent||"",t=/@([^@\s]*)$/,i=e.slice(0,this.cursorIndex),s=t.exec(i);return s&&s.length===2&&i[i.length-1]==="@"}getRangeRect(){let e=0,t=0;const i=window.getSelection().getRangeAt(0).getClientRects()[0];return i&&(e=i.x,t=i.y),{x:e,y:t}}createAtUserSpan(e){const t=document.createElement("span");return t.dataset.userId=String(e.id),t.className="at-user",t.contentEditable="false",t.textContent=`@${e.name}${this.needCallSpace?" ":""}`,this.createNewDom(t)}createNewDom(e){const t=document.createElement("span");return t.className="chat-tag",t.setAttribute("contenteditable","false"),t.setAttribute("data-set-richType","chatTag"),e.className+=" chat-stat",t.appendChild(e),t}restCursorPos(e,t){t==null&&(t=e.textContent==="\uFEFF"?1:0);const i=new Range;i.setStart(e,t),i.setEnd(e,t);const s=window.getSelection();s&&(this.vnode=e,this.cursorIndex=t,s.removeAllRanges(),s.addRange(i))}replaceRegContent(e,t=!1,i=!1,s=""){const o=this.vnode.textContent;let r;typeof t=="boolean"?r=o.slice(0,t?this.cursorIndex-1:this.cursorIndex):r=o.slice(0,t-1),r.length===0?(this.vnode.parentElement.setAttribute("data-set-empty",!0),this.vnode.textContent="\uFEFF"):this.vnode.textContent=r;let a=s||o.slice(this.cursorIndex);const n=this.vnode.parentNode.parentNode,c=n.nextSibling;c?n.parentNode.insertBefore(e,c):n.parentNode.appendChild(e);const g=e.previousSibling.childNodes[0],d=g.childNodes[1];d&&(g.setAttribute("data-set-empty","false"),g.removeChild(d));const m=this.getGridElm(!0),l=m.childNodes[0];return!i&&a&&a!=="\uFEFF"&&(l.setAttribute("data-set-empty","false"),l.innerHTML=a),i&&l.childNodes[1]&&l.removeChild(l.childNodes[1]),e.nextSibling?(l.childNodes[1]&&l.removeChild(l.childNodes[1]),n.parentNode.insertBefore(m,e.nextSibling)):n.parentNode.appendChild(m),this.restCursorPos(l.childNodes[0]),a}switchRange(e){var r,a;const{focusNode:t,focusOffset:i}=window.getSelection();let s,o;if(t.nodeType===Node.TEXT_NODE){const n=t.textContent.length,c=t.parentNode.parentNode;switch(e){case"ArrowLeft":if(i>0&&t.textContent!=="\uFEFF"){o=i-1,s=t;break}const h=(r=c==null?void 0:c.previousSibling)==null?void 0:r.previousSibling;if(h)s=h.childNodes[0].childNodes[0],o=s.textContent.length;else{const d=c.parentNode.previousSibling;d&&(s=d.lastChild.childNodes[0].childNodes[0],o=s.textContent.length)}break;case"ArrowRight":if(i<n&&t.textContent!=="\uFEFF"){o=i+1,s=t;break}const g=(a=c==null?void 0:c.nextSibling)==null?void 0:a.nextSibling;if(g)s=g.childNodes[0].childNodes[0],o=s.textContent==="\uFEFF"?1:0;else{const d=c.parentNode.nextSibling;d&&(s=d.childNodes[0].childNodes[0].childNodes[0],o=s.textContent==="\uFEFF"?1:0)}break}}(o||o===0)&&this.restCursorPos(s,o)}getGridElm(e=!1){const t=document.createElement("span");if(t.setAttribute("data-set-richType","richMask"),t.innerHTML='<span class="chat-grid-input chat-stat" data-set-richType="richInput" data-set-empty="true">\uFEFF<br></span>',e)return t;const i=document.createElement("p");return i.className="chat-grid-wrap",i.setAttribute("data-set-richType","richBox"),i.appendChild(t),i}updateGrid(){const e=window.getSelection(),t=e.focusNode,i=t.parentNode,s=i.getAttribute("data-set-richType");let o,r;switch(s){case"richAllBox":if(o=t.childNodes[e.focusOffset],!o||o.getAttribute("data-set-richType")==="chatTag"){const d=this.getGridElm(!0),m=d.children[0];o?(m.removeChild(m.childNodes[1]),t.insertBefore(d,o)):t.appendChild(d),this.restCursorPos(m.childNodes[0]);break}if(o.tagName==="BR"){const d=this.getGridElm(!0),m=d.children[0];t.insertBefore(d,o),t.removeChild(o),this.restCursorPos(m.childNodes[0],m.childNodes[0].textContent.length)}break;case"richMask":const a=i.parentNode,n=Array.prototype.indexOf.call(a.childNodes,i);if(n===-1)break;if(n===0){const d=e.focusNode;d.setAttribute("data-set-empty","true"),d.innerHTML="\uFEFF<br>",o=d.childNodes[0],this.restCursorPos(o,o.textContent.length);break}let c=i.previousSibling,h;c.getAttribute("data-set-richType")==="chatTag"?(h=c.previousSibling,a.removeChild(c),a.removeChild(i)):(h=i.previousSibling,a.removeChild(i)),o=h.childNodes[0].childNodes[0],o.textContent==="\uFEFF"&&o.parentNode.appendChild(document.createElement("br")),this.restCursorPos(o,o.textContent.length);break;case"richInput":if(this.getNodeEmpty(i)){i.setAttribute("data-set-empty","true"),i.innerHTML="\uFEFF<br>",o=i.childNodes[0],this.restCursorPos(o,o.textContent.length);break}if(String(i.getAttribute("data-set-empty"))==="true"){i.setAttribute("data-set-empty","false");const d=[],m=[];Array.prototype.forEach.call(i.childNodes,l=>{l.nodeType===Node.TEXT_NODE&&l.textContent.indexOf("\uFEFF")!==-1?m.push(l):l.tagName==="BR"&&d.push(l)}),d.forEach(l=>{i.removeChild(l)}),m.forEach(l=>{const f=l.textContent.indexOf("\uFEFF"),E=new Range;E.setStart(l,l.textContent.indexOf("\uFEFF")),E.setEnd(l,f+1),E.deleteContents()}),o=i.childNodes[0],this.restCursorPos(o,o.textContent.length)}if(r=i.parentNode.nextSibling,r&&r.nodeType===Node.TEXT_NODE){let d=r.textContent,m=this.getGridElm(!0);m.childNodes[0].textContent=d,m.childNodes[0].setAttribute("data-set-empty","false"),r.parentNode.insertBefore(m,r),r.parentNode.removeChild(r),r=m}r&&r.getAttribute("data-set-richType")==="richMask"&&this.markMerge(i.parentNode,r);break}}getNodeEmpty(e){const t=new RegExp("^[​<br>\uFEFF]+$");return!e.innerHTML||t.test(e.innerHTML)}setWrap(){const e=window.getSelection();let{focusNode:t,focusOffset:i}=e;if(t.nodeType!==Node.TEXT_NODE){if(!t.getAttribute||t.getAttribute("data-set-richType")!=="richInput")return;t=t.childNodes[0]}const s=t.textContent.slice(i),o=t.parentNode.parentNode,r=o.parentNode,a=Array.prototype.indexOf.call(r.childNodes,o),n=Array.prototype.slice.call(r.childNodes,a+1),c=this.getGridElm();let h=c.children[0].children[0].childNodes[0],g=1;(s||n.length>0)&&h.parentNode.removeChild(h.parentNode.childNodes[1]),s&&s!=="\uFEFF"&&(t.textContent=t.textContent.slice(0,i),h.textContent=(h.textContent+s).replace(/\ufeff/i,()=>(g--,"")),h.parentElement.setAttribute("data-set-empty","false")),n.forEach(l=>{r.removeChild(l),c.appendChild(l)});const d=r.lastChild.childNodes[0],m=c.lastChild.childNodes[0];if(d.childNodes.length<=1){const l=d.childNodes[0];(!l.textContent||l.textContent==="\uFEFF")&&(d.innerHTML="\uFEFF<br>",d.setAttribute("data-set-empty","true"))}if(m.parentElement.getAttribute("data-set-richType")!=="richMask")c.appendChild(this.getGridElm(!0));else if(m.childNodes.length<=1){const l=m.childNodes[0];(!l.textContent||l.textContent==="\uFEFF")&&(m.innerHTML="\uFEFF<br>",m.setAttribute("data-set-empty","true"),h=c.children[0].children[0].childNodes[0])}r.nextSibling?this.richText.insertBefore(c,r.nextSibling):this.richText.appendChild(c),this.restCursorPos(h,h.textContent==="\uFEFF"?1:g),c.scrollIntoView({block:"nearest"})}selectRegionMerge(){const e=window.getSelection();if(e.isCollapsed||e.rangeCount<=0)return;const t=e.getRangeAt(0);if(t.startContainer.nodeType===Node.TEXT_NODE&&t.startContainer===t.endContainer){const i=t.startContainer;if(i.length===t.endOffset-t.startOffset){const s=i.parentNode,o=s.parentNode===s.parentNode.parentNode.lastChild;s.setAttribute("data-set-empty","true"),s.innerHTML=`\uFEFF${o?"<br>":""}`,this.restCursorPos(s.childNodes[0])}else t.deleteContents()}else if(t.commonAncestorContainer&&t.commonAncestorContainer.getAttribute("data-set-richType")==="richBox"){const i=t.startContainer.nodeType===Node.TEXT_NODE?t.startContainer.parentNode.parentNode:t.startContainer,s=t.endContainer.nodeType===Node.TEXT_NODE?t.endContainer.parentNode.parentNode:t.endContainer;t.deleteContents(),i.getAttribute("data-set-richType")===s.getAttribute("data-set-richType")&&this.markMerge(i,s)}else if(t.commonAncestorContainer===t.startContainer&&t.startContainer===t.endContainer)this.textInnerHtmlInit(!0);else{const i=r=>{if(r.nodeType===Node.TEXT_NODE)return r.parentNode.parentNode.parentNode;switch(r.getAttribute("data-set-richType")){case"richInput":return r.parentNode.parentNode;case"richMask":return r.parentNode;case"richBox":return r;default:return null}},s=i(t.startContainer),o=i(t.endContainer);if(!s||!o)return;t.deleteContents(),this.gridMerge(s,o)}return!0}gridElmMerge(){const e=window.getSelection(),{focusNode:t,focusOffset:i,isCollapsed:s}=e;if(i>1||!s)return!1;const o=(n,c)=>n.parentNode!==this.richText&&n!==n.parentNode.childNodes[0]?!1:Array.prototype.indexOf.call(this.richText.childNodes,n)!==-1?n:c>=6?!1:o(n.parentNode,c+1),r=o(t,0);if(!r||r===this.richText.childNodes[0]||i===1&&r.children[0].children[0].getAttribute("data-set-empty")==="false")return!1;const a=r.previousSibling;return this.gridMerge(a,r),!0}delMarkRule(){const e=window.getSelection(),t=e.focusNode,i=t.textContent,s=t.parentNode,o=s.parentNode,r=o.parentNode;if(!e.isCollapsed||s.getAttribute("data-set-richType")!=="richInput")return!1;if(i&&i.length===1&&o!==r.childNodes[0]&&(e.focusOffset!==0||i==="\uFEFF")){if(i==="\uFEFF"){const a=o.previousSibling.previousSibling;r.removeChild(o.previousSibling),r.removeChild(o);const n=a.childNodes[0],c=n.childNodes[0];c.textContent==="\uFEFF"&&a===r.lastChild&&n.appendChild(document.createElement("br")),this.restCursorPos(c,c.textContent.length)}else{s.innerHTML=o===r.lastChild?"\uFEFF<br>":"\uFEFF",s.setAttribute("data-set-empty","true");const a=s.childNodes[0];this.restCursorPos(a,1)}return!0}else if(e.focusOffset===0){const a=s.parentNode,n=a==null?void 0:a.previousSibling;return!n||n.getAttribute("data-set-richType")!=="chatTag"?!1:(this.delTag(n),!0)}}delTag(e){const t=e.previousSibling,i=e.nextSibling;e.parentNode.removeChild(e),this.markMerge(t,i)}gridMerge(e,t){e.lastChild.getAttribute("data-set-richType")!=="richMask"&&e.appendChild(this.getGridElm(!0)),t.childNodes[0].getAttribute("data-set-richType")!=="richMask"&&t.insertBefore(this.getGridElm(!0),t.childNodes[0]);const i=e.lastChild.childNodes[0],s=i.childNodes[0];let o=s.textContent.length;Array.prototype.forEach.call(t.childNodes,a=>{e.appendChild(a.cloneNode(!0))}),t.childNodes.length>1&&i.childNodes[1]&&i.removeChild(i.childNodes[1]);const r=i.parentNode.nextSibling;if(r){const n=r.children[0].childNodes[0];n&&n.textContent!=="\uFEFF"&&(i.childNodes[1]&&i.removeChild(i.childNodes[1]),s.textContent=(s.textContent+n.textContent).replace(/\ufeff/i,()=>(o--,"")),s.parentElement.setAttribute("data-set-empty","false")),e.removeChild(r)}s.textContent===""&&(s.textContent="\uFEFF",s.parentNode.setAttribute("data-set-empty","true"),o=1),this.richText.removeChild(t),this.restCursorPos(s,o),e.scrollIntoView({block:"nearest"})}markMerge(e,t){const s=e.children[0].childNodes[0];let o=s.textContent.length;if(t){const n=t.children[0].childNodes[0];n&&n.textContent!=="\uFEFF"&&(s.textContent=(s.textContent+n.textContent).replace(/\ufeff/i,()=>(o--,"")),s.parentElement.setAttribute("data-set-empty","false")),t.parentNode.removeChild(t)}s.textContent===""&&(s.textContent="\uFEFF",s.parentNode.setAttribute("data-set-empty","true"),o=1);const r=e.parentNode;s.textContent==="\uFEFF"&&e===r.lastChild&&(s.parentNode.appendChild(document.createElement("br")),s.parentNode.setAttribute("data-set-empty","true"),o=1),this.restCursorPos(s,o)}setCallSpace(e){this.needCallSpace=e}}const x=(p=50)=>new Promise(e=>{setTimeout(e,p)}),C=(p,e,t,i)=>{const s=Object.assign(Object.assign({},{precision:"first",continuous:!1,space:"ignore",lastPrecision:"start",insensitive:!0}),i||{});return s.insensitive&&(p=p.toLowerCase(),t=t.toLowerCase()),s.space==="ignore"&&(t=t.replace(/\s/g,"")),v(p,e,t,s)||[]},v=(p,e,t,i)=>{let s=[];for(let o=0;o<p.length;o++){if(i.space==="ignore"&&p[o]===" "){s.push(o);continue}if(p[o]===t[0]){t=t.slice(1),s.push(o);continue}const r=e.split(" ");let a=0;if(r.forEach(n=>{const c=A(n,t);c>a&&(a=c)}),a&&(t=t.slice(a),s.push(o)),!t)break}if(t)return null;if(i.continuous){const o=s;if(s.some((a,n)=>n>0&&a!==o[n-1]+1))return null}return i.space==="ignore"&&(s=s.filter(o=>p[o]!==" ")),s.length?s:null},A=(p,e)=>{let t=0;for(let i=0;i<p.length;i++)p[i]===e[t]&&t++;return t};function T(){const p=navigator.userAgent,e=/(?:Windows Phone)/.test(p),t=/(?:SymbianOS)/.test(p)||e,i=/(?:Android)/.test(p),s=/(?:Firefox)/.test(p),o=/(?:iPad|PlayBook)/.test(p)||i&&!/(?:Mobile)/.test(p)||s&&/(?:Tablet)/.test(p),r=/(?:iPhone)/.test(p)&&!o;return{isTablet:o,isPhone:r,isAndroid:i,isPc:!r&&!i&&!t}}const L=function(p,e,t){return p.forEach(i=>{if(t in i){const s=e.indexOf(String(i[t]));s!==-1&&(e[s]=i)}}),e.filter(i=>i[t])},y=function(p){return Object.prototype.toString.call(p).slice(8,-1)},b=function(p,e){const t=y(p);switch(y(e)){case"String":return t===e;case"Array":return e.some(s=>t===s);default:return!0}};class F{constructor({elm:e,userList:t,placeholder:i,copyType:s,uploadImage:o,needCallEvery:r,userProps:a,needCallSpace:n,wrapKeyFun:c,sendKeyFun:h,needDialog:g}){u(this,"richText");u(this,"needCallEvery",!0);u(this,"needDialog",!0);u(this,"placeholderElm");u(this,"userProps",{id:"id",name:"name",avatar:"avatar",pinyin:"pinyin"});u(this,"chat");u(this,"targetUserList",[]);u(this,"userList",[]);u(this,"copyType",["text"]);u(this,"itemShowList",[]);u(this,"checkboxRows",[]);u(this,"base64Images",{});u(this,"uploadImage");u(this,"deviceInfo",T());u(this,"wrapKeyFun",e=>e.ctrlKey&&["Enter","NumpadEnter"].includes(e.code));u(this,"sendKeyFun",e=>!e.ctrlKey&&["Enter","NumpadEnter"].includes(e.code));u(this,"startOpenIndex",0);u(this,"toolUserList");u(this,"dialogElm");u(this,"dialogCheckElm");u(this,"dialogMainElm");u(this,"checkboxElm");u(this,"searchResultElm");u(this,"checkGroupElm");u(this,"searchElm");u(this,"tagsElm");u(this,"dialogActiveItemElm");u(this,"dialogH5Elm");u(this,"dialogH5MainElm");u(this,"dialogH5CheckElm");u(this,"dialogH5ShowElm");u(this,"dialogH5SearchElm");u(this,"winClick",()=>{this.getElmBlock(this.dialogElm)&&this.exitDialog(),this.searchResultElm&&this.domElmShow(this.searchResultElm)});u(this,"winKeydown",async e=>{if(e.ctrlKey&&e.code==="KeyZ"&&e.preventDefault(),!(!this.getElmBlock(this.dialogElm)||this.itemShowList.length===0)){if(e.code==="ArrowDown"){this.moveActiveItem("down");return}if(e.code==="ArrowUp"){this.moveActiveItem("up");return}if((e.code==="Enter"||e.code==="NumpadEnter")&&this.dialogActiveItemElm){e.preventDefault();const t=this.dialogActiveItemElm.getAttribute("data-set-id")||"";await x(100),this.toolUserList&&this.toolUserList.length>0?await this.chat.searchCall(this.userList.find(i=>i.id===t),this.startOpenIndex):await this.chat.onceCall(t==="isALL"?{id:"isALL",name:"所有人"}:this.userList.find(i=>i.id===t)),this.exitDialog()}}});if(!(e instanceof HTMLElement))throw new Error("参数值elm：参数类型错误, 参数类型应为HTMLElement！");["absolute","relative","fixed"].includes(e.style.position)||(e.style.position="relative"),e.className+=` chat-area-${this.deviceInfo.isPc?"pc":"h5"}`,this.richText=document.createElement("div"),this.richText.setAttribute("class","chat-rich-text"),this.richText.setAttribute("data-set-richType","richAllBox"),this.richText.setAttribute("contenteditable","true"),e.appendChild(this.richText),this.placeholderElm=document.createElement("div"),this.placeholderElm.className="chat-placeholder-wrap",this.domElmShow(this.placeholderElm,!0),e.appendChild(this.placeholderElm),this.chat=new w(this.richText),g!==void 0&&(this.needDialog=String(g)!=="false"),this.needDialog&&(this.deviceInfo.isPc?this.hasPc():this.hasH5()),this.registerEvent(),this.updateConfig({userList:t,placeholder:i,copyType:s,uploadImage:o,needCallEvery:r,needCallSpace:n,userProps:a,wrapKeyFun:c,sendKeyFun:h})}registerEvent(){this.richText.addEventListener("keyup",e=>{if(!this.needDialog)return;if(e.stopPropagation(),this.deviceInfo.isPc){(e.keyCode===50||e.code==="Digit2"||e.key==="@")&&this.userList.length>0&&this.chat.showAt()&&(this.startOpenIndex=this.chat.cursorIndex,this.showPCDialog());return}const t=e.key==="Unidentified"?"android":"ios";let i=!1;switch(t){case"android":i=e.keyCode===229;break;case"ios":i=e.keyCode===50||e.code==="Digit2"||e.key==="@";break}i&&this.userList.length>0&&this.chat.showAt()&&this.showH5Dialog()}),this.richText.addEventListener("keydown",async e=>{if(this.chat.upDataNodeOrIndex(),this.getElmBlock(this.dialogElm)){if(["ArrowUp","ArrowDown","Enter","NumpadEnter"].includes(e.code))e.preventDefault();else if(["ArrowLeft","ArrowRight"].includes(e.code))this.exitDialog();else{await x(50);const t=this.chat.vnode.textContent,i=this.chat.cursorIndex;if(!t||i<this.startOpenIndex||i===this.startOpenIndex&&(e.code==="Backspace"||e.key==="Backspace")){this.exitDialog();return}const s=t.slice(this.startOpenIndex,i+1),o=String(s||"").replace(/'/g,"");if(!o){this.resizeUserTool(),this.showPCDialog();return}this.toolUserList||(this.toolUserList=this.userList);const r=this.searchUserList(o,this.toolUserList);r.length>0?(this.updateUserList(r,!0),this.showPCDialog()):this.exitDialog()}return}e.code==="Backspace"||e.key==="Backspace"?(this.chat.selectRegionMerge()||this.chat.gridElmMerge()||this.chat.delMarkRule())&&(e.preventDefault(),this.showPlaceholder()):this.wrapKeyFun(e)?this.chat.setWrap():this.sendKeyFun(e)?(e.preventDefault(),await x(100),this.enterSend()):["ArrowLeft","ArrowRight"].includes(e.code)?(e.preventDefault(),this.chat.switchRange(e.code)):e.ctrlKey&&e.code==="KeyA"?this.isEmpty()&&e.preventDefault():e.ctrlKey&&e.code==="KeyZ"&&e.preventDefault()}),this.richText.addEventListener("input",()=>{this.deviceInfo.isPc&&this.chat.selectRegionMerge(),this.chat.updateGrid(),this.showPlaceholder()}),this.richText.addEventListener("copy",e=>{e.preventDefault();const i=window.getSelection().toString()||"";let s=document.createElement("div");s.innerHTML=i;const o=s.innerText.replace(/\n\n/g,`
`);s=null,e.clipboardData.setData("text/plain",o)}),this.richText.addEventListener("paste",e=>{e.preventDefault();const t=e.clipboardData.getData("text/plain");if(typeof t=="string"&&t!==""){if(this.copyType.indexOf("text")===-1)return;let i=document.createElement("div");i.innerHTML=t,this.chat.selectRegionMerge(),this.insertText(i.innerText),i=null}else{if(this.copyType.indexOf("image")===-1)return;const s=(e.clipboardData||e.originalEvent.clipboardData).items||[];Array.prototype.forEach.call(s,async o=>{if(o.type.indexOf("image")===-1)return;const r=o.getAsFile();if(this.uploadImage){const a=await this.uploadImage(r);this.insertHtml(`<img class="chat-img" src="${a}" alt="" />`)}else{const a=new FileReader;a.onload=n=>{this.insertHtml(`<img class="chat-img" src="${n.target.result}" alt="" />`)},a.readAsDataURL(r)}})}}),this.richText.addEventListener("blur",async e=>{this.chat.upDataNodeOrIndex()}),this.richText.addEventListener("focus",e=>{this.chat.upDataNodeOrIndex()})}updateUserList(e=void 0,t){e&&(this.userList=this.getRuleUserList(e)),t||(this.base64Images={}),this.needDialog&&(this.deviceInfo.isPc?this.updatePCUser():this.updateH5User())}getRuleUserList(e){if(!b(e,"Array"))throw new Error("参数值userList：类型值应为Array！");this.targetUserList=JSON.parse(JSON.stringify(e||[]));const t=Object.create(null);return t[this.userProps.id]="isALL",t[this.userProps.name]="所有人",this.targetUserList.unshift(t),(e==null?void 0:e.map((i,s)=>{const o=i[this.userProps.id];if(!o&&o!==0)throw new Error(`参数值userList：下标第${s}项${this.userProps.id}值异常！`);return i.name=String(i[this.userProps.name]||""),i.pinyin=String(i[this.userProps.pinyin]||""),i.id=String(o),i.avatar=String(i[this.userProps.avatar]||""),i}))||[]}getElmBlock(e){return e&&e.style.display==="block"}domElmShow(e,t=!1){e&&(e.className=e.className.replace(/ chat-view-show| chat-view-hidden/g,""),t?(e.style.display="block",e.className+=" chat-view-show"):e.style.display="none")}getUserHtmlTemplate(e,t){const i=document.createElement("span");if(i.setAttribute("class",`call-user-dialog-item-sculpture ${t.avatar?"is-avatar":""}`),t.avatar){const o=new Image;o.alt="";const r=this.base64Images[t.id];r?o.src=r:(o.src=String(t.avatar),o.setAttribute("crossOrigin","Anonymous"),o.onload=()=>{const a=document.createElement("canvas");a.width=48,a.height=48;const n=a.getContext("2d");n&&(n.drawImage(o,0,0,a.width,a.height),this.base64Images[t.id]=a.toDataURL("image/png",1))}),i.appendChild(o)}else i.innerHTML=`<span style="transform: scale(0.75)">${t.name.slice(-2)}</span>`;e.appendChild(i);const s=document.createElement("span");s.setAttribute("class","call-user-dialog-item-name"),s.innerHTML=t.name,e.appendChild(s)}hasPc(){this.initCheckbox(),this.initCallUser(),window.addEventListener("click",this.winClick),window.addEventListener("keydown",this.winKeydown)}initCheckbox(){this.checkboxElm=document.createElement("div"),this.checkboxElm.setAttribute("class","checkbox-dialog"),this.domElmShow(this.checkboxElm),this.checkboxElm.innerHTML=`
      <div class="checkbox-dialog-container">
        <div class="checkbox-dialog-container-header">
            <span>选择要@的人</span>
            <span class="checkbox-dialog-container-header-close">⛌</span>
        </div>
        <div class="checkbox-dialog-container-body">
            <div class="checkbox-dialog-left-box">
                <div class="checkbox-dialog-search">
                    <input class="checkbox-dialog-search-input" placeholder="搜索人员名称" type="text">

                    <div data-set-remark="搜索下拉" class="checkbox-dialog-search-group"></div>
                </div>

                <div data-set-remark="反显选取的人员" class="checkbox-dialog-tags"></div>

                <div class="checkbox-dialog-option">
                    <button class="checkbox-dialog-option-btn btn-submit">确定</button>
                    <button class="checkbox-dialog-option-btn btn-close">取消</button>
                </div>
            </div>
            
            <div class="checkbox-dialog-right-box">
                <div class="checkbox-dialog-right-box-title">研讨成员列表</div>

                <div data-set-remark="多选人员列表" class="checkbox-dialog-check-group"></div>
            </div>
        </div>
      </div>
    `,document.body.appendChild(this.checkboxElm),this.checkGroupElm=this.checkboxElm.querySelector(".checkbox-dialog-check-group"),this.searchResultElm=this.checkboxElm.querySelector(".checkbox-dialog-search-group"),this.searchElm=this.checkboxElm.querySelector(".checkbox-dialog-search-input"),this.tagsElm=this.checkboxElm.querySelector(".checkbox-dialog-tags");const e=()=>{this.domElmShow(this.checkboxElm)},t=this.checkboxElm.querySelector(".checkbox-dialog-container-header-close"),i=this.checkboxElm.querySelector(".btn-close");t.onclick=e,i.onclick=e;const s=this.checkboxElm.querySelector(".btn-submit");s.onclick=async()=>{let o;for(let r=0;r<=this.checkboxRows.length-1;)r===0?o=await this.chat.onceCall(this.checkboxRows[r],!0):r===this.checkboxRows.length-1?await this.chat.onceCall(this.checkboxRows[r],!1,o):await this.chat.onceCall(this.checkboxRows[r],!0),r++;e()},this.domElmShow(this.searchResultElm),this.searchResultElm.onclick=o=>{o.stopPropagation()},this.searchElm.onclick=o=>{o.stopPropagation()},this.searchElm.oninput=o=>{this.searchResultElm.innerHTML="";const r=String(o.target.value||"").replace(/'/g,"");if(!r){this.domElmShow(this.searchResultElm);return}const a=this.searchUserList(r),n=document.createDocumentFragment();if(a.forEach(c=>{const h=document.createElement("div");h.setAttribute("class","checkbox-dialog-check-item"),h.setAttribute("data-set-value",c.id);const g=document.createElement("div");g.setAttribute("class","checkbox-dialog-check-item-label"),this.getUserHtmlTemplate(g,c),h.appendChild(g),h.onclick=()=>{this.domElmShow(this.searchResultElm);const d=h.getAttribute("data-set-value")||"";if(this.searchElm.value="",this.checkboxRows.some(l=>l.id===d))return;const m=this.userList.find(l=>l.id===d);m&&this.checkboxRows.push(m),Array.prototype.some.call(this.checkGroupElm.children,(l,f)=>{if(f===0&&this.checkboxRows.length===this.userList.length)return l.className+=" checkbox-dialog-check-item-check",!1;if(l.getAttribute("data-set-value")===d)return l.className+=" checkbox-dialog-check-item-check",!0}),this.updateTags()},n.appendChild(h)}),!a.length){const c=document.createElement("div");c.setAttribute("class","checkbox-dialog-search-empty"),c.innerText="没有匹配到任何结果",n.appendChild(c)}this.searchResultElm.appendChild(n),this.domElmShow(this.searchResultElm,!0)}}searchUserList(e,t){return(t||this.userList).filter(i=>C(i.name,i.pinyin||"",e).length>0)}updateTags(){const e=this.checkboxRows.map(r=>r.id),t=[],i=[];Array.prototype.forEach.call(this.tagsElm.children,r=>{const a=r.getAttribute("data-set-value");e.indexOf(a)===-1?i.push(r):t.push(a)}),i.forEach(r=>{this.tagsElm.removeChild(r)});const s=this.checkboxRows.filter(r=>t.indexOf(r.id)===-1);if(!s.length)return;const o=document.createDocumentFragment();s.forEach(r=>{const a=document.createElement("div");a.setAttribute("class","checkbox-dialog-tag-item"),a.setAttribute("data-set-value",r.id),a.innerHTML=`
        <span>${r.name}</span>
      `;const n=document.createElement("span");n.setAttribute("class","checkbox-dialog-tag-item-close"),n.innerHTML="⛌",n.onclick=()=>{const c=a.getAttribute("data-set-value");this.checkboxRows=this.checkboxRows.filter(h=>h.id!==c),this.tagsElm.removeChild(a),Array.prototype.some.call(this.checkGroupElm.children,(h,g)=>{if(g===0)return h.className=h.className.replace(/ checkbox-dialog-check-item-check/g,""),!1;if(h.getAttribute("data-set-value")===c)return h.className=h.className.replace(/ checkbox-dialog-check-item-check/g,""),!0})},a.appendChild(n),o.appendChild(a)}),this.tagsElm.appendChild(o)}initCallUser(){this.dialogElm=document.createElement("div"),this.dialogElm.setAttribute("class","call-user-dialog"),this.domElmShow(this.dialogElm);const e=document.createElement("div");e.setAttribute("class","call-user-dialog-header"),e.innerHTML=`
        <span class="call-user-dialog-header-title">群成员</span>
    `,this.dialogCheckElm=document.createElement("span"),this.dialogCheckElm.setAttribute("class","call-user-dialog-header-check"),this.domElmShow(this.dialogCheckElm,this.userList.length>0),this.dialogCheckElm.innerText="多选",this.dialogCheckElm.onclick=()=>{this.showPCCheckDialog()},e.appendChild(this.dialogCheckElm),this.dialogElm.appendChild(e),this.dialogMainElm=document.createElement("div"),this.dialogMainElm.setAttribute("class","call-user-dialog-main"),this.dialogElm.appendChild(this.dialogMainElm),this.updateUserList();const t=document.createElement("div");t.setAttribute("class","call-user-dialog-footer"),this.dialogElm.appendChild(t),document.body.appendChild(this.dialogElm)}resizeUserTool(){this.toolUserList&&(this.userList=this.toolUserList),this.toolUserList=void 0,this.updateUserList(this.userList,!0)}updatePCUser(){this.dialogMainElm.innerHTML="",this.dialogActiveItemElm=void 0;const e=this.userList&&this.userList.length>0,t=document.createDocumentFragment();if(this.domElmShow(this.dialogCheckElm),!this.toolUserList&&e&&(this.domElmShow(this.dialogCheckElm,!0),this.needCallEvery)){const s=document.createElement("div");s.setAttribute("class","call-user-dialog-item"),s.setAttribute("data-set-id","isALL"),this.userSelectStyleAndEvent(s,{id:"isALL",name:"所有人"}),s.innerHTML=`
          <span class="call-user-dialog-item-sculpture">
            <span style="transform: scale(0.75)">@</span>
          </span>
          <span class="call-user-dialog-item-name">所有人(${this.userList.length})</span>
      `,t.appendChild(s)}this.userList.forEach(s=>{const o=document.createElement("div");o.setAttribute("class","call-user-dialog-item"),o.setAttribute("data-set-id",s.id),this.userSelectStyleAndEvent(o,s),this.getUserHtmlTemplate(o,s),t.appendChild(o)}),this.dialogMainElm.appendChild(t),this.callUserDialogMap(),this.checkGroupElm.innerHTML=`
                    <div class="checkbox-dialog-check-item" data-set-value="ALL">
                        <input type="checkbox" value>
                        <span class="checkbox-dialog-check-item-inner"></span>
                        <div class="checkbox-dialog-check-item-label">全选</div>
                    </div>`;const i=document.createDocumentFragment();this.userList.forEach(s=>{const o=document.createElement("div");o.setAttribute("class","checkbox-dialog-check-item"),o.setAttribute("data-set-value",s.id),o.innerHTML=`
          <input type="checkbox" value>
          <span class="checkbox-dialog-check-item-inner"></span>
      `,this.getUserHtmlTemplate(o,s),i.appendChild(o)}),this.checkGroupElm.appendChild(i),this.checkGroupElm&&this.checkGroupElm.children.length&&Array.prototype.forEach.call(this.checkGroupElm.children,s=>{s.onclick=()=>{const o=s.getAttribute("data-set-value")||"",r=this.userList.find(a=>a.id===o);s.className.indexOf("checkbox-dialog-check-item-check")!==-1?(s.className=s.className.replace(/ checkbox-dialog-check-item-check/g,""),o!=="ALL"&&(this.checkboxRows=this.checkboxRows.filter(a=>a.id!==o))):(s.className+=" checkbox-dialog-check-item-check",o!=="ALL"&&r&&this.checkboxRows.push(r)),o==="ALL"?(Array.prototype.forEach.call(this.checkGroupElm.children,a=>{a.className=s.className}),this.checkboxRows=s.className.indexOf("checkbox-dialog-check-item-check")!==-1?this.userList.map(a=>a):[]):this.checkboxRows.length===this.userList.length?this.checkGroupElm.children[0].className+=" checkbox-dialog-check-item-check":this.checkGroupElm.children[0].className=this.checkGroupElm.children[0].className.replace(/ checkbox-dialog-check-item-check/g,""),this.updateTags()}})}userSelectStyleAndEvent(e,t){e.addEventListener("click",async i=>{i.stopPropagation(),this.upDateActiveItem(e),this.toolUserList&&this.toolUserList.length>0?await this.chat.searchCall(t,this.startOpenIndex):await this.chat.onceCall(t),this.exitDialog()})}callUserDialogMap(){this.itemShowList=[],Array.prototype.forEach.call(this.dialogMainElm.children||[],(e,t)=>{this.itemShowList.push({index:t,elm:e})})}showPCDialog(){this.domElmShow(this.dialogElm,!0);let e="0",t="100%";this.upDateActiveItem(this.dialogMainElm.firstElementChild,!0);const i=this.chat.getRangeRect(),{clientWidth:s,clientHeight:o}=this.dialogElm;i.x>window.innerWidth-s&&(i.x=i.x-s-16,e="100%"),i.y<o&&(i.y=o+i.y,t="0"),this.dialogElm.style.transformOrigin=`${e} ${t}`,this.dialogElm.style.left=i.x+6+"px",this.dialogElm.style.bottom=`calc(100% - ${i.y}px)`,this.dialogElm.style.opacity="1"}showPCCheckDialog(){this.winClick(),this.checkboxRows=[],this.domElmShow(this.checkboxElm,!0),this.searchElm.value="",Array.prototype.forEach.call(this.checkGroupElm.children,e=>{e.className="checkbox-dialog-check-item"}),this.updateTags()}moveActiveItem(e){if(!this.dialogActiveItemElm||this.itemShowList.length===0)return;let t=0;const i=this.dialogActiveItemElm.getAttribute("data-set-id");this.itemShowList.some(o=>{const r=o.elm.getAttribute("data-set-id");return t=o.index,i===r});const s=this.itemShowList.map(o=>o.index);if(e==="down"&&t!==this.itemShowList[this.itemShowList.length-1].index){const o=this.itemShowList[s.indexOf(t)+1];o&&this.upDateActiveItem(o.elm,!0)}else if(e==="up"&&t!==this.itemShowList[0].index){const o=this.itemShowList[s.indexOf(t)-1];o&&this.upDateActiveItem(o.elm,!0)}}upDateActiveItem(e,t=!1){this.dialogActiveItemElm&&(this.dialogActiveItemElm.className=this.dialogActiveItemElm.className.replace(/ call-user-dialog-item-active/g,"")),this.dialogActiveItemElm=e,e&&(e.className+=" call-user-dialog-item-active",t&&e.scrollIntoView({block:"center"}))}exitDialog(){this.toolUserList&&this.resizeUserTool(),this.upDateActiveItem(),this.domElmShow(this.dialogElm)}hasH5(){this.dialogH5Elm=document.createElement("div"),this.dialogH5Elm.setAttribute("class","call-user-popup"),this.dialogH5Elm.innerHTML=`
      <div class="call-user-popup-main">
        <div class="call-user-popup-header">
            <span class="popup-show">收起</span>
            <span class="popup-title">选择提醒的人</span>
            <span class="popup-check">确定</span>
        </div>
        
        <div class="call-user-popup-search">
            <svg class="icon"
                 style="width: auto;height: 44px;vertical-align: middle;fill: currentColor;overflow: hidden;"
                 viewBox="0 0 1024 1024" version="1.1"
                 xmlns="http://www.w3.org/2000/svg"
                 p-id="4209">
                <path d="M684.8 223.530667a326.272 326.272 0 0 1 24.96 433.621333c2.645333 2.133333 5.290667 4.48 7.850667 7.04L870.4 817.066667c24.789333 24.746667 32.896 56.832 18.133333 71.594666-14.762667 14.805333-46.848 6.656-71.637333-18.090666l-152.789333-152.832a106.282667 106.282667 0 0 1-7.210667-7.936 326.101333 326.101333 0 0 1-433.109333-25.173334c-127.445333-127.445333-127.573333-333.952-0.256-461.269333 127.36-127.36 333.866667-127.232 461.269333 0.213333zM275.328 275.114667a252.885333 252.885333 0 0 0 0.256 357.632 252.885333 252.885333 0 0 0 357.632 0.256 252.885333 252.885333 0 0 0-0.256-357.632 252.885333 252.885333 0 0 0-357.632-0.256z"
                      fill="#9B9B9B"
                      p-id="4210"></path>
            </svg>
            <input class="call-user-popup-search-input"
                   placeholder="搜索人员名称"
                   type="text">
        </div>
        
        <div class="call-user-popup-body">
        </div>
      </div>
    `;const e=async()=>{this.dialogH5Elm.className=this.dialogH5Elm.className.replace(/ chat-view-show/g," chat-view-hidden"),this.dialogH5SearchElm.value="",await x(260),this.domElmShow(this.dialogH5Elm),this.chat.restCursorPos(this.chat.vnode,this.chat.cursorIndex)};this.dialogH5Elm.onclick=e,this.dialogH5Elm.querySelector(".call-user-popup-main").onclick=t=>{t.stopPropagation()},this.dialogH5ShowElm=this.dialogH5Elm.querySelector(".popup-show"),this.dialogH5ShowElm.onclick=e,this.dialogH5CheckElm=this.dialogH5Elm.querySelector(".popup-check"),this.dialogH5CheckElm.onclick=async()=>{const t=this.dialogH5Elm.querySelectorAll(".user-popup-check-item-check")||[];if(t.length===0){await e();return}if(Array.prototype.some.call(t,r=>r.getAttribute("data-set-id")==="isALL")){await this.chat.onceCall({id:"isALL",name:"所有人"}),await e();return}const i=Array.prototype.map.call(t,r=>r.getAttribute("data-set-id")),s=this.userList.filter(r=>i.includes(r.id));let o;for(let r=0;r<=s.length-1;)r===0?o=await this.chat.onceCall(s[r],!0):r===s.length-1?await this.chat.onceCall(s[r],!1,o):await this.chat.onceCall(s[r],!0),r++;await e()},this.dialogH5MainElm=this.dialogH5Elm.querySelector(".call-user-popup-body"),this.updateUserList(),this.dialogH5SearchElm=this.dialogH5Elm.querySelector(".call-user-popup-search-input"),this.dialogH5SearchElm.oninput=t=>{const i=String(t.target.value||"").replace(/'/g,"");Array.prototype.forEach.call(this.dialogH5MainElm.children,s=>{if(!i){s.style.display="";return}const o=s.getAttribute("data-set-name")||"",r=s.getAttribute("data-set-pinyin")||"";s.style.display=C(o,r,i).length>0?"":"none"})},this.domElmShow(this.dialogH5Elm),document.body.appendChild(this.dialogH5Elm)}updateH5User(){this.dialogH5MainElm.innerHTML="",this.domElmShow(this.dialogH5CheckElm,this.userList.length>0);const e=this.userList&&this.userList.length>0,t=document.createDocumentFragment(),i=document.createElement("span");if(i.innerHTML=`
        <input type="checkbox" value>
        <span class="user-popup-check-item-inner"></span>
    `,e){const s=document.createElement("div");this.needCallEvery&&(s.setAttribute("class","call-user-popup-item"),s.setAttribute("data-set-id","isALL"),s.innerHTML=`
          <span class="call-user-dialog-item-sculpture">
            <span style="transform: scale(0.75)">@</span>
          </span>
          <span class="call-user-dialog-item-name">所有人(${this.userList.length})</span>
      `,s.appendChild(i.cloneNode(!0)),s.onclick=()=>{const o=s.className.indexOf("user-popup-check-item-check")===-1;Array.prototype.forEach.call(this.dialogH5MainElm.children,r=>{o?r.className+=" user-popup-check-item-check":r.className=r.className.replace(/ user-popup-check-item-check/g,"")})},t.appendChild(s)),this.userList.forEach((o,r)=>{const a=document.createElement("div");a.setAttribute("class","call-user-popup-item"),a.setAttribute("data-set-id",o.id),a.setAttribute("data-set-name",o.name),a.setAttribute("data-set-pinyin",o.pinyin||""),this.getUserHtmlTemplate(a,o),a.appendChild(i.cloneNode(!0)),t.appendChild(a),a.onclick=n=>{a.className.indexOf("user-popup-check-item-check")===-1?(a.className+=" user-popup-check-item-check",s.className+=Array.prototype.every.call(this.dialogH5MainElm.children,h=>h.className.indexOf("user-popup-check-item-check")!==-1||h.getAttribute("data-set-id")==="isALL")?" user-popup-check-item-check":""):(a.className=a.className.replace(/ user-popup-check-item-check/g,""),s.className=s.className.replace(/ user-popup-check-item-check/g,""))}})}this.dialogH5MainElm.appendChild(t)}showH5Dialog(){this.richText&&this.richText.blur(),Array.prototype.forEach.call(this.dialogH5MainElm.children,e=>{e.style.display="",e.className=e.className.replace(/ user-popup-check-item-check/g,"")}),this.domElmShow(this.dialogH5Elm,!0)}updateConfig({copyType:e,userProps:t,userList:i,uploadImage:s,needCallEvery:o,placeholder:r,needCallSpace:a,wrapKeyFun:n,sendKeyFun:c}={}){if(e){if(!b(e,"Array"))throw new Error("参数值copyType：类型值应为Array！");this.copyType=e.map(h=>{if(["text","image"].indexOf(h)===-1)throw new Error(`参数值copyType：无效的参数值"${h}"！`);return h})}if(t){if(!b(t,"Object"))throw new Error("参数值copyType：类型值应为Object！");this.userProps=Object.assign({},{id:"id",name:"name",avatar:"avatar",pinyin:"pinyin"},t)}if(s){if(typeof s!="function")throw new Error("参数值uploadImage：参数类型错误，参数类型应为Function！");this.uploadImage=s}if(r&&(this.placeholderElm.innerText=r),(o!==void 0||i)&&(this.needCallEvery=String(o)!=="false",this.updateUserList(i)),a!==void 0&&this.chat.setCallSpace(a),n){if(typeof n!="function")throw new Error("参数值wrapKeyFun：参数类型错误，参数类型应为Function！");this.wrapKeyFun=n}if(c){if(typeof c!="function")throw new Error("参数值sendKeyFun：参数类型错误，参数类型应为Function！");this.sendKeyFun=c}}enterSend(){}insertHtml(e){const t=document.createElement("span");t.innerHTML=e,t.className="chat-set-html";const i=this.chat.createNewDom(t);this.chat.replaceRegContent(i),this.showPlaceholder()}insertText(e){var c,h;if(!e)return;const t=e.replace(/[\u200b\ufeff]/ig,"");if(!t)return;let i,s=0;const o=this.chat.vnode;o&&o.parentElement&&o.parentElement.getAttribute("data-set-richType")==="richInput"?(i=o.parentElement,s=o.textContent==="\uFEFF"?1:this.chat.cursorIndex):(i=(h=(c=this.richText)==null?void 0:c.lastChild)==null?void 0:h.lastChild,s=i.childNodes[0].textContent.length);const r=g=>{const d=i.childNodes[0],m=d.textContent.split("");return m.splice(s,0,g),d.textContent=m.join("").replace(/\ufeff/i,()=>(s--,"")),i.setAttribute("data-set-empty","false"),i.childNodes[1]&&i.removeChild(i.childNodes[1]),this.chat.restCursorPos(d,s+g.length),i.parentElement.parentElement},a=(g,d=!1,m)=>{const l=this.chat.getGridElm(),f=l.childNodes[0].childNodes[0];let E=1;return g&&(f.innerHTML=g,f.setAttribute("data-set-empty","false"),E=g.length),m.nextSibling?this.richText.insertBefore(l,m.nextSibling):this.richText.appendChild(l),d&&(this.chat.restCursorPos(f.childNodes[0],E),l.scrollIntoView({block:"nearest"})),l},n=t.split(`
`);if(n.length>1){let g;n.forEach((d,m)=>{m===0?g=r(d):g=a(d,m===n.length-1,g)})}else r(t);this.showPlaceholder()}getCallUserList(){const e=this.richText.querySelectorAll(".at-user");if(e&&e.length>0){const t=Array.prototype.map.call(e,i=>i.dataset.userId);return L(this.targetUserList,t,this.userProps.id)}else return[]}clear(e){this.chat.textInnerHtmlInit(!0,e),this.richText.focus(),this.showPlaceholder()}isEmpty(){const e=new RegExp("^[​\uFEFF<br>]+$"),t=this.richText.querySelectorAll(".chat-stat")||[];return Array.prototype.every.call(t,i=>!i.innerHTML||e.test(i.innerHTML))}showPlaceholder(){this.domElmShow(this.placeholderElm,this.isEmpty())}getReduceNode(){const t=this.richText.cloneNode(!0).querySelectorAll(".chat-grid-wrap")||[],i=document.createElement("div");return Array.prototype.forEach.call(t,(s,o)=>{const r=s.querySelectorAll(".chat-stat")||[],a=document.createElement("p");Array.prototype.forEach.call(r,n=>{this.chat.getNodeEmpty(n)||(n.removeAttribute("data-user-id"),n.removeAttribute("contenteditable"),n.removeAttribute("data-set-richType"),n.removeAttribute("data-set-empty"),a.appendChild(n))}),a.innerHTML||(a.innerHTML="<br>"),i.appendChild(a)}),i}getText(){return this.getReduceNode().innerText}getHtml(){return this.getReduceNode().innerHTML}dispose(){const e=this.richText.parentElement;e&&(e.removeChild(this.richText),e.removeChild(this.placeholderElm)),this.needDialog&&(this.deviceInfo.isPc?(document.body.removeChild(this.dialogElm),document.body.removeChild(this.checkboxElm),window.removeEventListener("click",this.winClick),window.removeEventListener("keydown",this.winKeydown)):document.body.removeChild(this.dialogH5Elm));for(const t in this)delete this[t];Object.setPrototypeOf(this,Object)}setUserTag(e){const t=this.chat.createAtUserSpan({id:e[this.userProps.id],name:e[this.userProps.name]});this.chat.replaceRegContent(t,!1),this.showPlaceholder()}async onceSetTag(e){await this.chat.onceCall({id:e[this.userProps.id],name:e[this.userProps.name]})}async batchSetTag(e){let t;for(let i=0;i<=e.length-1;){const s={id:e[i][this.userProps.id],name:e[i][this.userProps.name]};i===0?t=await this.chat.onceCall(s,!0):i===this.checkboxRows.length-1?await this.chat.onceCall(s,!1,t):await this.chat.onceCall(s,!0),i++}}}if(!window)throw new Error("非web环境！");window.console&&window.console.log&&console.log(" %c ".concat("ChatArea"," %c v3.8.0 "),"background: #269AFF; color: #FFFFFF; padding: 4px 0; border-radius: 4px 0px 0px 4px; font-style: italic;","background: #FFFFFF; color: #269AFF; padding: 2px 0; border-radius: 0px 4px 4px 0px; font-style: italic; border: 2px solid #269AFF;");window.ChatArea=F;
