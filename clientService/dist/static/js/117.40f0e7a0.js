"use strict";(self["webpackChunkgim_chat"]=self["webpackChunkgim_chat"]||[]).push([[117],{11117:function(e,t,s){s.r(t),s.d(t,{default:function(){return g}});var n=function(){var e=this,t=e._self._c;return t("div",{staticClass:"chat-container"},[t("div",{staticClass:"socket-status",class:e.socketStatus},["connecting"===e.socketStatus?t("span",[e._v("ðŸŸ  è¿žæŽ¥ä¸­...")]):"open"===e.socketStatus?t("span",[e._v("ðŸŸ¢ å·²è¿žæŽ¥")]):"closed"===e.socketStatus?t("span",[e._v(" ðŸ”´ å·²æ–­å¼€ "),t("button",{staticClass:"reconnect-btn",on:{click:e.manualReconnect}},[e._v("é‡è¿ž")])]):"error"===e.socketStatus?t("span",[e._v(" âš ï¸ è¿žæŽ¥å‡ºé”™ "),t("button",{staticClass:"reconnect-btn",on:{click:e.manualReconnect}},[e._v("é‡è¿ž")])]):e._e()]),t("div",{ref:"chatList",staticClass:"msg-list"},[e._l(e.chatMessages,function(n){return t("div",{key:n.id,class:["msg","user"===n.role?"msg-user":"msg-ai"]},["ai"===n.role?t("div",{staticClass:"avatar"},[t("img",{staticClass:"avatar-img",attrs:{src:s(36561),alt:"AI Avatar"}})]):e._e(),t("div",{staticClass:"msg-content",domProps:{innerHTML:e._s(n.renderedContent)}}),"user"===n.role?t("div",{staticClass:"avatar"},[e._v("ðŸ§‘")]):e._e()])}),e.loading?t("div",{staticClass:"ai-loading"},[t("span",{staticStyle:{"margin-right":"10px"}},[e._v("AI æ­£åœ¨è¾“å…¥")]),t("div",{staticClass:"dot-flash"},e._l(3,function(e){return t("div",{key:e,staticClass:"dot",style:{animationDelay:.2*e+"s"}})}),0)]):e._e()],2),t("div",{staticClass:"input-bar1",class:{"input-bottom":e.chatMessages.length>0}},[e.selectedFiles.length>0?t("div",{staticClass:"file-list"},e._l(e.selectedFiles,function(s,n){return t("div",{key:s.name+n,staticClass:"file-item"},[t("span",[e._v(e._s(s.name))]),t("button",{staticClass:"remove-file",on:{click:function(t){return e.removeFile(n)}}},[e._v("âŒ")])])}),0):e._e(),t("div",{staticClass:"input-bar"},[t("input",{ref:"fileInput",staticStyle:{display:"none"},attrs:{type:"file",accept:".txt,.pdf,.doc,.mp4,.docx,image/*",multiple:""},on:{change:e.handleFileSelect}}),t("button",{staticClass:"attach-btn",on:{click:function(t){return e.$refs.fileInput.click()}}},[e._v("ðŸ“Ž")]),t("div",{staticClass:"input-wrapper"},[t("textarea",{directives:[{name:"model",rawName:"v-model",value:e.userInput,expression:"userInput"}],ref:"inputBox",staticClass:"input-box",attrs:{placeholder:"è¯·è¾“å…¥é—®é¢˜...",rows:"1"},domProps:{value:e.userInput},on:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleSend.apply(null,arguments)},paste:e.handlePaste,input:function(t){t.target.composing||(e.userInput=t.target.value)}}})]),t("el-select",{staticStyle:{"margin-top":"10px"},attrs:{placeholder:"æ¨¡åž‹é€‰æ‹©"},model:{value:e.selectedModel,callback:function(t){e.selectedModel=t},expression:"selectedModel"}},e._l(e.selectedModelOptions,function(e){return t("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})}),1),t("el-select",{staticStyle:{"margin-top":"10px"},attrs:{placeholder:"çŸ¥è¯†åº“é€‰æ‹©"},model:{value:e.selectedKB,callback:function(t){e.selectedKB=t},expression:"selectedKB"}},e._l(e.selectedKBOptions,function(e){return t("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})}),1)],1)])])},i=[],o=(s(44114),s(18111),s(20116),s(7588),s(61701),s(60023)),l=s(47504),a=s(85471),c=s(19878),r=s(25192);s(79351);o.xI.setOptions({breaks:!0,gfm:!0,highlight(e,t){return t&&c.A.getLanguage(t)?c.A.highlight(e,{language:t}).value:c.A.highlightAuto(e).value}});var u={data(){return{selectedModel:"gpt-4.1",selectedModelOptions:[{label:"ðŸš€ GPT-4.1ï¼ˆæŽ¨èæ–‡æœ¬æ¨¡åž‹ï¼‰",value:"gpt-4.1"},{label:"ðŸŒŒ GPT-4.1-2025-04-14ï¼ˆæœ€æ–°ç‰ˆï¼‰",value:"gpt-4.1-2025-04-14"},{label:"ðŸ”® GPT-4oï¼ˆå¤šæ¨¡æ€æ——èˆ°ï¼‰",value:"gpt-4o"},{label:"ðŸ§  O3ï¼ˆæŽ¨ç†ä¼˜åŒ–ç‰ˆï¼‰",value:"o3"},{label:"ðŸ“˜ GPT-4ï¼ˆæ—§ç‰ˆï¼‰",value:"gpt-4"},{label:"ðŸ’¸ GPT-3.5 Turboï¼ˆä½Žæˆæœ¬ï¼‰",value:"gpt-3.5-turbo"}],selectedKB:"",selectedKBOptions:[{label:"ðŸ“š æœªä½¿ç”¨çŸ¥è¯†åº“",value:"ðŸ“š æœªä½¿ç”¨çŸ¥è¯†åº“"},{label:"ðŸ“˜ äº§å“æ–‡æ¡£åº“",value:"ðŸ“˜ äº§å“æ–‡æ¡£åº“"},{label:"ðŸ“’ FAQ çŸ¥è¯†åº“",value:"ðŸ“’ FAQ çŸ¥è¯†åº“"},{label:"ðŸ“™ å†…éƒ¨èµ„æ–™åº“",value:"ðŸ“™ å†…éƒ¨èµ„æ–™åº“"}],socketStatus:"connecting",socket:null,reconnectAttempts:0,maxReconnectAttempts:20,reconnectDelay:2e3,reconnectTimer:null,selectedFiles:[],selectedFile:null,chatMessages:[{id:Date.now(),role:"ai",content:"å˜¿ï¼æˆ‘æ˜¯ **AI å°åŠ©æ‰‹**ï¼Œæœ‰ä»»ä½•é—®é¢˜éƒ½å¯ä»¥é—®æˆ‘å“¦ï½ž",renderedContent:""}],userInput:"",loading:!1,currentAiMessageId:null,typingQueue:[],typingTimer:null,isTyping:!1}},mounted(){this.getFileListByPath(),this.chatMessages.forEach(e=>{e.renderedContent=o.xI.parse(e.content)}),this.initSocket(),this.adjustInputHeight()},watch:{userInput(){this.adjustInputHeight()}},beforeDestroy(){this.typingTimer&&clearTimeout(this.typingTimer),this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.socket&&this.socket.close()},methods:{getFileListByPath(){(0,r.tP)().then(e=>{e&&e.data&&e.data.data&&e.data.data.records&&(this.selectedKBOptions=e.data.data.records.map(e=>({label:e.name,value:e.knowledgeCode})))})},adjustInputHeight(){(0,a.dY)(()=>{const e=this.$refs.inputBox;if(!e)return;e.style.height="auto";const t=parseInt(getComputedStyle(e).lineHeight)||24,s=3,n=t*s+20;e.style.height=Math.min(e.scrollHeight,n)+"px"})},handlePaste(e){const t=e.clipboardData;if(!t)return;const s=[];for(let n of t.items)if("file"===n.kind){const e=n.getAsFile();e&&s.push(e)}s.length>0&&(this.selectedFiles.push(...s),console.log("ç²˜è´´æ·»åŠ æ–‡ä»¶ï¼š"),console.log(this.selectedFiles),e.preventDefault())},manualReconnect(){console.log("[WebSocket] ç”¨æˆ·æ‰‹åŠ¨è§¦å‘é‡è¿ž"),this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.reconnectAttempts=0,this.initSocket()},handleFileSelect(e){const t=Array.from(e.target.files);t.length&&(this.selectedFiles.push(...t),console.log("å·²é€‰æ‹©æ–‡ä»¶ï¼š"),console.log(this.selectedFiles),e.target.value=null)},removeFile(e){this.selectedFiles.splice(e,1)},generateId(){return Date.now()+Math.random()},initSocket(){this.socket&&(this.socket.close(),this.socket=null),this.socket=new WebSocket("ws://127.0.0.1:9876/chat-ws"),this.socketStatus="connecting",this.socket.addEventListener("open",()=>{console.log("WebSocket å·²è¿žæŽ¥"),this.socketStatus="open",this.reconnectAttempts=0,this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null)}),this.socket.addEventListener("message",e=>{if("[DONE]"===e.data)return this.loading=!1,void(this.currentAiMessageId=null);this.queueTextForTyping(e.data)}),this.socket.addEventListener("close",()=>{console.log("WebSocket å·²å…³é—­"),this.socketStatus="closed",this.tryReconnect()}),this.socket.addEventListener("error",e=>{console.error("WebSocket é”™è¯¯:",e),this.socketStatus="error",this.tryReconnect()})},tryReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts)return void console.warn("[WebSocket] å·²è¾¾åˆ°æœ€å¤§é‡è¿žæ¬¡æ•°ï¼Œä¸å†é‡è¯•");if(this.reconnectTimer)return;const e=this.reconnectDelay*(this.reconnectAttempts+1);console.log(`[WebSocket] ${e}ms åŽå°è¯•ç¬¬ ${this.reconnectAttempts+1} æ¬¡é‡è¿ž`),this.reconnectTimer=setTimeout(()=>{console.log("[WebSocket] å¼€å§‹é‡è¿ž..."),this.reconnectAttempts++,this.initSocket()},e)},async handleSend(){const e=this.userInput.trim();if(!e&&0===this.selectedFiles.length)return;if(!this.socket||this.socket.readyState!==WebSocket.OPEN)return void console.warn("[Chat] ðŸš« WebSocket æœªè¿žæŽ¥ï¼Œæ¶ˆæ¯å‘é€å¤±è´¥");let t=e;if(this.selectedFiles.length){const e=this.selectedFiles.map(e=>e.name).join(", ");t+=`\n\nðŸ“Ž é™„ä»¶: ${e}`}this.chatMessages.push({id:this.generateId(),role:"user",content:t,renderedContent:o.xI.parse(t)}),this.userInput="",this.loading=!0,this.scrollToBottom();const s=this.chatMessages.map(e=>("user"===e.role?"ç”¨æˆ·ï¼š":"AIï¼š")+e.content).join("\n");try{if(this.selectedFiles.length){console.log("[Chat] ðŸ“Ž æ­£åœ¨ä¸Šä¼ é™„ä»¶:");const t=[];for(let e=0;e<this.selectedFiles.length;e++){const s=await this.uploadFile(this.selectedFiles[e]);console.log("[Chat] ðŸ“Ž ä¸Šä¼ é™„ä»¶æˆåŠŸ:",s);for(let e=0;e<s.length;e++)t.push(s[e])}this.safeSend({type:"file",name:"é™„ä»¶",modelName:this.selectedModel,data:t,knowledgeCode:this.selectedKB,text:e||"",context:s}),this.selectedFiles=[]}else console.log("[Chat] ðŸ’¬ å‘é€æ–‡æœ¬:",e),this.safeSend({type:"text",modelName:this.selectedModel,knowledgeCode:this.selectedKB,text:e,context:s})}catch(n){console.error("[Chat] âŒ æ¶ˆæ¯å‘é€å¤±è´¥:",n)}},safeSend(e){this.socket&&this.socket.readyState===WebSocket.OPEN?this.socket.send("string"===typeof e?e:JSON.stringify(e)):console.warn("[Chat] ðŸš« WebSocket æœªè¿žæŽ¥ï¼Œæ¶ˆæ¯æœªå‘é€")},fileToBase64(e){return new Promise((t,s)=>{const n=new FileReader;n.readAsDataURL(e),n.onload=()=>t(n.result),n.onerror=s})},queueTextForTyping(e){const t=Array.from(e);this.typingQueue.push(...t),this.isTyping||this.startTyping()},startTyping(){this.isTyping=!0;let e=this.chatMessages.find(e=>e.id===this.currentAiMessageId);e||(e={id:this.generateId(),role:"ai",content:"",renderedContent:""},this.chatMessages.push(e),this.currentAiMessageId=e.id);const t=()=>{if(0===this.typingQueue.length)return void(this.isTyping=!1);const s=this.typingQueue.shift();e.content+=s,e.renderedContent=o.xI.parse(e.content),this.$forceUpdate(),this.scrollToBottom(),this.$nextTick(()=>{c.A.highlightAll()}),this.typingTimer=setTimeout(t,20)};t()},scrollToBottom(){this.$nextTick(()=>{const e=this.$refs.chatList;e&&(e.scrollTop=e.scrollHeight)})},async uploadFile(e){const t=new FormData;t.append("file",e);const s=await(0,l.QM)(t);return s.data.data||[]}}},d=u,h=s(81656),p=(0,h.A)(d,n,i,!1,null,"1e6b2be0",null),g=p.exports},20116:function(e,t,s){var n=s(46518),i=s(69565),o=s(72652),l=s(79306),a=s(28551),c=s(1767),r=s(9539),u=s(84549),d=u("find",TypeError);n({target:"Iterator",proto:!0,real:!0,forced:d},{find:function(e){a(this);try{l(e)}catch(n){r(this,"throw",n)}if(d)return i(d,this,e);var t=c(this),s=0;return o(t,function(t,n){if(e(t,s++))return n(t)},{IS_RECORD:!0,INTERRUPTED:!0}).result}})},25192:function(e,t,s){s.d(t,{Uc:function(){return a},bK:function(){return l},g1:function(){return o},qu:function(){return r},tP:function(){return i},xW:function(){return c}});var n=s(35720);const i=e=>(0,n.A)({method:"get",url:"/api/knowledge/queryKnowledgeList",params:e}),o=e=>(0,n.A)({method:"get",url:"/api/knowledge/queryKnowledgeFileList",params:e}),l=e=>(0,n.A)({method:"post",url:"/api/knowledge/create",data:e}),a=e=>(0,n.A)({method:"get",url:"/api/knowledge/delete",params:e}),c=e=>(0,n.A)({method:"post",url:"/api/knowledge/edit",data:e}),r=e=>(0,n.A)({method:"get",url:"/api/knowledge/deleteFile",params:e})}}]);